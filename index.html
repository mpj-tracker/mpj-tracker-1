<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPJ Tracker</title>
  <meta name="theme-color" content="#0b5f3b"/>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --brand:#0b5f3b; --text:#111827; --muted:#6b7280; --card:#fff; --chip:#e7f3eb;
      --joinery:#198754; --electrical:#8c3545; --plumbing:#0d6efd; --plasterer:#6f42c1; --decorators:#d79414; --tiling:#85ae3e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f8;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff}
    .bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem}
    .brand{display:flex;align-items:center;gap:.5rem}
    .brand img{height:24px;cursor:pointer}
    .pill{background:#ffffff22;color:#fff;border:1px solid #ffffff55;border-radius:999px;padding:.2rem .6rem;font-size:.85rem}
    main{max-width:1200px;margin:1rem auto;padding:0 1rem 2rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .muted{color:var(--muted)}
    .btn{background:#fff;border:1px solid #d1d5db;border-radius:.5rem;padding:.45rem .7rem;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.danger{background:#fff;color:#b91c1c;border-color:#b91c1c}
    .btn.ghost{background:transparent;border-color:#9ca3af}
    .chip{display:inline-block;border-radius:999px;padding:.15rem .55rem;font-size:.8rem;background:var(--chip)}
    .barline{height:10px;border-radius:999px;background:#e5e7eb;position:relative;overflow:hidden}
    .barline > i{position:absolute;left:0;top:0;bottom:0;background:var(--brand)}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem}
    .thumb{background:#fafafa;border:1px solid #e5e7eb;border-radius:.5rem;padding:.4rem;display:flex;flex-direction:column;gap:.3rem}
    .thumb img{width:100%;height:110px;object-fit:cover;border-radius:.35rem;background:#ddd}
    details.card > summary{cursor:pointer;list-style:none}
    details.card > summary::-webkit-details-marker{display:none}
    .trade{border-left:4px solid #e5e7eb;padding-left:.75rem;margin:.75rem 0}
    .trade.Joinery{border-color:var(--joinery)}
    .trade.Electrical{border-color:var(--electrical)}
    .trade.Plumbing{border-color:var(--plumbing)}
    .trade.Plasterer{border-color:var(--plasterer)}
    .trade.Decorators{border-color:var(--decorators)}
    .trade.Tiling{border-color:var(--tiling)}
    textarea.notes{width:100%;min-height:70px;resize:vertical}
    #diag-wrap{position:fixed;right:10px;bottom:10px;max-width:440px;z-index:20}
    #diag{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
    #rooms .card{overflow:hidden}
    .small{font-size:.9rem}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <img src="mpj-logo.png" alt="logo" id="home-logo"/>
      <strong>MPJ Tracker</strong>
    </div>
    <div id="auth-state" class="pill">Signed out</div>
  </div>
</header>

<main>
  <!-- Auth -->
  <div id="auth-box" class="card">
    <h2>Login / Sign Up</h2>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" style="min-width:260px;padding:.6rem;border:1px solid #d1d5db;border-radius:.5rem"/>
      <input id="password" type="password" placeholder="password" style="min-width:160px;padding:.6rem;border:1px solid #d1d5db;border-radius:.5rem"/>
      <button id="signup-btn" class="btn">Sign Up</button>
      <button id="login-btn" class="btn primary">Log In</button>
      <button id="logout-btn" class="btn ghost">Sign out</button>
    </div>
    <div class="small muted">Use your email + password. New users can sign up here too.</div>
  </div>

  <!-- Project controls -->
  <div id="project-box" class="card hidden">
    <h2>Project</h2>
    <div class="row">
      <select id="project-select" style="min-width:220px;padding:.5rem;border:1px solid #d1d5db;border-radius:.5rem"></select>
      <label class="row small muted" style="gap:.35rem">
        <input type="checkbox" id="show-archived-projects"/> Show archived
      </label>
      <button id="use-project" class="btn primary">Use Selected</button>
      <button id="toggle-archive-btn" class="btn">Archive / Unarchive</button>
      <button id="delete-project" class="btn danger">Delete Project</button>
    </div>
    <div class="row" style="margin-top:.6rem">
      <input id="project-name" placeholder="New project name" style="min-width:220px;padding:.6rem;border:1px solid #d1d5db;border-radius:.5rem"/>
      <input id="project-address" placeholder="Site address (optional)" style="min-width:220px;padding:.6rem;border:1px solid #d1d5db;border-radius:.5rem"/>
      <button id="create-project" class="btn">Create New Project</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="card hidden">
    <h2>Project Dashboard</h2>
    <input id="search" placeholder="Filter by room or floor…" style="width:100%;padding:.7rem;border:1px solid #d1d5db;border-radius:.5rem;margin:.25rem 0 1rem"/>

    <div class="card" style="margin:.5rem 0">
      <strong>Overall Progress</strong>
      <div class="row" style="gap:1rem;margin-top:.4rem">
        <div id="overall-bar" class="barline" style="flex:1"><i style="width:0%"></i></div>
        <div id="overall-pct" class="muted">0%</div>
      </div>
    </div>

    <details id="signoffs-block" class="card">
      <summary><strong>All Sign-offs</strong></summary>
      <div id="all-signoffs" class="small muted">None yet</div>
    </details>

    <details id="photos-block" class="card" open>
      <summary class="row" style="justify-content:space-between">
        <strong>All Photos</strong>
        <label class="row small muted" style="gap:.5rem">
          <input type="checkbox" id="show-archived-photos"/> Show archived
        </label>
      </summary>
      <div class="row" style="gap:.5rem;margin:.5rem 0">
        <input id="photo-file" type="file" accept="image/*" capture="environment"/>
        <button id="upload-photo" class="btn">Upload</button>
        <button id="clear-archived" class="btn danger">Clear Archived Photos</button>
      </div>
      <div id="all-photos" class="thumbs"></div>
    </details>

    <div id="rooms" class="grid"></div>
  </div>

  <!-- Diagnostics -->
  <div id="diag-wrap">
    <details id="diag-details" class="card">
      <summary><strong>Diagnostics</strong> (click to open/close)</summary>
      <div class="row" style="gap:.5rem;margin:.35rem 0 .6rem">
        <button id="direct-fetch-btn" class="btn">Direct fetch test</button>
        <button id="purge-sw" class="btn">Force clear SW + caches</button>
        <button id="rerun-diag" class="btn">Re-run tests</button>
      </div>
      <div class="small muted" id="diag">Ready.</div>
    </details>
  </div>
</main>

<script>
(async function(){
  /* ---------- Diagnostics FIRST ---------- */
  const diagEl = document.getElementById('diag');
  const diagLog = (m)=>{ if(diagEl){ diagEl.textContent = String(m); console.log('[diag]',m);} };

  document.getElementById('direct-fetch-btn').addEventListener('click', async ()=>{
    try{
      const r = await fetch(SUPABASE_URL + '/auth/v1/health');
      alert('Direct fetch OK: ' + r.status);
    }catch(e){
      alert('Direct fetch failed: ' + e);
    }
  });

  /* ---------- SW purge (auto + button) ---------- */
  async function purgeServiceWorkers(){
    try{
      if('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
        if (window.caches?.keys){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
      }
      console.log('[sw] Unregistered and caches cleared');
      diagLog('SW: none');
    }catch(e){ console.warn('[sw] purge failed', e); diagLog('SW purge failed: '+e); }
  }
  await purgeServiceWorkers();
  document.getElementById('purge-sw').addEventListener('click', purgeServiceWorkers);

  /* ---------- 1) Supabase client (YOUR live values) ---------- */
  const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co"; 
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4"; 
  const OWNER_UUID = "5728601a-4cfa-4a1a-bd0c-f6caea3ae3e8"; // MPJ owner

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  console.log('Supabase client ready');

  /* ---------- 2) DOM refs ---------- */
  const authBox = document.getElementById('auth-box');
  const projectBox = document.getElementById('project-box');
  const dash = document.getElementById('dash');
  const roomsEl = document.getElementById('rooms');
  const authStateEl = document.getElementById('auth-state');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const projectSelect = document.getElementById('project-select');
  const showArchivedProjects = document.getElementById('show-archived-projects');
  const useProjectBtn = document.getElementById('use-project');
  const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
  const deleteProjectBtn = document.getElementById('delete-project');
  const createProjectBtn = document.getElementById('create-project');
  const projectNameInput = document.getElementById('project-name');
  const projectAddressInput = document.getElementById('project-address');

  const searchInput = document.getElementById('search');
  const allSignoffsEl = document.getElementById('all-signoffs');
  const allPhotosEl = document.getElementById('all-photos');
  const showArchivedPhotos = document.getElementById('show-archived-photos');
  const overallBar = document.getElementById('overall-bar').firstElementChild;
  const overallPct = document.getElementById('overall-pct');

  const photoFile = document.getElementById('photo-file');
  const uploadPhotoBtn = document.getElementById('upload-photo');
  const clearArchivedBtn = document.getElementById('clear-archived');
  const homeLogo = document.getElementById('home-logo');

  /* ---------- 3) Helpers/State ---------- */
  const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other','Garage','Roof'];
  const safe = s => (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const by = k => (a,b)=> (a[k]||'').localeCompare(b[k]||'');

  const TRADE_DEFS = [
    { name:'Joinery' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Electrical' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Plumbing' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Plasterer' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Decorators' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Tiling' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Specialist' , phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
  ];

  let session=null, currentUser=null, currentProjectId=null;
  let roomsCache=[], tasksCache=[];

  function showAuth(){ authBox.classList.remove('hidden'); projectBox.classList.add('hidden'); dash.classList.add('hidden'); }
  function showProject(){ authBox.classList.add('hidden'); projectBox.classList.remove('hidden'); dash.classList.add('hidden'); }
  function showApp(){ authBox.classList.add('hidden'); projectBox.classList.add('hidden'); dash.classList.remove('hidden'); }

  async function probeAuth(){
    try{
      const r = await fetch(SUPABASE_URL + '/auth/v1/settings', { headers:{ apikey: SUPABASE_ANON_KEY }});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      diagLog('SW: none | Auth probe OK '+r.status);
    }catch(e){
      alert('Login probe could not reach Supabase.\n\nReason:\nAuth probe failed: '+e+'\n\nCheck:\n- Project URL exact '+SUPABASE_URL+'\n- Internet / VPN / Wi-Fi login page\n- Ad-block / tracking protection off for this site\n- Supabase Auth enabled\n- CORS Hardening not blocking your Netlify domain');
    }
  }
  document.getElementById('rerun-diag').addEventListener('click', probeAuth);

  function pct(n){ return Math.round((n||0)*100)+'%'; }

  /* ---------- 4) Auth (password flow) ---------- */
  signupBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim(), pw=(passwordInput.value||'').trim();
    if(!email || !pw) return alert('Please enter email and password');
    try{
      const { data, error } = await sb.auth.signUp({ email, password: pw });
      if(error){ if(error.message.includes('already registered')) alert('Sign up failed: User already registered'); else throw error; }
      else alert('Sign up OK. If email confirmation is enabled, confirm then Log In.');
    }catch(e){ alert('Sign up failed: '+e.message); }
  });

  loginBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim(), pw=(passwordInput.value||'').trim();
    if(!email || !pw) return alert('Please enter email and password');
    try{
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error) throw error;
      session = data.session;
      currentUser = data.user;
      authStateEl.textContent = 'Signed in: '+(currentUser?.email||'');
      showProject();
      await loadProjects();
    }catch(e){
      console.error(e);
      alert('Login error: '+(e.message||e));
    }
  });

  logoutBtn.addEventListener('click', async ()=>{
    try{ await sb.auth.signOut(); }catch(_){}
    session=null; currentUser=null; currentProjectId=null;
    authStateEl.textContent = 'Signed out';
    showAuth();
  });

  // Restore on load
  try{
    const { data } = await sb.auth.getSession();
    session = data.session; currentUser = data.session?.user||null;
    if(currentUser){
      authStateEl.textContent = 'Signed in: '+(currentUser.email||'');
      showProject();
      await loadProjects();
    }else{
      showAuth();
      await probeAuth(); // only when signed out to help diagnose
    }
  }catch(e){ console.warn('init session failed', e); showAuth(); }

  /* ---------- 5) Projects ---------- */
  async function loadProjects(){
    const showArchived = !!showArchivedProjects.checked;
    let q = sb.from('projects').select('id,name,is_archived,created_at').order('created_at', { ascending:false });
    if(!showArchived) q = q.eq('is_archived', false);
    const { data, error } = await q;
    if(error){ console.error(error); alert('Could not load projects: '+error.message); return; }

    projectSelect.innerHTML = '';
    for(const p of (data||[])){
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name + (p.is_archived?' (archived)':'');
      projectSelect.appendChild(opt);
    }
    if(!projectSelect.value) currentProjectId=null;
  }

  showArchivedProjects.addEventListener('change', loadProjects);

  useProjectBtn.addEventListener('click', async ()=>{
    const pid = projectSelect.value;
    if(!pid) return alert('Pick a project first');
    currentProjectId = pid;
    localStorage.setItem('mpj.currentProjectId', pid);
    await loadProjectData(pid);
    showApp();
  });

  toggleArchiveBtn.addEventListener('click', async ()=>{
    const pid = projectSelect.value; if(!pid) return alert('Pick a project first');
    const { data: cur, error: e0 } = await sb.from('projects').select('is_archived').eq('id', pid).single();
    if(e0) return alert(e0.message);
    const { error } = await sb.from('projects').update({ is_archived: !cur.is_archived }).eq('id', pid);
    if(error) return alert(error.message);
    await loadProjects();
    alert('Project '+(cur.is_archived?'unarchived':'archived'));
  });

  deleteProjectBtn.addEventListener('click', async ()=>{
    if(!currentUser) return;
    if(currentUser.id !== OWNER_UUID){ return alert('Only owner can delete projects.'); }
    const pid = projectSelect.value; if(!pid) return alert('Pick a project first');
    if(!confirm('Delete this project (soft delete rows, keep storage files)?')) return;
    // Best-effort: clear signoffs + tasks + photos rows for this project
    const { error: e1 } = await sb.from('signoffs').delete().eq('project_id', pid);
    if(e1) console.warn(e1);
    const { error: e2 } = await sb.from('tasks').delete().eq('project_id', pid);
    if(e2) console.warn(e2);
    const { error: e3 } = await sb.from('photos').delete().eq('project_id', pid);
    if(e3) console.warn(e3);
    const { error: e4 } = await sb.from('projects').delete().eq('id', pid);
    if(e4) { alert('Delete failed: '+e4.message); return; }
    alert('Project deleted');
    await loadProjects();
    currentProjectId=null;
    showProject();
  });

  createProjectBtn.addEventListener('click', async ()=>{
    const name = (projectNameInput.value||'').trim(); if(!name) return alert('Enter a project name');
    const addr = (projectAddressInput.value||'').trim()||null;
    const { data, error } = await sb.from('projects').insert({ name, address: addr, is_archived:false }).select('id').single();
    if(error) return alert(error.message);
    await loadProjects();
    projectSelect.value = data.id;
    alert('Project created. Click "Use Selected".');
  });

  homeLogo.addEventListener('click', async ()=>{
    // “Home” = reload current project if any, else just projects list
    const pid = currentProjectId || localStorage.getItem('mpj.currentProjectId');
    if(pid){ currentProjectId=pid; await loadProjectData(pid); showApp(); }
    else { showProject(); await loadProjects(); }
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* ---------- 6) Project Data: rooms, tasks, photos ---------- */
  async function loadProjectData(pid){
    // Rooms
    {
      const { data, error } = await sb.from('rooms').select('id,name,floor').eq('project_id', pid).order('floor').order('name');
      if(error){ console.error(error); roomsCache=[]; } else { roomsCache = data||[]; }
    }
    // Tasks (done states)
    {
      const { data, error } = await sb.from('tasks').select('id,room_id,trade,phase,done,notes').eq('project_id', pid);
      tasksCache = error?[]:(data||[]);
    }
    // Photos
    await renderAllPhotos(pid);
    await renderRooms(pid);
    await renderOverall();
    await renderSignoffs(pid);
  }

  /* ----- Photos ---- */
  async function renderAllPhotos(pid){
    const showArch = !!showArchivedPhotos.checked;
    let q = sb.from('photos').select('id,room_id,trade,phase,created_at,notes,archived,storage_path').eq('project_id', pid).order('created_at', { ascending:false });
    if(!showArch) q = q.eq('archived', false);
    const { data, error } = await q;
    if(error){ allPhotosEl.innerHTML = `<div class="muted">Error loading photos</div>`; return; }

    const blocks = (data||[]).map(p=>{
      const url = p.storage_path ? sb.storage.from('photos').getPublicUrl(p.storage_path).data.publicUrl : '';
      const tag = [p.trade,p.phase].filter(Boolean).join(' • ');
      return `
        <div class="thumb" data-photo-id="${p.id}">
          <img src="${safe(url)}" alt="photo"/>
          <div class="small muted">${safe(tag||'')}</div>
          <div class="row" style="gap:.35rem">
            <button class="btn small" data-arch="${p.archived?'0':'1'}" data-act="toggle-arch">${p.archived?'Unarchive':'Archive'}</button>
            <button class="btn small danger" data-act="soft-delete">Delete</button>
          </div>
        </div>`;
    }).join('');
    allPhotosEl.innerHTML = blocks || `<div class="muted">No photos yet</div>`;
  }

  showArchivedPhotos.addEventListener('change', ()=> currentProjectId && renderAllPhotos(currentProjectId));

  allPhotosEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const card = e.target.closest('.thumb'); const id = card?.getAttribute('data-photo-id'); if(!id) return;
    if(btn.dataset.act === 'toggle-arch'){
      const to = btn.getAttribute('data-arch') === '1';
      const { error } = await sb.from('photos').update({ archived: to }).eq('id', id);
      if(error) return alert(error.message);
      await renderAllPhotos(currentProjectId);
    }else if(btn.dataset.act === 'soft-delete'){
      if(!confirm('Mark this photo as deleted (it will be hidden)?')) return;
      const { error } = await sb.from('photos').update({ archived:true, deleted:true }).eq('id', id);
      if(error) return alert(error.message);
      await renderAllPhotos(currentProjectId);
    }
  });

  uploadPhotoBtn.addEventListener('click', async ()=>{
    const f = photoFile.files?.[0]; if(!f) return alert('Choose a file first');
    const room = roomsCache[0]; // default to first room for All Photos; user uploads inside room cards too in your extended flows
    const path = `${currentProjectId}/${room?.id||'general'}/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
    const { error: upErr } = await sb.storage.from('photos').upload(path, f, { upsert:false });
    if(upErr) return alert(upErr.message);
    const { error: insErr } = await sb.from('photos').insert({
      project_id: currentProjectId, room_id: room?.id||null, trade:null, phase:null, notes:null, archived:false, deleted:false, storage_path:path
    });
    if(insErr) return alert(insErr.message);
    photoFile.value='';
    await renderAllPhotos(currentProjectId);
    alert('Photo uploaded');
  });

  clearArchivedBtn.addEventListener('click', async ()=>{
    if(!confirm('Clear all archived photos for this project? (Soft-deleted/archived rows removed; storage files remain)')) return;
    const { error } = await sb.from('photos').delete().eq('project_id', currentProjectId).eq('archived', true);
    if(error) return alert(error.message);
    await renderAllPhotos(currentProjectId);
    alert('Archived photos cleared');
  });

  /* ----- Rooms + Tasks ---- */
  function roomProgress(roomId){
    const tasks = tasksCache.filter(t=>t.room_id===roomId);
    const total = TRADE_DEFS.reduce((acc,td)=> acc + td.phases.length, 0);
    const done = tasks.filter(t=>t.done).length;
    return { done, total, pct: total? (done/total): 0 };
  }

  async function renderRooms(pid){
    const filtered = (roomsCache||[]).filter(r=>{
      const q = (searchInput.value||'').toLowerCase().trim();
      if(!q) return true;
      return r.name.toLowerCase().includes(q) || (r.floor||'').toLowerCase().includes(q);
    });

    roomsEl.innerHTML = filtered.map(r=>{
      const p = roomProgress(r.id);
      const tradeBlocks = TRADE_DEFS.map(td=>{
        const checks = td.phases.map(ph=>{
          const existing = tasksCache.find(t=>t.room_id===r.id && t.trade===td.name && t.phase===ph);
          const checked = existing?.done ? 'checked' : '';
          return `<label class="row small" style="gap:.5rem">
                   <input type="checkbox" data-act="phase" data-room="${r.id}" data-trade="${td.name}" data-phase="${ph}" ${checked}/>
                   ${safe(ph)}
                  </label>`;
        }).join('');
        const notesTask = tasksCache.find(t=>t.room_id===r.id && t.trade===td.name && t.phase===null);
        const notesVal = notesTask?.notes || '';
        return `<div class="trade ${safe(td.name)}">
                  <span class="chip ${safe(td.name)}">${safe(td.name)}</span>
                  <div style="margin:.4rem 0">${checks}</div>
                  <div class="small muted" style="margin-top:.25rem">Notes</div>
                  <textarea class="notes" data-act="notes" data-room="${r.id}" data-trade="${td.name}" placeholder="Add notes...">${safe(notesVal)}</textarea>
                </div>`;
      }).join('');
      return `
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>${safe(r.name)}</strong>
            <span class="muted small">${safe(r.floor||'')}</span>
          </div>
          <div class="row" style="gap:1rem;margin:.4rem 0">
            <div class="barline" style="flex:1"><i style="width:${Math.round(p.pct*100)}%"></i></div>
            <div class="muted small">${p.done}/${p.total} &nbsp; ${Math.round(p.pct*100)}%</div>
          </div>
          ${tradeBlocks}
        </div>`;
    }).join('') || `<div class="muted">No rooms found</div>`;
  }

  roomsEl.addEventListener('change', async (e)=>{
    const chk = e.target.closest('input[type="checkbox"][data-act="phase"]'); 
    if(chk){
      const room_id = chk.getAttribute('data-room');
      const trade = chk.getAttribute('data-trade');
      const phase = chk.getAttribute('data-phase');
      const done = chk.checked;
      // Upsert (avoid duplicate unique errors)
      const { error } = await sb.from('tasks').upsert({
        project_id: currentProjectId, room_id, trade, phase, done
      }, { onConflict: 'project_id,room_id,trade,phase' });
      if(error){
        alert(error.message);
      }else{
        // update cache
        const idx = tasksCache.findIndex(t=>t.project_id===currentProjectId && t.room_id===room_id && t.trade===trade && t.phase===phase);
        if(idx>=0) tasksCache[idx].done = done;
        else tasksCache.push({ project_id:currentProjectId, room_id, trade, phase, done });
        await renderRooms(currentProjectId);
        await renderOverall();
      }
      return;
    }
    const ta = e.target.closest('textarea.notes[data-act="notes"]');
    if(ta){
      const room_id = ta.getAttribute('data-room');
      const trade = ta.getAttribute('data-trade');
      const notes = ta.value;
      const { error } = await sb.from('tasks').upsert({
        project_id: currentProjectId, room_id, trade, phase: null, notes
      }, { onConflict: 'project_id,room_id,trade,phase' });
      if(error) alert(error.message);
      else{
        const idx = tasksCache.findIndex(t=>t.project_id===currentProjectId && t.room_id===room_id && t.trade===trade && t.phase===null);
        if(idx>=0) tasksCache[idx].notes = notes; else tasksCache.push({project_id:currentProjectId, room_id, trade, phase:null, notes});
      }
    }
  });

  searchInput.addEventListener('input', ()=> currentProjectId && renderRooms(currentProjectId));

  async function renderSignoffs(pid){
    const { data, error } = await sb.from('signoffs').select('id,created_at,trade,phase,signed_by_name,rooms(name)').eq('project_id', pid).order('created_at', { ascending:false });
    if(error){ allSignoffsEl.innerHTML = `<div class="muted">Error loading sign-offs</div>`; return; }
    allSignoffsEl.innerHTML = (data||[]).map(s=>`
      <div class="row" style="gap:.6rem;padding:.35rem 0;border-bottom:1px solid #eee">
        <span class="chip">${safe(s.rooms?.name||'Room')}</span>
        <span class="chip">${safe(s.trade||'')}</span>
        <span class="chip">${safe(s.phase||'')}</span>
        <span class="small muted">by ${safe(s.signed_by_name||'')}</span>
      </div>`).join('') || `<div class="muted">No sign-offs yet</div>`;
  }

  async function renderOverall(){
    // sum all rooms
    let done=0,total=0;
    for(const r of roomsCache){
      const p = roomProgress(r.id);
      done+=p.done; total+=p.total;
    }
    const frac = total? (done/total): 0;
    overallBar.style.width = Math.round(frac*100)+'%';
    overallPct.textContent = Math.round(frac*100)+'%';
  }

  // Restore last used project if session exists
  if(currentUser){
    const pid = localStorage.getItem('mpj.currentProjectId');
    if(pid){ currentProjectId = pid; await loadProjectData(pid); showApp(); }
  }
})();
</script>
</body>
</html>
