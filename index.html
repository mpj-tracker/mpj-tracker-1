<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPJ Tracker</title>

  <!-- Theme / PWA bits -->
  <meta name="theme-color" content="#0b5f3b"/>
  <link rel="manifest" href="/manifest.webmanifest?v=1"/>

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png"/>

  <!-- Supabase UMD (global) -->
  <script>
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer> 
  </script>

  <style>
    :root{
      --brand:#0b5f3b; --accent:#0b5f3b; --muted:#f3f6f6; --text:#111827; --card:#ffffff;
      --joinery:#198754; --plumbing:#0d6efd; --electrical:#dc3545; --plasterer:#6f42c1; --decorators:#fd7e14;
      --tiling:#8b5e3c; --special:#20c997; --chip:#eceff1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
      background:#fff;color:var(--text);}
    header{position:sticky;top:0;background:var(--brand);color:#fff;border-bottom:2px solid rgba(0,0,0,.08);z-index:5}
    .bar{max-width:1200px;margin:auto;display:flex;gap:.75rem;align-items:center;padding:.6rem .9rem}
    .brand{display:flex;gap:.6rem;align-items:center}
    .brand img{height:28px;width:auto}
    .pill{margin-left:auto;background:rgba(255,255,255,.15);padding:.3rem .6rem;border-radius:999px;font-size:.85rem}
    main{max-width:1200px;margin:1rem auto;padding:0 .9rem}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:.75rem 0}
    .row{display:flex;gap:.6rem;align-items:center}
    .grid{display:grid;gap:.9rem}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    details{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    details>summary{cursor:pointer;padding:1rem;border-radius:12px;list-style:none}
    details[open]>summary{border-bottom:1px solid #e5e7eb}
    .progress{height:.65rem;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--brand);width:0%}
    .chip{display:inline-flex;align-items:center;gap:.35rem;background:var(--chip);border-radius:999px;padding:.25rem .55rem;font-size:.8rem}
    .muted{color:#6b7280}
    .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.accent{background:var(--brand);color:#fff;border-color:var(--brand)}
    .input{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:.55rem .7rem}
    .trade{border-left:5px solid transparent}
    .trade.joinery{border-color:var(--joinery)}
    .trade.plumbing{border-color:var(--plumbing)}
    .trade.electrical{border-color:var(--electrical)}
    .trade.plasterer{border-color:var(--plasterer)}
    .trade.decorators{border-color:var(--decorators)}
    .trade.tiling{border-color:var(--tiling)}
    .trade.specialist{border-color:var(--special)}
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer}
    .task-line{display:flex;align-items:flex-start;gap:.7rem}
    .task-line .grow{flex:1}
    .right{margin-left:auto}
    .small{font-size:.85rem}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <img src="/mpj-logo.png" alt="logo"/>
      <strong>MPJ Tracker</strong>
    </div>
    <span id="auth-state" class="pill">Signed out</span>
  </div>
</header>

<main>
  <!-- Login / Sign Up -->
  <div id="auth-box" class="card" style="display:none">
    <h2>Login / Sign Up</h2>
    <p class="muted">Use your email + password to sign in. New users can sign up on the same form.</p>
    <div class="row">
      <input id="email" class="input" style="max-width:280px" placeholder="Enter your email"/>
      <input id="password" class="input" style="max-width:200px" type="password" placeholder="Enter your password"/>
      <button id="signup-btn" class="btn">Sign Up</button>
      <button id="login-btn" class="btn">Log In</button>
    </div>
  </div>

  <!-- Project box -->
  <div id="project-box" class="card" style="display:none">
    <h2>Project</h2>
    <div class="row" style="gap:1rem;align-items:end">
      <div style="flex:1">
        <label class="small muted">Project name</label>
        <input id="project-name" class="input" placeholder="Project name"/>
      </div>
      <div style="flex:2">
        <label class="small muted">Site address</label>
        <input id="project-address" class="input" placeholder="Site address (optional)"/>
      </div>
      <div>
        <button id="use-project" class="btn accent">Use / Create Project</button>
      </div>
    </div>
    <p class="small muted" style="margin-top:.5rem">Tip: re-use the same name to open it again later.</p>
  </div>

  <!-- Dashboard -->
  <div id="dash" style="display:none">
    <div class="card">
      <h2>Project Dashboard</h2>
      <input id="search" class="input" placeholder="Filter by room, trade, phase, or user…" style="max-width:460px;margin:.5rem 0"/>
      <div class="row" style="gap:1rem">
        <div class="card" style="flex:1">
          <details id="signoffs-block">
            <summary><strong>All Sign-offs</strong></summary>
            <div class="small muted" style="margin:.25rem 0">Room • Trade • Phase • Signed by • When</div>
            <div id="all-signoffs"></div>
          </details>
        </div>
        <div class="card" style="flex:1">
          <details id="photos-block">
            <summary><strong>All Photos</strong></summary>
            <div id="all-photos" class="thumbs"></div>
          </details>
        </div>
      </div>

      <div class="row" style="gap:1rem;align-items:center;margin:.5rem 0">
        <strong>Overall Progress</strong>
        <div class="progress" style="flex:1;max-width:540px"><span id="overall-bar"></span></div>
        <span id="overall-pct" class="small muted">0%</span>
        <button id="logout-btn" class="btn right">Sign out</button>
      </div>
    </div>
  </div>

  <!-- Floors / Rooms / Tasks -->
  <div id="rooms" class="grid"></div>
</main>
<script> src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script defer>
(async function () {
  // --- 1) Supabase client ---
  const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- 2) DOM refs ---
  const authBox = document.getElementById('auth-box');
  const projectBox= document.getElementById('project-box');
  const dash = document.getElementById('dash');
  const roomsEl = document.getElementById('rooms');
  const authStateEl = document.getElementById('auth-state');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const projectNameInput = document.getElementById('project-name');
  const projectAddressInput= document.getElementById('project-address');
  const useProjectBtn = document.getElementById('use-project');

  const searchInput = document.getElementById('search');
  const allSignoffsEl = document.getElementById('all-signoffs');
  const allPhotosEl = document.getElementById('all-photos');
  const overallBar = document.getElementById('overall-bar');
  const overallPct = document.getElementById('overall-pct');

  // --- 3) App state ---
  let session = null;
  let currentUser = null;
  let currentProjectId = null;
  let allTasksCache = []; // for progress calc + search

  const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other'];

  const TRADE_CLASSES = {
    Joiners: 'joinery', Plumber:'plumbing', Electricians:'electrical',
    Plasterer:'plasterer', Decorators:'decorators', Tiling:'tiling', Specialist:'specialist'
  };

  // --- helpers ---
  const fmtPct = (n)=>`${Math.round(n)}%`;
  const el = (html)=> {
    const t=document.createElement('template');
    t.innerHTML=html.trim();
    return t.content.firstElementChild;
  };
  function progress(done,total){
    if(!total) return 0;
    return (done/total)*100;
  }

  function showAuth(){ authBox.style.display='block'; projectBox.style.display='none'; dash.style.display='none'; roomsEl.innerHTML=''; }
  function showProject(){ authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='block'; }

  // --- 4) Auth wiring ---
  signupBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value||'';
    if(!email || !pw) return alert('Please enter email and password');
    const { error } = await sb.auth.signUp({ email, password: pw });
    if (error) return alert(error.message);
    alert('Sign up OK! Check your inbox to confirm (if required).');
  });

  loginBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value||'';
    if(!email || !pw) return alert('Please enter email and password');
    const { error } = await sb.auth.signInWithPassword({ email, password: pw });
    if (error) return alert(error.message);
  });

  logoutBtn.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

  sb.auth.onAuthStateChange(async (_evt, s) => {
    session = s ?? session;
    const g = await sb.auth.getSession();
    session = g.data.session;
    currentUser = session?.user ?? null;
    authStateEl.textContent = currentUser ? `Signed in` : 'Signed out';
    if (currentUser) showProject(); else showAuth();
  });

  // initial
  {
    const { data } = await sb.auth.getSession();
    session = data.session;
    currentUser = session?.user ?? null;
    authStateEl.textContent = currentUser ? `Signed in` : 'Signed out';
    if (currentUser) showProject(); else showAuth();
  }

  // --- 5) Use/Create project (auto seed if empty) ---
  useProjectBtn.addEventListener('click', async ()=>{
    const name = (projectNameInput.value||'').trim();
    const addr = (projectAddressInput.value||'').trim();
    if(!name) return alert('Enter a project name');

    // find existing for this user (by name)
    const { data: existing, error: findErr } = await sb
      .from('projects').select('id').eq('user_id', currentUser.id).eq('name', name).limit(1);
    if (findErr) return alert(findErr.message);

    if(existing?.length){
      currentProjectId = existing[0].id;
    } else {
      const { data: ins, error: insErr } = await sb
        .from('projects')
        .insert({ name, site_address: addr, user_id: currentUser.id })
        .select('id')
        .single();
      if(insErr) return alert(insErr.message);
      currentProjectId = ins.id;

      // seed rooms and trade tasks (your RPCs)
      const seed1 = await sb.rpc('seed_full_project', { p_name: name, p_site: addr });
      if (seed1.error) console.warn('seed_full_project:', seed1.error.message);
      const seed2 = await sb.rpc('seed_trade_tasks_for_project', { project_id: currentProjectId });
      if (seed2.error) console.warn('seed_trade_tasks_for_project:', seed2.error.message);
    }

    await renderEverything(currentProjectId);
  });

  // --- 6) Search filter ---
  searchInput.addEventListener('input', ()=>{
    const q = (searchInput.value||'').toLowerCase();
    // hide/show room cards by match on room name OR any task trade/phase OR any signoff user
    for (const card of roomsEl.querySelectorAll('[data-roomcard]')) {
      const text = card.getAttribute('data-search')||'';
      card.style.display = text.includes(q) ? '' : 'none';
    }
  });

  // --- 7) Rendering ---
  async function renderEverything(pid){
    roomsEl.innerHTML = 'Loading…';
    await renderFloors(pid);
    await renderDashboard(pid);
  }

  async function renderFloors(pid){
    // rooms grouped by floor
    const { data: rooms, error } = await sb
      .from('rooms')
      .select('id,floor_name,room_name')
      .eq('project_id', pid)
      .order('floor_name',{ascending:true})
      .order('room_name',{ascending:true});
    if(error) return roomsEl.textContent = error.message;

    // tasks for all rooms once
    const { data: tasksData, error: tErr } = await sb
      .from('tasks')
      .select('id,room_id,trade,phase,done,notes,signed_off,signed_off_by,signed_off_at')
      .in('room_id', rooms.map(r=>r.id));
    if(tErr) return roomsEl.textContent = tErr.message;

    allTasksCache = tasksData||[];

    // group by floor then room
    const byFloor = new Map();
    for(const r of rooms){
      if(!byFloor.has(r.floor_name)) byFloor.set(r.floor_name, []);
      byFloor.get(r.floor_name).push(r);
    }

    // build UI
    const frag = document.createDocumentFragment();
    // floor order
    const floors = Array.from(byFloor.keys()).sort((a,b)=>{
      const ai = FLOOR_ORDER.indexOf(a), bi = FLOOR_ORDER.indexOf(b);
      return (ai<0?999:ai)-(bi<0?999:bi);
    });

    let overallDone=0, overallTotal=0;

    for(const floor of floors){
      const floorRooms = byFloor.get(floor);
      // floor tasks slice
      const roomIds = floorRooms.map(r=>r.id);
      const floorTasks = (tasksData||[]).filter(t=>roomIds.includes(t.room_id));
      const fd = floorTasks.filter(t=>t.done).length;
      const ft = floorTasks.length;
      overallDone += fd; overallTotal += ft;

      const floorDetails = el(`
        <details>
          <summary class="row" style="gap:1rem">
            <strong style="min-width:140px">${floor}</strong>
            <span class="small muted">${fd}/${ft}</span>
            <div class="progress" style="flex:1;max-width:360px"><span style="width:${progress(fd,ft)}%"></span></div>
            <span class="small muted">${fmtPct(progress(fd,ft))}</span>
          </summary>
          <div class="grid cols-2" style="padding:1rem"></div>
        </details>
      `);
      const grid = floorDetails.querySelector('.grid');

      for(const room of floorRooms){
        const rTasks = (tasksData||[]).filter(t=>t.room_id===room.id);
        const rd = rTasks.filter(t=>t.done).length;
        const rt = rTasks.length;

        // collect searchable text
        const searchText = [
          (room.room_name||''),
          ...rTasks.map(t => `${t.trade} ${t.phase} ${t.signed_off_by||''}`)
        ].join(' ').toLowerCase();

        const card = el(`
          <details data-roomcard data-search="${searchText}">
            <summary class="row" style="gap:1rem">
              <strong style="min-width:180px">${room.room_name}</strong>
              <span class="small muted">${rd}/${rt}</span>
              <div class="progress" style="flex:1;max-width:220px"><span style="width:${progress(rd,rt)}%"></span></div>
              <span class="small muted">${fmtPct(progress(rd,rt))}</span>
            </summary>
            <div class="card" style="border:none;border-radius:0;border-top:1px solid #e5e7eb">
              <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem"></div>
            </div>
          </details>
        `);
        const innerGrid = card.querySelector('.grid');

        // Group tasks by trade
        const byTrade = new Map();
        for(const t of rTasks){
          if(!byTrade.has(t.trade)) byTrade.set(t.trade, []);
          byTrade.get(t.trade).push(t);
        }

        for(const [trade, items] of byTrade){
          const tClass = TRADE_CLASSES[trade]||'';
          const tradeBlock = el(`
            <div class="card trade ${tClass}">
              <div class="row" style="justify-content:space-between">
                <strong>${trade}</strong>
                <span class="small muted">${items.filter(x=>x.done).length}/${items.length}</span>
              </div>
              <div></div>
            </div>
          `);
          const listHost = tradeBlock.lastElementChild;

          for(const task of items){
            const line = el(`
              <div class="task-line" style="margin:.6rem 0">
                <input type="checkbox" ${task.done?'checked':''}/>
                <div class="grow">
                  <div class="row" style="justify-content:space-between;gap:.5rem">
                    <strong>${task.phase}</strong>
                    <span class="small muted">${task.signed_off ? `✔ Signed by ${task.signed_off_by||''}` : ''}</span>
                  </div>
                  <textarea class="input" rows="2" placeholder="Notes…" style="margin:.35rem 0">${task.notes||''}</textarea>
                  <div class="row" style="gap:.5rem;align-items:center">
                    <input type="file" accept="image/*" capture="environment"/>
                    <button class="btn small">Upload</button>
                    <button class="btn small accent">Sign off</button>
                    <span class="small muted right">${task.signed_off_at ? new Date(task.signed_off_at).toLocaleString() : ''}</span>
                  </div>
                  <div class="thumbs" style="margin-top:.4rem"></div>
                </div>
              </div>
            `);
            const [cb, notes, fileInput, uploadBtn, signBtn] =
              [line.querySelector('input[type=checkbox]'),
               line.querySelector('textarea'),
               line.querySelector('input[type=file]'),
               line.querySelectorAll('button')[0],
               line.querySelectorAll('button')[1]];

            // Save done toggle
            cb.addEventListener('change', async ()=>{
              await sb.from('tasks').update({ done: cb.checked }).eq('id', task.id);
              await renderEverything(currentProjectId); // refresh progress
            });

            // Save notes (debounced)
            let noteTimer=null;
            notes.addEventListener('input', ()=>{
              clearTimeout(noteTimer);
              noteTimer=setTimeout(async ()=>{
                await sb.from('tasks').update({ notes: notes.value }).eq('id', task.id);
              }, 400);
            });

            // Upload photo
            uploadBtn.addEventListener('click', async ()=>{
              const f = fileInput.files?.[0];
              if(!f) return;
              const path = `${currentProjectId}/${task.id}/${Date.now()}_${f.name}`;
              const { error: upErr } = await sb.storage.from('photos').upload(path, f, { upsert:false });
              if(upErr){ alert(upErr.message); return; }
              await sb.from('photos').insert({
                project_id: currentProjectId, task_id: task.id,
                room_id: task.room_id, uploaded_by: currentUser.email, path
              });
              await loadPhotos(task.id, line.querySelector('.thumbs'));
            });

            // Sign off
            signBtn.addEventListener('click', async ()=>{
              const payload = {
                signed_off: true,
                signed_off_by: currentUser.email,
                signed_off_at: new Date().toISOString()
              };
              const { error: upErr } = await sb.from('tasks').update(payload).eq('id', task.id);
              if(upErr) return alert(upErr.message);
              await sb.from('task_signoffs').insert({
                task_id: task.id, room_id: task.room_id, project_id: currentProjectId,
                trade: task.trade, phase: task.phase, signed_by: currentUser.email
              });
              await renderEverything(currentProjectId);
            });

            // Load existing photos
            await loadPhotos(task.id, line.querySelector('.thumbs'));
            listHost.appendChild(line);
          }

          innerGrid.appendChild(tradeBlock);
        }

        floorDetails.querySelector('.grid').appendChild(card);
      }

      frag.appendChild(floorDetails);
    }

    roomsEl.innerHTML = '';
    roomsEl.appendChild(frag);

    // overall
    const pct = progress(overallDone, overallTotal);
    overallBar.style.width = pct + '%';
    overallPct.textContent = fmtPct(pct);
  }

  async function loadPhotos(taskId, host){
    host.innerHTML = '';
    const { data, error } = await sb
      .from('photos')
      .select('path,uploaded_by,created_at')
      .eq('task_id', taskId)
      .order('created_at',{ascending:false});
    if(error) return;
    for(const p of (data||[])){
      const { data: pub } = sb.storage.from('photos').getPublicUrl(p.path);
      const img = new Image();
      img.src = pub.publicUrl;
      img.title = `${p.uploaded_by||''}\n${new Date(p.created_at).toLocaleString()}`;
      img.addEventListener('click', ()=> window.open(pub.publicUrl,'_blank'));
      host.appendChild(img);
    }
  }

  // Dashboard lists
  async function renderDashboard(pid){
    // signoffs
    const { data: so } = await sb
      .from('task_signoffs')
      .select('id,trade,phase,signed_by,created_at,room_id,rooms!inner(room_name)')
      .eq('project_id', pid)
      .order('created_at',{ascending:false})
      .limit(200);
    allSignoffsEl.innerHTML = '';
    for(const s of (so||[])){
      allSignoffsEl.appendChild(el(`
        <div class="row small" style="gap:.6rem;padding:.3rem 0;border-bottom:1px dashed #eee">
          <span class="chip">${s.rooms?.room_name||''}</span>
          <span class="chip">${s.trade}</span>
          <span class="chip">${s.phase}</span>
          <span class="muted">${s.signed_by||''}</span>
          <span class="muted">${new Date(s.created_at).toLocaleString()}</span>
        </div>
      `));
    }

    // all photos
    const { data: ph } = await sb
      .from('photos')
      .select('path,uploaded_by,created_at')
      .eq('project_id', pid)
      .order('created_at',{ascending:false})
      .limit(300);
    allPhotosEl.innerHTML='';
    for(const p of (ph||[])){
      const { data: pub } = sb.storage.from('photos').getPublicUrl(p.path);
      const img = new Image();
      img.src = pub.publicUrl;
      img.title = `${p.uploaded_by||''}\n${new Date(p.created_at).toLocaleString()}`;
      img.addEventListener('click', ()=> window.open(pub.publicUrl,'_blank'));
      allPhotosEl.appendChild(img);
    }
  }

})();
</script>
</body>
</html>
