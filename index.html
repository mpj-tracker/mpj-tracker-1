<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MPJ Tracker</title>
  <link rel="icon" type="image/png" href="mpj-logo.png" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: #004225; color: white; }
    header img { height: 40px; margin-right: 10px; }
    .container { padding: 20px; }
    details { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; background: white; padding: 5px 10px; }
    summary { font-weight: bold; cursor: pointer; }
    .trade { padding: 5px; border-radius: 4px; margin: 5px 0; }
    .joiner { background: #d4edda; }
    .electrician { background: #f8d7da; }
    .plumber { background: #d1ecf1; }
    .plasterer { background: #fefefe; border: 1px solid #ccc; }
    .decorator { background: #fff3cd; }
    .tiler { background: #e2e3e5; }
    .specialist { background: #f5d0fe; }
    .progress { background: #e9ecef; border-radius: 4px; height: 14px; margin: 5px 0; }
    .progress-bar { background: #28a745; height: 14px; border-radius: 4px; width: 0%; transition: width 0.3s ease; }
    .signoff { margin-top: 8px; font-size: 0.9rem; }
    .photos { margin-top: 6px; }
    .photos img { height: 80px; margin: 4px; border-radius: 4px; border: 1px solid #ccc; object-fit: cover; display:block; }
    .photos .caption { font-size: 0.8rem; color: #555; margin-left:4px; }
    table { border-collapse: collapse; width: 100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left; }
    th { background:#eee; }
    #filter { margin:10px 0; padding:6px; width:100%; max-width:400px; }
    .gallery-item { border:1px solid #ddd; border-radius:6px; padding:4px; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center;">
      <img src="mpj-logo.png" alt="Logo" />
      <h1>MPJ Tracker</h1>
    </div>
    <button id="logout-btn" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Log out</button>
  </header>

  <div class="container">
    <div id="auth-box">
      <h2>Login / Sign Up</h2>
      <input id="email" type="email" placeholder="Email" /><br/>
      <input id="password" type="password" placeholder="Password" /><br/>
      <button id="signup-btn">Sign Up</button>
      <button id="login-btn">Log In</button>
    </div>

    <div id="project-box" style="display:none;">
      <h2>Project</h2>
      <input id="project-name" placeholder="Project name" />
      <input id="project-address" placeholder="Site address (optional)" />
      <button id="use-project">Use / Create Project</button>
    </div>

    <h3>Overall Progress</h3>
    <div class="progress"><div id="overall-progress" class="progress-bar"></div></div>

    <h3>Project Dashboard</h3>
    <input id="filter" placeholder="Filter by room, trade, or user..." />

    <details open>
      <summary><strong>All Sign-offs</strong></summary>
      <table id="signoff-table">
        <thead>
          <tr><th>Room</th><th>Trade</th><th>Signed by</th><th>Date</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </details>

    <details>
      <summary><strong>All Photos</strong></summary>
      <div id="photo-gallery" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:10px; margin:10px 0;"></div>
    </details>

    <div id="rooms"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = "https://zpnqruthpknncpilztxf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4"; 
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const filterInput = document.getElementById("filter");

    // ... [Auth + Project handling code same as before] ...

    async function renderSignoffs(projectId) {
      const tbody = document.querySelector("#signoff-table tbody");
      tbody.innerHTML = "";
      const { data: signs } = await sb
        .from("signoffs")
        .select("*, rooms(room_name)")
        .eq("project_id", projectId);

      signs.forEach(s => {
        const tr = document.createElement("tr");
        tr.dataset.room = s.rooms?.room_name || "";
        tr.dataset.trade = s.trade;
        tr.dataset.user = s.user_id || "Unknown";
        tr.innerHTML = `
          <td>${s.rooms?.room_name || ''}</td>
          <td>${s.trade}</td>
          <td>${s.user_id || 'Unknown'}</td>
          <td>${new Date(s.signed_at).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function renderPhotosDashboard(projectId) {
      const gallery = document.getElementById("photo-gallery");
      gallery.innerHTML = "";
      const { data: photos } = await sb.from("photos").select("*").eq("project_id", projectId);

      photos.forEach(p => {
        const url = sb.storage.from("photos").getPublicUrl(p.storage_path).data.publicUrl;
        const div = document.createElement("div");
        div.className = "gallery-item";
        div.dataset.room = p.room_name || "";
        div.dataset.trade = p.trade || "";
        div.dataset.user = p.uploaded_by || "";
        div.innerHTML = `
          <img src="${url}" style="width:100%; border-radius:6px;" />
          <div style="font-size:0.8rem; margin-top:4px;">
            ${p.room_name || ''}<br/>
            <em>${p.uploaded_by}</em><br/>
            <small>${new Date(p.uploaded_at).toLocaleString()}</small>
          </div>
        `;
        gallery.appendChild(div);
      });
    }

    // Filter function
    filterInput.addEventListener("input", () => {
      const term = filterInput.value.toLowerCase();
      // Sign-offs
      document.querySelectorAll("#signoff-table tbody tr").forEach(row => {
        const text = `${row.dataset.room} ${row.dataset.trade} ${row.dataset.user}`.toLowerCase();
        row.style.display = text.includes(term) ? "" : "none";
      });
      // Photos
      document.querySelectorAll("#photo-gallery .gallery-item").forEach(item => {
        const text = `${item.dataset.room} ${item.dataset.trade} ${item.dataset.user}`.toLowerCase();
        item.style.display = text.includes(term) ? "" : "none";
      });
    });
  </script>
</body>
</html>
