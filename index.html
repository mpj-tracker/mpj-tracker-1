<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MPJ Tracker</title>

  <!-- PWA/branding bits (optional but nice) -->
  <meta name="theme-color" content="#0b5f3b" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png" />
  <link rel="manifest" href="/manifest.webmanifest?v=2" />

  <!-- Supabase (UMD) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --brand:#0b5f3b;
      --accent:#f0b323;
      --bg:#f7faf9;
      --border:#e3e6eb;
      --muted:#eef3f1;
      --text:#111827;
    }
    * { box-sizing:border-box }
    html, body { height:100% }
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    header {
      position:sticky; top:0;
      background:#fff;
      border-bottom:3px solid var(--brand);
      z-index:10;
    }
    .hi { max-width:1200px; margin:0 auto; display:flex; gap:.6rem; align-items:center; padding:.6rem .8rem; }
    .logo { display:flex; align-items:center; gap:.6rem; }
    .logo img { height:28px; border-radius:6px; background:#fff; }
    .brand { font-weight:700; color:var(--brand) }

    main { max-width:1200px; margin:0 auto; padding:1rem; }
    .row { display:flex; gap:.5rem; align-items:center; }
    .spacer { flex:1 }
    .status { color:#6b7280; font-size:.9rem }

    .card {
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:1rem;
      margin:.6rem 0;
    }
    .btn {
      background:var(--brand);
      border:none;
      color:#fff;
      padding:.55rem .9rem;
      border-radius:8px;
      cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .btn.accent { background:var(--accent); color:#111 }
    .input {
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:.55rem .65rem;
      min-width:240px;
    }
    .small { font-size:.9rem; color:#6b7280 }

    /* Accordion styles */
    details.floor, details.room {
      border: 1px solid var(--border);
      border-radius: 10px;
      margin: .5rem 0;
      background: #fff;
    }
    details > summary {
      cursor: pointer;
      list-style: none;
      padding: .8rem 1rem;
      font-weight: 600;
    }
    details > summary::-webkit-details-marker { display: none; }
    .floor > .body, .room > .body {
      padding: .75rem 1rem 1rem;
      border-top: 1px dashed var(--border);
    }

    /* Rooms grid inside a floor */
    .grid-rooms {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: .75rem;
    }
    @media (min-width: 900px) {
      .grid-rooms { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    /* Task card */
    .task {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: .75rem;
      margin: .5rem 0;
      background: #fff;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: .75rem;
      align-items: start;
    }
    .task .title { font-weight: 600; }
    .task .notes {
      grid-column: 1 / -1;
      width: 100%;
      min-height: 70px;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: .5rem .6rem;
      resize: vertical;
    }
    .task .photos { grid-column: 1 / -1; }
    .photos .thumbs { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.4rem; }
    .thumbs img { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border); background:#f8fafc; }
    .photos input[type="file"] { display:block; margin:.3rem 0 .2rem; }

    /* Auth/login box */
    #auth-box .row { gap:.4rem }
  </style>
</head>
<body>
  <header>
    <div class="hi">
      <div class="logo">
        <img src="/mpj-logo.png" alt="logo" />
        <span class="brand">MPJ Tracker</span>
      </div>
      <div class="spacer"></div>
      <div id="status" class="status">Signed out</div>
      <button id="logout-btn" class="btn accent" style="display:none;">Log out</button>
    </div>
  </header>

  <main>

    <!-- Auth (shown when logged OUT) -->
    <div id="auth-box" class="card" style="display:none;">
      <h2>Login / Sign Up</h2>
      <p class="small">Use your email + password to sign in. New users can sign up on the same form.</p>
      <div class="row">
        <input id="email" class="input" type="email" placeholder="Enter your email" />
        <input id="password" class="input" type="password" placeholder="Enter your password" />
        <button id="signup-btn" class="btn">Sign Up</button>
        <button id="login-btn" class="btn">Log In</button>
      </div>
    </div>

    <!-- Project (shown when logged IN, before rooms) -->
    <div id="project-box" class="card" style="display:none;">
      <h3>Project</h3>
      <div class="row">
        <input id="project-name" class="input" placeholder="Project name" />
        <input id="project-address" class="input" placeholder="Site address (optional)" />
        <button id="use-project" class="btn accent">Use / Create Project</button>
      </div>
      <p class="small">Tip: Re-use the same name to open it again later.</p>
    </div>

    <!-- Rooms + Tasks accordion -->
    <div id="rooms"></div>

  </main>

  <!-- ========= APP SCRIPT (no HTML comments inside) ========= -->
  <script>
  (function () {
    /* 1) Supabase client */
    const SUPABASE_URL = 'https://zpnqruthpknncpiiztxf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) DOM refs */
    const authBox = document.getElementById('auth-box');
    const projectBox = document.getElementById('project-box');
    const roomsEl = document.getElementById('rooms');
    const statusEl = document.getElementById('status');
    const logoutBtn = document.getElementById('logout-btn');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');

    const projectNameInput = document.getElementById('project-name');
    const projectAddressInput = document.getElementById('project-address');
    const useProjectBtn = document.getElementById('use-project');

    /* 3) Global state */
    let session = null;
    let currentProjectId = null;

    /* 4) Helpers */
    const esc = (s='') =>
      String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
               .replaceAll('>','&gt;').replaceAll('"','&quot;')
               .replaceAll("'","&#39;");

    function showAuthUI() {
      authBox.style.display = 'block';
      projectBox.style.display = 'none';
      roomsEl.innerHTML = '';
      statusEl.textContent = 'Signed out';
      logoutBtn.style.display = 'none';
    }
    function showProjectPicker() {
      authBox.style.display = 'none';
      projectBox.style.display = 'block';
      roomsEl.innerHTML = '';
      statusEl.textContent = 'Signed in';
      logoutBtn.style.display = 'inline-block';
    }

    /* 5) Auth wiring */
    if (signupBtn) {
      signupBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim();
        const password = passwordInput.value || '';
        if (!email || !password) return alert('Please enter email and password');

        const { error } = await sb.auth.signUp({ email, password });
        if (error) return alert('Sign up failed: ' + error.message);
        alert('Sign up successful. Check your email to confirm (if required).');
      });
    }

    if (loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const email = (emailInput.value || '').trim();
        const password = passwordInput.value || '';
        if (!email || !password) return alert('Please enter email and password');

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return alert('Log in failed: ' + error.message);
        // onAuthStateChange will handle the rest
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const { error } = await sb.auth.signOut();
        if (error) return alert('Logout error: ' + error.message);
      });
    }

    sb.auth.onAuthStateChange((_evt, s) => {
      session = s?.session ?? s;
      if (session) showProjectPicker();
      else showAuthUI();
    });

    /* 6) On first load, pick up session */
    (async () => {
      const { data } = await sb.auth.getSession();
      session = data.session;
      if (session) showProjectPicker();
      else showAuthUI();
    })();

    /* 7) Project selection / creation (uses your seed_full_project function) */
    if (useProjectBtn) {
      useProjectBtn.addEventListener('click', async () => {
        const name = (projectNameInput.value || '').trim();
        const addr = projectAddressInput.value || '';
        if (!name) return alert('Please enter a project name.');

        useProjectBtn.disabled = true;

        // Try to find existing by exact name for this user
        const { data: existing, error: findErr } = await sb
          .from('projects')
          .select('id, name, user_id')
          .eq('name', name)
          .order('created_at', { ascending: false })
          .limit(1);

        if (findErr) {
          useProjectBtn.disabled = false;
          return alert('Lookup failed: ' + findErr.message);
        }

        if (existing && existing.length) {
          currentProjectId = existing[0].id;
        } else {
          // Create project + all rooms via RPC
          const { data: newId, error: rpcErr } = await sb
            .rpc('seed_full_project', { p_name: name, p_site: addr });

          if (rpcErr) {
            useProjectBtn.disabled = false;
            return alert('Create failed: ' + rpcErr.message);
          }
          currentProjectId = newId; // function returns uuid
        }

        await renderFloorsAndRooms(currentProjectId);
        useProjectBtn.disabled = false;
        projectBox.style.display = 'none'; // hide picker after load
      });
    }

    /* 8) Accordion render: floors → rooms → tasks (+ photo upload) */
    async function renderFloorsAndRooms(projectId) {
      roomsEl.innerHTML = 'Loading…';

      // Load rooms
      const { data: rooms, error: roomsErr } = await sb
        .from('rooms')
        .select('id, floor_name, room_name')
        .eq('project_id', projectId)
        .order('floor_name', { ascending: true })
        .order('room_name', { ascending: true });

      if (roomsErr) {
        roomsEl.innerHTML = `<div class="card">Rooms load error: ${esc(roomsErr.message)}</div>`;
        return;
      }
      if (!rooms?.length) {
        roomsEl.innerHTML = `<div class="card">No rooms for this project.</div>`;
        return;
      }

      // Load tasks for all rooms
      const roomIds = rooms.map(r => r.id);
      const { data: tasks, error: tasksErr } = await sb
        .from('tasks')
        .select('id, room_id, description, done, notes')
        .in('room_id', roomIds)
        .order('description', { ascending: true });

      if (tasksErr) {
        roomsEl.innerHTML = `<div class="card">Tasks load error: ${esc(tasksErr.message)}</div>`;
        return;
      }

      // Group tasks by room
      const tasksByRoom = new Map();
      for (const t of tasks) {
        if (!tasksByRoom.has(t.room_id)) tasksByRoom.set(t.room_id, []);
        tasksByRoom.get(t.room_id).push(t);
      }

      // Group rooms by floor
      const floors = new Map();
      for (const r of rooms) {
        if (!floors.has(r.floor_name)) floors.set(r.floor_name, []);
        floors.get(r.floor_name).push(r);
      }

      // Build HTML
      const htmlFloors = [];
      for (const [floorName, floorRooms] of floors) {
        const htmlRooms = floorRooms.map(room => {
          const rTasks = tasksByRoom.get(room.id) || [];
          const htmlTasks = rTasks.map(t => taskHtml(t, room.id)).join('');

          return `
            <details class="room" data-room-id="${room.id}">
              <summary>${esc(room.room_name)}</summary>
              <div class="body">
                ${htmlTasks || '<div class="small">No tasks yet for this room.</div>'}
              </div>
            </details>
          `;
        }).join('');

        htmlFloors.push(`
          <details class="floor">
            <summary>${esc(floorName)}</summary>
            <div class="body">
              <div class="grid-rooms">
                ${htmlRooms}
              </div>
            </div>
          </details>
        `);
      }

      roomsEl.innerHTML = htmlFloors.join('');

      // After render: populate thumbnails for each task
      await refreshAllThumbnails(roomsEl);
    }

    function taskHtml(t, roomId) {
      const cbId = `tcb_${t.id}`;
      const ntId = `tnt_${t.id}`;
      const fiId = `tfile_${t.id}`;
      const phWrap = `photos_${t.id}`;
      return `
        <div class="task" data-task-id="${t.id}" data-room-id="${roomId}">
          <div><input id="${cbId}" type="checkbox" ${t.done ? 'checked' : ''} /></div>
          <div class="title">${esc(t.description)}</div>
          <div class="status">${t.done ? 'Done' : 'To-do'}</div>

          <textarea id="${ntId}" class="notes" placeholder="Notes">${t.notes ?? ''}</textarea>

          <div class="photos">
            <label class="small">Add photos</label>
            <input id="${fiId}" type="file" accept="image/*" capture="environment" multiple />
            <div id="${phWrap}" class="thumbs"></div>
          </div>
        </div>
      `;
    }

    /* 9) Event wiring for tasks: checkbox + notes + photos (delegated) */
    roomsEl.addEventListener('change', async (e) => {
      const el = e.target;
      // done checkbox
      if (el.tagName === 'INPUT' && el.type === 'checkbox') {
        const taskEl = el.closest('.task');
        if (!taskEl) return;
        const taskId = taskEl.dataset.taskId;

        // optimistic
        taskEl.querySelector('.status').textContent = el.checked ? 'Done' : 'To-do';

        const { error } = await sb.from('tasks').update({ done: !!el.checked }).eq('id', taskId).single();
        if (error) {
          el.checked = !el.checked;
          taskEl.querySelector('.status').textContent = el.checked ? 'Done' : 'To-do';
          alert('Save failed: ' + error.message);
        }
      }

      // file input (photos)
      if (el.tagName === 'INPUT' && el.type === 'file') {
        const taskEl = el.closest('.task');
        if (!taskEl) return;
        const taskId = taskEl.dataset.taskId;
        const files = Array.from(el.files || []);
        if (!files.length) return;

        // upload each
        Promise.all(files.map(f => uploadPhoto(taskId, f)))
          .then(() => refreshThumbnailsForTask(taskId, taskEl))
          .catch(err => alert('Upload failed: ' + err.message));
      }
    });

    // Save notes on blur (use capture to catch textarea blur)
    roomsEl.addEventListener('blur', async (e) => {
      const el = e.target;
      if (!(el.tagName === 'TEXTAREA' && el.classList.contains('notes'))) return;
      const taskEl = el.closest('.task');
      if (!taskEl) return;
      const taskId = taskEl.dataset.taskId;
      const { error } = await sb.from('tasks').update({ notes: el.value }).eq('id', taskId).single();
      if (error) alert('Saving notes failed: ' + error.message);
    }, true);

    /* 10) Storage helpers: upload + list (photos bucket) */
    async function uploadPhoto(taskId, file) {
      const path = `${taskId}/${Date.now()}_${Math.random().toString(36).slice(2)}_${file.name}`;
      const { error } = await sb.storage.from('photos').upload(path, file, {
        cacheControl: '3600',
        upsert: false,
        contentType: file.type || 'image/jpeg'
      });
      if (error) throw error;
    }

    async function listPhotos(taskId) {
      // List all objects under prefix taskId/
      const { data, error } = await sb.storage.from('photos').list(taskId, { limit: 100 });
      if (error) throw error;
      return data || [];
    }

    function publicUrl(path) {
      const { data } = sb.storage.from('photos').getPublicUrl(path);
      return data.publicUrl;
    }

    async function refreshThumbnailsForTask(taskId, taskEl) {
      const wrap = taskEl.querySelector(`#photos_${CSS.escape(taskId)}`);
      if (!wrap) return;
      wrap.innerHTML = '<span class="small">Loading photos…</span>';
      try {
        const files = await listPhotos(taskId);
        if (!files.length) { wrap.innerHTML = '<span class="small">No photos</span>'; return; }
        wrap.innerHTML = files.map(f => {
          const url = publicUrl(`${taskId}/${f.name}`);
          return `<a href="${url}" target="_blank" rel="noopener"><img loading="lazy" src="${url}" alt=""></a>`;
        }).join('');
      } catch (err) {
        wrap.innerHTML = `<span class="small">Photos error: ${esc(err.message)}</span>`;
      }
    }

    async function refreshAllThumbnails(container) {
      const taskEls = Array.from(container.querySelectorAll('.task'));
      for (const t of taskEls) {
        const taskId = t.dataset.taskId;
        await refreshThumbnailsForTask(taskId, t);
      }
    }

    /* Expose render for reuse if you navigate back to a project */
    window.renderFloorsAndRooms = renderFloorsAndRooms;
  })();
  </script>
</body>
</html>
