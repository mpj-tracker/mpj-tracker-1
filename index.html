<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPJ Tracker</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f5f5f5; }
    header { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 1rem; background:#0b5f3b; color:#fff; }
    .card { background:#fff; padding:1rem; margin:1rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .progress { height:8px; background:#ddd; border-radius:4px; overflow:hidden; }
    .progress span { display:block; height:100%; background:#0b5f3b; }
    .chip { display:inline-block; padding:2px 8px; border-radius:12px; font-size:0.8rem; background:#eee; margin-right:4px; }
    .muted { color:#777; font-size:0.85rem; }
    #diag-wrap { position:fixed; bottom:10px; left:10px; background:#fff; border:1px solid #ccc; padding:0.5rem; border-radius:6px; max-width:320px; }
    #diag { white-space:pre-wrap; font-family:monospace; font-size:0.8rem; }
  </style>
</head>
<body>
  <header>
    <div><strong>MPJ Tracker</strong></div>
    <div id="auth-state">Signed out</div>
  </header>

  <!-- Diagnostics dropdown -->
  <details id="diag-wrap">
    <summary><strong>Diagnostics</strong> (click to open/close)</summary>
    <div id="diag">Ready</div>
  </details>

  <!-- Login -->
  <div id="auth-box" class="card">
    <h3>Login / Sign Up</h3>
    <input id="email" type="email" placeholder="Email"/><br/><br/>
    <input id="password" type="password" placeholder="Password"/><br/><br/>
    <button id="signup-btn">Sign Up</button>
    <button id="login-btn">Log In</button>
    <button id="logout-btn">Sign out</button>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="card" style="display:none">
    <h3>Project Dashboard</h3>
    <input id="project-name" placeholder="Project name"/>
    <button id="use-project">Use Project</button>
    <div id="overall">
      <h4>Overall Progress</h4>
      <div class="progress"><span id="overall-bar" style="width:0%"></span></div>
      <span id="overall-pct">0%</span>
    </div>
    <h4>All Photos</h4>
    <div id="all-photos">No photos yet</div>
    <div id="rooms"></div>
  </div>

<script>
/* ---- Supabase ---- */
const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* ---- DOM ---- */
const authBox = document.getElementById("auth-box");
const dash = document.getElementById("dash");
const authStateEl = document.getElementById("auth-state");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const signupBtn = document.getElementById("signup-btn");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const diag = document.getElementById("diag");

/* ---- Auth ---- */
async function handleAuth(email, password, isSignup) {
  try {
    let result;
    if (isSignup) {
      result = await sb.auth.signUp({ email, password });
      if (result.error && result.error.message.includes("already registered")) {
        result = await sb.auth.signInWithPassword({ email, password });
      }
    } else {
      result = await sb.auth.signInWithPassword({ email, password });
    }
    if (result.error) throw result.error;
    authStateEl.textContent = "Signed in: " + email;
    authBox.style.display = "none";
    dash.style.display = "block";
    diag.textContent = "Login success";
  } catch (err) {
    diag.textContent = "Login error: " + err.message;
    alert("Login error: " + err.message);
  }
}

signupBtn.onclick = ()=>handleAuth(emailInput.value,passwordInput.value,true);
loginBtn.onclick = ()=>handleAuth(emailInput.value,passwordInput.value,false);
logoutBtn.onclick = async ()=>{
  await sb.auth.signOut();
  authBox.style.display="block"; dash.style.display="none";
  authStateEl.textContent="Signed out";
};

/* ---- Placeholder Dashboard logic ---- */
document.getElementById("use-project").onclick = ()=>{
  alert("Project selected: " + document.getElementById("project-name").value);
};
</script>
</body>
</html>
