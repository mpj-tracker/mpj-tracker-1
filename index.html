<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPJ Tracker</title>
<meta name="theme-color" content="#0b5f3b"/>

<style>
:root{
  --brand:#0b5f3b; --text:#113827; --card:#fff; --muted:#7a8a8a;
  --chip:#e1f4e6; --border:#d5e0dc; --bar:#e9efec; --barFill:#1e7a4e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f6;color:var(--text)}
header{position:sticky;top:0;background:#173d2b;color:#fff;border-bottom:1px solid #0c2a1d;z-index:50}
.bar{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:.75rem;padding:.4rem .75rem}
.brand{display:flex;align-items:center;gap:.5rem}
.brand img{height:26px}
.brand b{letter-spacing:.2px}
.pill{background:#1f5d41;color:#fff;border-radius:999px;padding:.25rem .5rem;font-size:.8rem}
main{max-width:1200px;margin:1rem auto;padding:0 .75rem 6rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:.75rem;padding:1rem}
.row{display:flex;align-items:center;gap:.5rem}
.small{font-size:.9rem}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:1rem}
@media(min-width:740px){.grid{grid-template-columns:1fr 1fr}}
.room{border:1px dashed var(--border);border-radius:.75rem;padding:1rem}
h1,h2,h3{margin:.2rem 0 .6rem}
.progress{height:10px;background:var(--bar);border-radius:999px;overflow:hidden}
.progress>span{display:block;height:100%;background:var(--barFill);width:0%}
ul.checks{list-style:none;margin:.4rem 0;padding:0}
ul.checks li{margin:.2rem 0}
.chip{display:inline-block;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:.15rem .45rem;font-size:.78rem}
.thumbs{display:flex;flex-wrap:wrap;gap:.5rem}
.thumb{position:relative;width:120px;aspect-ratio:1;border-radius:.5rem;overflow:hidden;border:1px solid var(--border);background:#f4f6f5}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .btns{position:absolute;inset:auto .25rem .25rem .25rem;display:flex;gap:.25rem;justify-content:space-between}
.btn,button,input,select{font:inherit}
.btn{border:1px solid var(--border);background:#fff;border-radius:.5rem;padding:.35rem .6rem;cursor:pointer}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.danger{background:#fff0f0;border-color:#d88a8a;color:#7a1313}
.btn.ghost{background:#f4fbf7}
#diag-wrap{position:fixed;right:12px;bottom:12px;max-width:420px;z-index:60}
#diag-wrap details summary{cursor:pointer}
#diag{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>

<header>
  <div class="bar">
    <a class="brand" href="#" id="home-link" title="Go to Dashboard">
      <img src="mpj-logo.png" alt="logo"/><b>MPJ Tracker</b>
    </a>
    <div style="flex:1"></div>
    <div id="auth-state" class="pill">Signed out</div>
  </div>
</header>

<main>

  <!-- Diagnostics (tap to open/close) -->
  <div id="diag-wrap">
    <details class="card" id="diag-details">
      <summary><strong>Diagnostics</strong> (click to open/close)</summary>
      <div id="diag" class="small muted">Ready.</div>
      <div class="row small">
        <button class="btn" id="rerun-diag">Re-run tests</button>
        <button class="btn" id="purge-sw">Force clear SW + caches</button>
        <button class="btn" id="direct-test">Direct fetch test</button>
      </div>
    </details>
  </div>

  <!-- Auth -->
  <section id="auth-box" class="card">
    <h2>Login / Sign Up</h2>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" style="min-width:240px"/>
      <input id="password" type="password" placeholder="password"/>
      <button id="signup-btn" class="btn">Sign Up</button>
      <button id="login-btn" class="btn brand">Log In</button>
      <button id="logout-btn" class="btn">Sign out</button>
    </div>
    <div class="small muted">New users can sign up on the same form.</div>
  </section>

  <!-- Project controls -->
  <section id="project-box" class="card" style="display:none">
    <h2>Project</h2>
    <div class="row" style="flex-wrap:wrap; gap:.5rem 1rem">
      <select id="project-select" class="btn" title="Select project" style="min-width:220px"></select>
      <label class="row small muted"><input type="checkbox" id="show-archived-projects"/> Show archived</label>
      <button id="use-project" class="btn brand">Use Selected</button>
      <button id="toggle-archive-btn" class="btn ghost">Archive / Unarchive</button>
      <button id="delete-project" class="btn danger" title="Owner only">Delete Project</button>
    </div>
    <div class="row" style="margin-top:.5rem; gap:.5rem">
      <input id="project-name" placeholder="New project name" style="min-width:220px"/>
      <button id="create-project" class="btn">Create New Project</button>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dash" class="card" style="display:none">
    <h1>Project Dashboard</h1>

    <div class="row" style="gap:.5rem">
      <input id="search" class="btn" placeholder="Filter by room or floor..." style="flex:1;min-width:240px"/>
    </div>

    <div class="card" style="margin-top:.75rem">
      <div class="row" style="justify-content:space-between">
        <strong>Overall Progress</strong><span id="overall-pct" class="small muted">0%</span>
      </div>
      <div id="overall-bar" class="progress"><span></span></div>
    </div>

    <details class="card" style="margin-top:.75rem">
      <summary><strong>All Sign-offs</strong></summary>
      <div id="all-signoffs" class="small muted"></div>
    </details>

    <details id="photos-block" class="card" style="margin-top:.75rem">
      <summary class="row" style="justify-content:space-between">
        <strong>All Photos</strong>
        <span class="row small muted" style="gap:.5rem">
          <label class="row small muted" style="gap:.35rem">
            <input type="checkbox" id="show-archived-photos"/> Show archived
          </label>
          <button id="clear-archived-photos" class="btn danger" title="Permanently delete archived files">Clear Archived Photos</button>
        </span>
      </summary>
      <div id="all-photos" class="thumbs"></div>
    </details>

    <!-- Floors / Rooms / Tasks -->
    <div id="rooms" class="grid"></div>
  </section>
</main>

<script>
(async function () {
  /* ---------- Diagnostics FIRST ---------- */
  const diagEl = document.getElementById('diag');
  const diagLog = (m)=>{ if(diagEl) diagEl.textContent = String(m); console.log('[diag]', m); };

  // Manual quick direct fetch to Supabase Auth settings (to show 200/401 vs network errors)
  document.getElementById('direct-test').onclick = (async ()=>{
    try{
      const r = await fetch(SUPABASE_URL + '/auth/v1/health', { headers:{apikey:SUPABASE_ANON_KEY}});
      alert('Direct fetch OK: ' + r.status);
    }catch(e){ alert('Direct fetch failed: '+e); }
  });

  /* ---------- SW purge ---------- */
  async function purgeServiceWorkers(){
    try{
      if('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
        if (window.caches?.keys){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }
      console.log('[sw] Unregistered and caches cleared');
      diagLog('SW: none');
    }catch(e){ console.warn('[sw] purge failed', e); }
  }
  await purgeServiceWorkers();
  document.getElementById('purge-sw').addEventListener('click', purgeServiceWorkers);

  /* ---------- 1) Supabase client (live project) ---------- */
  // ⚠️ Replace both with your *exact* values (no trailing slashes)
  const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4"; 
  const OWNER_UUID = "f3fb3703-9b24-4323-919e-0738f82cc93f"; /* owner-only actions */

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:false }
  });
  console.log('Supabase client ready');

  /* ---------- 2) DOM refs ---------- */
  const authBox = document.getElementById('auth-box');
  const projectBox= document.getElementById('project-box');
  const dash = document.getElementById('dash');
  const roomsEl = document.getElementById('rooms');
  const authStateEl = document.getElementById('auth-state');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const projectSelect = document.getElementById('project-select');
  const showArchivedProjects = document.getElementById('show-archived-projects');
  const useProjectBtn = document.getElementById('use-project');
  const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
  const deleteProjectBtn = document.getElementById('delete-project');
  const createProjectBtn = document.getElementById('create-project');
  const projectNameInput = document.getElementById('project-name');

  const searchInput = document.getElementById('search');
  const allSignoffsEl = document.getElementById('all-signoffs');
  const allPhotosEl = document.getElementById('all-photos');
  const showArchivedPhotos = document.getElementById('show-archived-photos');
  const clearArchivedPhotosBtn = document.getElementById('clear-archived-photos');
  const overallBar = document.getElementById('overall-bar').firstElementChild;
  const overallPct = document.getElementById('overall-pct');

  const rerunDiagBtn= document.getElementById('rerun-diag');
  document.getElementById('home-link').onclick = (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); };

  /* ---------- 3) Helpers / constants ---------- */
  const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other','Garage','Roof'];
  const safe = s => (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const by = k => (a,b)=> (a[k]||'').localeCompare(b[k]||'');

  const TRADE_DEFS = [
    { name:'Joinery', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Electrical', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Plumbing', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Plasterer', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Decorators', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Tiling', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
    { name:'Specialist', phases:['Measure & survey','First fix','Second fix','Seal & clean','Snagging','Sign off'] },
  ];

  let session=null, currentUser=null, currentProjectId=null;
  let roomsCache=[], tasksCache=[];

  function showAuth(){ authBox.style.display='block'; projectBox.style.display='none'; dash.style.display='none'; }
  function showProject(){ authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='none'; }
  function showApp(){ authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='block'; }

  async function runDiagnostics(){
    try{
      const sw = 'serviceWorker' in navigator ? 'present' : 'none';
      const { data } = await sb.auth.getSession();
      diagLog(`SW: ${sw} | Auth session: ${data.session?'OK':'none'}`);
    }catch(e){ diagLog(`Error: ${e?.message||e}`); }
  }
  rerunDiagBtn.addEventListener('click', runDiagnostics);

  /* ---------- 4) Auth ---------- */
  signupBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value || '';
    if(!email || !pw) return alert('Please enter email and password');
    // probe
    try{
      await fetch(SUPABASE_URL+'/auth/v1/settings', {headers:{apikey:SUPABASE_ANON_KEY}});
    }catch(e){
      return alert(
        `Login probe could not reach Supabase.\n\nReason:\n${e}\n\nCheck:\n` +
        `• Project URL exact: ${SUPABASE_URL}\n• Internet / VPN / Wi-Fi login page\n` +
        `• Ad-block / tracking protection off for this site\n• Supabase Auth enabled\n• CORS Hardening not blocking your Netlify domain`
      );
    }
    const { error } = await sb.auth.signUp({ email, password:pw });
    if(error){
      if(/already/i.test(error.message)) return alert('Sign up failed: User already registered');
      return alert('Sign up failed: '+error.message);
    }
    alert('Sign up OK. Check your inbox if confirmation is required.');
  });

  loginBtn.addEventListener('click', async ()=>{
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value || '';
    if(!email || !pw) return alert('Please enter email and password');
    try{
      await fetch(SUPABASE_URL+'/auth/v1/settings', {headers:{apikey:SUPABASE_ANON_KEY}});
    }catch(e){
      return alert(
        `Login probe could not reach Supabase.\n\nReason:\nAuth probe failed: ${e}\n\nCheck:\n` +
        `• Project URL exact: ${SUPABASE_URL}\n• Internet / VPN / Wi-Fi login page\n` +
        `• Ad-block / tracking protection off for this site\n• Supabase Auth enabled\n• CORS Hardening not blocking your Netlify domain`
      );
    }
    const { error } = await sb.auth.signInWithPassword({ email, password:pw });
    if(error) return alert('Login error: '+error.message);
  });

  logoutBtn.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

  sb.auth.onAuthStateChange(async (_evt, s)=>{
    session = s; currentUser = s?.user || null;
    authStateEl.textContent = currentUser ? `Signed in: ${currentUser.email}` : 'Signed out';
    if(currentUser){ await loadProjects(); showProject(); }
    else{ currentProjectId=null; showAuth(); }
  });

  /* ---------- 5) Projects (no address anywhere) ---------- */
  async function loadProjects(){
    const { data, error } = await sb
      .from('projects')
      .select('id,name,is_archived')
      .eq('user_id', currentUser.id)
      .order('created_at',{ascending:false});
    if(error) { alert(error.message); return; }
    const showA = showArchivedProjects.checked;
    const list = (data||[]).filter(p => showA ? true : !p.is_archived);
    projectSelect.innerHTML = list.map(p => `<option value="${p.id}">${safe(p.name)}${p.is_archived?' (archived)':''}</option>`).join('') || `<option value="">No projects yet</option>`;
  }
  showArchivedProjects.addEventListener('change', loadProjects);

  createProjectBtn.addEventListener('click', async ()=>{
    const name = (projectNameInput.value||'').trim();
    if(!name) return alert('Enter a project name first');
    const { data, error } = await sb.from('projects').insert({ name }).select('id,name').single();
    if(error) return alert(error.message);
    projectNameInput.value='';
    await loadProjects();
    projectSelect.value = data.id;
    await useSelectedProject();
  });

  useProjectBtn.addEventListener('click', async ()=>{ await useSelectedProject(); });

  async function useSelectedProject(){
    const pid = projectSelect.value;
    if(!pid) return alert('Pick a project first');
    currentProjectId = pid;
    await refreshAll();
    showApp();
  }

  toggleArchiveBtn.addEventListener('click', async ()=>{
    const pid = projectSelect.value; if(!pid) return;
    const { data:curr, error:e1 } = await sb.from('projects').select('is_archived').eq('id',pid).single();
    if(e1) return alert(e1.message);
    const { error } = await sb.from('projects').update({ is_archived: !curr.is_archived }).eq('id', pid);
    if(error) return alert(error.message);
    await loadProjects();
  });

  deleteProjectBtn.style.display='none';
  deleteProjectBtn.addEventListener('click', async ()=>{
    if(currentUser?.id !== OWNER_UUID) return alert('Only the owner can delete projects.');
    const pid = projectSelect.value; if(!pid) return;
    if(!confirm('Delete this project and all data? This cannot be undone.')) return;
    // 1) delete signoffs & photos rows
    await sb.from('signoffs').delete().eq('project_id', pid);
    await sb.from('photos').delete().eq('project_id', pid);
    // 2) delete tasks for rooms in project
    const { data:rm } = await sb.from('rooms').select('id').eq('project_id', pid);
    if(rm?.length) await sb.from('tasks').delete().in('room_id', rm.map(r=>r.id));
    // 3) delete rooms then project
    await sb.from('rooms').delete().eq('project_id', pid);
    await sb.from('projects').delete().eq('id', pid);
    await loadProjects();
    roomsEl.innerHTML=''; allPhotosEl.innerHTML=''; overallPct.textContent='0%'; overallBar.style.width='0%';
    alert('Project deleted.');
  });

  /* ---------- 6) Data render & actions ---------- */
  async function refreshAll(){
    await Promise.all([loadAllRooms(), loadProjectPhotos(), loadSignoffs()]);
    recomputeOverall();
  }

  async function loadAllRooms(){
    const { data, error } = await sb
      .from('rooms')
      .select('id,name,floor')
      .eq('project_id', currentProjectId);
    if(error){ alert(error.message); return; }
    roomsCache = (data||[]).sort((a,b)=> FLOOR_ORDER.indexOf(a.floor)-FLOOR_ORDER.indexOf(b.floor) || a.name.localeCompare(b.name));
    await loadTasksForRooms();
    renderRooms();
  }

  async function loadTasksForRooms(){
    const ids = roomsCache.map(r=>r.id);
    if(!ids.length){ tasksCache=[]; return; }
    const { data, error } = await sb
      .from('tasks')
      .select('id,room_id,trade,phase,done,notes')
      .in('room_id', ids);
    if(error){ alert(error.message); return; }
    tasksCache = data||[];
  }

  function renderRooms(){
    const q = (searchInput.value||'').toLowerCase().trim();
    const list = roomsCache.filter(r=>{
      const t = `${r.floor} ${r.name}`.toLowerCase();
      return !q || t.includes(q);
    });

    roomsEl.innerHTML = list.map(r=>{
      const key = r.id;
      // Per-room progress
      const roomTasks = tasksCache.filter(t=>t.room_id===key);
      const total = TRADE_DEFS.reduce((acc,td)=> acc+td.phases.length, 0);
      const done = roomTasks.filter(t=>t.done).length;
      const pct = total? Math.round(100*done/total):0;

      return `
      <div class="room" data-room="${key}">
        <div class="row" style="justify-content:space-between">
          <h3>${safe(r.name)} <span class="muted small">(${safe(r.floor)})</span></h3>
          <span class="small muted">${pct}%</span>
        </div>
        <div class="progress" style="margin:.25rem 0 .75rem"><span style="width:${pct}%"></span></div>

        ${TRADE_DEFS.map(td=>{
          const tkey = td.name;
          const checks = td.phases.map(ph=>{
            const hit = roomTasks.find(x=> x.trade===tkey && x.phase===ph);
            const checked = hit?.done ? 'checked' : '';
            const tid = hit?.id || '';
            return `<li>
              <label class="row small">
                <input type="checkbox" data-room="${key}" data-trade="${tkey}" data-phase="${safe(ph)}" data-task="${tid}" ${checked}/>
                ${safe(ph)}
              </label>
            </li>`;
          }).join('');
          // Notes (one per trade per room)
          const noteRow = roomTasks.find(x=> x.trade===tkey && x.phase===td.phases[0]);
          const notesVal = noteRow?.notes || '';
          return `
            <div style="border:1px solid var(--border);border-radius:.5rem;padding:.5rem;margin:.5rem 0">
              <span class="chip">${safe(tkey)}</span>
              <ul class="checks">${checks}</ul>
              <div class="small muted">Notes</div>
              <textarea class="btn" data-notes-for="${key}::${tkey}" rows="2" style="width:100%">${safe(notesVal)}</textarea>
              <div class="row" style="margin-top:.5rem;gap:.5rem">
                <input type="file" data-upload-for="${key}::${tkey}" accept="image/*" capture="environment"/>
                <button class="btn" data-signoff="${key}::${tkey}">Sign off</button>
              </div>
              <div class="thumbs" data-thumbs="${key}::${tkey}"></div>
            </div>
          `;
        }).join('')}
      </div>`;
    }).join('');

    // bind checkbox change
    roomsEl.querySelectorAll('input[type="checkbox"][data-task]').forEach(cb=>{
      cb.addEventListener('change', onTaskToggle);
    });
    // bind notes
    roomsEl.querySelectorAll('textarea[data-notes-for]').forEach(ta=>{
      ta.addEventListener('change', onNotesChange);
    });
    // bind upload
    roomsEl.querySelectorAll('input[type="file"][data-upload-for]').forEach(inp=>{
      inp.addEventListener('change', onPhotoUpload);
    });
    // bind signoff button
    roomsEl.querySelectorAll('button[data-signoff]').forEach(btn=>{
      btn.addEventListener('click', onSignoff);
    });

    renderRoomThumbs(); // thumbnails per room/trade
  }

  async function onTaskToggle(e){
    const cb = e.currentTarget;
    const roomId = cb.getAttribute('data-room');
    const trade = cb.getAttribute('data-trade');
    const phase = cb.getAttribute('data-phase');
    const existingId = cb.getAttribute('data-task');

    if(existingId){
      const { error } = await sb.from('tasks').update({ done: cb.checked }).eq('id', existingId);
      if(error) return alert(error.message);
      const t = tasksCache.find(x=>x.id===existingId); if(t) t.done = cb.checked;
    }else{
      // first create rows for all phases for this trade (if missing), then toggle this one
      const defs = TRADE_DEFS.find(t=>t.name===trade).phases;
      const missing = defs
        .filter(ph => !tasksCache.find(x=> x.room_id===roomId && x.trade===trade && x.phase===ph))
        .map(ph => ({ project_id: currentProjectId, room_id: roomId, trade: trade, phase: ph, done:false, notes:null }));
      if(missing.length){
        const { data, error } = await sb.from('tasks').insert(missing).select('id,room_id,trade,phase,done,notes');
        if(error) return alert(error.message);
        tasksCache = tasksCache.concat(data);
      }
      const hit = tasksCache.find(x=> x.room_id===roomId && x.trade===trade && x.phase===phase);
      if(hit){
        const { error } = await sb.from('tasks').update({ done: cb.checked }).eq('id', hit.id);
        if(error) return alert(error.message);
        hit.done = cb.checked;
        cb.setAttribute('data-task', hit.id);
      }
    }
    recomputeOverall();
    // refresh room header pct bar quickly
    renderRooms();
  }

  async function onNotesChange(e){
    const ta = e.currentTarget;
    const [roomId, trade] = ta.getAttribute('data-notes-for').split('::');
    // store notes on the first phase row for that trade (create if missing)
    let row = tasksCache.find(x=> x.room_id===roomId && x.trade===trade && x.phase===TRADE_DEFS.find(t=>t.name===trade).phases[0]);
    if(!row){
      const { data, error } = await sb.from('tasks').insert({ project_id: currentProjectId, room_id: roomId, trade, phase: TRADE_DEFS.find(t=>t.name===trade).phases[0], done:false, notes: ta.value }).select().single();
      if(error) return alert(error.message);
      tasksCache.push(data);
    }else{
      const { error } = await sb.from('tasks').update({ notes: ta.value }).eq('id', row.id);
      if(error) return alert(error.message);
      row.notes = ta.value;
    }
  }

  async function onSignoff(e){
    const [roomId, trade] = e.currentTarget.getAttribute('data-signoff').split('::');
    const { error } = await sb.from('signoffs').insert({ project_id: currentProjectId, room_id: roomId, trade, signed_by_name: currentUser.email || 'user' });
    if(error) return alert(error.message);
    await loadSignoffs();
    alert('Signed off');
  }

  async function loadSignoffs(){
    const { data, error } = await sb.from('signoffs').select('id,created_at,trade,phase,rooms(name)').eq('project_id', currentProjectId).order('created_at',{ascending:false});
    if(error){ allSignoffsEl.textContent = 'Error loading sign-offs'; return; }
    allSignoffsEl.innerHTML = (data||[]).map(s=>`
      <div class="row" style="gap:.5rem;padding:.25rem 0;border-bottom:1px solid var(--border)">
        <span class="chip">${safe(s.rooms?.name||'Room')}</span>
        <span class="chip">${safe(s.trade||'Trade')}</span>
        <span class="small muted">${new Date(s.created_at).toLocaleString()}</span>
      </div>
    `).join('') || '<div class="small muted">No sign-offs yet</div>';
  }

  function recomputeOverall(){
    const totals = roomsCache.map(r=>{
      const total = TRADE_DEFS.reduce((acc,td)=> acc+td.phases.length, 0);
      const done = tasksCache.filter(t=> t.room_id===r.id && t.done).length;
      return { total, done };
    }).reduce((a,b)=>({ total:a.total+b.total, done:a.done+b.done }), {total:0,done:0});
    const pct = totals.total ? Math.round(100*totals.done/totals.total) : 0;
    overallPct.textContent = pct+'%';
    overallBar.style.width = pct+'%';
  }

  /* ---------- Photos (project-wide & per trade/room) ---------- */
  function photoPath(roomId, trade, file){
    const name = Date.now()+'_'+file.name.replace(/\s+/g,'_');
    return `${currentProjectId}/${roomId}/${trade}/${name}`;
  }

  async function onPhotoUpload(e){
    const inp = e.currentTarget;
    const file = inp.files?.[0]; if(!file) return;
    const [roomId, trade] = inp.getAttribute('data-upload-for').split('::');
    const path = photoPath(roomId, trade, file);
    const { error: upErr } = await sb.storage.from('photos').upload(path, file, { upsert:false });
    if(upErr) return alert(upErr.message);
    const { error: dbErr } = await sb.from('photos').insert({ project_id: currentProjectId, room_id: roomId, trade, path, archived:false });
    if(dbErr) return alert(dbErr.message);
    await loadProjectPhotos();
    renderRoomThumbs();
    alert('Photo uploaded');
  }

  async function loadProjectPhotos(){
    const { data, error } = await sb
      .from('photos')
      .select('id,room_id,trade,path,archived,created_at')
      .eq('project_id', currentProjectId)
      .order('created_at',{ascending:false});
    if(error){ allPhotosEl.textContent = 'Error loading photos'; return; }

    const showA = showArchivedPhotos.checked;
    const list = (data||[]).filter(p => showA ? true : !p.archived);

    allPhotosEl.innerHTML = list.map(p=>{
      const url = sb.storage.from('photos').getPublicUrl(p.path).data.publicUrl;
      return `
        <div class="thumb" data-photo="${p.id}">
          <img src="${safe(url)}" alt="">
          <div class="btns">
            <button class="btn small ${p.archived?'':'ghost'}" data-arch="${p.id}">${p.archived?'Unarchive':'Archive'}</button>
            <button class="btn small danger" data-del="${p.id}">Delete</button>
          </div>
        </div>`;
    }).join('') || '<div class="small muted">No photos yet</div>';

    // bind buttons
    allPhotosEl.querySelectorAll('button[data-arch]').forEach(b=> b.addEventListener('click', onPhotoArchiveToggle));
    allPhotosEl.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', onPhotoDelete));
  }
  showArchivedPhotos.addEventListener('change', loadProjectPhotos);

  async function onPhotoArchiveToggle(e){
    const id = e.currentTarget.getAttribute('data-arch');
    const { data, error:e1 } = await sb.from('photos').select('archived').eq('id', id).single();
    if(e1) return alert(e1.message);
    const { error } = await sb.from('photos').update({ archived: !data.archived }).eq('id', id);
    if(error) return alert(error.message);
    await loadProjectPhotos();
    renderRoomThumbs();
  }

  async function onPhotoDelete(e){
    const id = e.currentTarget.getAttribute('data-del');
    const { data, error:e1 } = await sb.from('photos').select('path').eq('id', id).single();
    if(e1) return alert(e1.message);
    if(!confirm('Delete this photo permanently?')) return;
    // remove file then row
    await sb.storage.from('photos').remove([data.path]);
    await sb.from('photos').delete().eq('id', id);
    await loadProjectPhotos();
    renderRoomThumbs();
  }

  clearArchivedPhotosBtn.addEventListener('click', async ()=>{
    if(!confirm('Permanently delete *all archived* photos for this project?')) return;
    const { data, error } = await sb.from('photos').select('id,path').eq('project_id', currentProjectId).eq('archived', true);
    if(error) return alert(error.message);
    const paths = (data||[]).map(p=>p.path);
    if(paths.length) await sb.storage.from('photos').remove(paths);
    if(data?.length) await sb.from('photos').delete().in('id', data.map(p=>p.id));
    await loadProjectPhotos();
    renderRoomThumbs();
    alert('Archived photos cleared.');
  });

  function renderRoomThumbs(){
    // Render thumbnails under each trade panel for its room
    const photosElms = roomsEl.querySelectorAll('[data-thumbs]');
    photosElms.forEach(el=>{
      const [roomId, trade] = el.getAttribute('data-thumbs').split('::');
      el.innerHTML = ''; // we’ll lazy-show project photos filtered to this pair
    });
    // load all then fill
    fillRoomThumbs();
  }

  async function fillRoomThumbs(){
    const { data } = await sb.from('photos').select('id,room_id,trade,path,archived,created_at').eq('project_id', currentProjectId).order('created_at',{ascending:false});
    const showA = showArchivedPhotos.checked;
    const list = (data||[]).filter(p => showA ? true : !p.archived);
    const map = new Map();
    list.forEach(p=>{
      const key = `${p.room_id}::${p.trade}`;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(p);
    });

    roomsEl.querySelectorAll('[data-thumbs]').forEach(el=>{
      const key = el.getAttribute('data-thumbs');
      const photos = map.get(key)||[];
      el.innerHTML = photos.slice(0,6).map(p=>{
        const url = sb.storage.from('photos').getPublicUrl(p.path).data.publicUrl;
        return `<div class="thumb"><img src="${safe(url)}" alt=""></div>`;
      }).join('');
    });
  }

  /* ---------- Search ---------- */
  searchInput.addEventListener('input', renderRooms);

  /* ---------- Kick off ---------- */
  await runDiagnostics();
  // Try existing session and show correct section
  const sess = (await sb.auth.getSession()).data.session;
  if(sess){ session=sess; currentUser=sess.user; authStateEl.textContent = `Signed in: ${currentUser.email}`; await loadProjects(); showProject(); }
  else{ showAuth(); }

  // Owner-only button visibility
  const updateOwnerUI = ()=>{ deleteProjectBtn.style.display = currentUser?.id===OWNER_UUID ? 'inline-flex' : 'none'; };
  updateOwnerUI();
  sb.auth.onAuthStateChange((_e, s)=>{ currentUser = s?.user || null; updateOwnerUI(); });

})();
</script>

<!-- Supabase JS CDN (v2) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
