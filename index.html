<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MPJ Tracker</title>

  <!-- Theme / PWA bits -->
  <meta name="theme-color" content="#0b5f3b" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png" />

  <!-- Supabase UMD (no module/CORS issues) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.6/dist/umd/supabase.js"></script>

  <style>
    :root{
      --brand:#0b5f3b;
      --brand-2:#0b5f3b;
      --muted:#f3f4f6;
      --ink:#111827;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;

      /* trade colors */
      --joiners:#16a34a; /* green */
      --plumbers:#2563eb; /* blue */
      --electrical:#dc2626; /* red */
      --plasterer:#7c3aed; /* violet */
      --decorators:#ea580c; /* orange */
      --tiling:#0ea5e9; /* sky */
      --specialist:#6b7280; /* gray */
      --card-bg:#fff;
      --card-br:#e5e7eb;
    }
    * { box-sizing:border-box }
    html,body { height:100% }
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Apple Color Emoji";
      background:#fff;
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:5;
      background:var(--brand);
      color:#fff;
      border-bottom:3px solid var(--brand-2);
    }
    .bar{
      display:flex; align-items:center; gap:.75rem;
      padding:.8rem 1rem; max-width:1200px; margin:0 auto;
    }
    .logo{ height:28px; display:block }
    .brand{ font-weight:700; letter-spacing:.3px }
    .right{ margin-left:auto; font-size:.9rem; opacity:.9 }
    main{ max-width:1200px; margin:0 auto; padding:1rem }

    .grid{ display:grid; gap:1rem }
    @media(min-width:900px){ .grid{ grid-template-columns:repeat(3,1fr) } }

    .card{
      background:var(--card-bg);
      border:1px solid var(--card-br);
      border-radius:14px;
      padding:1rem;
    }
    .row{ display:flex; align-items:center; gap:.5rem }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--card-br); background:#fff; color:var(--ink);
      padding:.5rem .8rem; border-radius:10px; cursor:pointer;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .btn.accent{ background:#fff; border-color:var(--brand); color:var(--brand); font-weight:600 }
    input.input, textarea.input, select.input{
      width:100%; border:1px solid var(--card-br); border-radius:10px; padding:.55rem .7rem; background:#fff;
    }
    textarea.input{ min-height:70px; resize:vertical }
    .small{ font-size:.9rem; opacity:.8 }
    .muted{ color:#6b7280 }
    .hi{ font-weight:700 }

    details.floor>summary,
    details.room>summary,
    details.block>summary{
      list-style:none; cursor:pointer; padding:.8rem 1rem; background:#fff;
      border:1px solid var(--card-br); border-radius:12px;
      display:flex; align-items:center; gap:.75rem;
    }
    details.floor[open]>summary,
    details.room[open]>summary{ border-bottom-left-radius:0; border-bottom-right-radius:0 }

    .tag{ font-size:.75rem; padding:.15rem .45rem; border-radius:999px; background:var(--muted) }

    .progress{ height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden }
    .bar-in{ height:100%; width:0% }

    .trade{
      border:1px dashed var(--card-br); border-radius:12px; padding:.75rem;
      background:#fff; margin:.5rem 0 .75rem;
    }
    .trade-head{ display:flex; justify-content:space-between; align-items:center; gap:.5rem }
    .trade-title{ font-weight:700 }
    .trade-tasks{ display:grid; gap:.5rem; margin-top:.5rem }
    .task-row{ display:grid; grid-template-columns:auto 1fr; gap:.6rem; align-items:start }
    .task-row input[type="checkbox"]{ transform:translateY(3px) }

    .chips{ display:flex; flex-wrap:wrap; gap:.4rem }
    .chip{ font-size:.75rem; padding:.2rem .5rem; border-radius:999px; border:1px solid var(--card-br) }
    .thumbs{ display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:.5rem }
    .thumb{ border:1px solid var(--card-br); border-radius:10px; overflow:hidden; background:#fff }
    .thumb img{ width:100%; height:90px; object-fit:cover; display:block }
    .thumb .cap{ padding:.35rem .45rem; font-size:.75rem }

    /* trade color chips and borders */
    .joiners { --c:var(--joiners) }
    .plumbers { --c:var(--plumbers) }
    .electrical{ --c:var(--electrical) }
    .plasterer { --c:var(--plasterer) }
    .decorators{ --c:var(--decorators) }
    .tiling { --c:var(--tiling) }
    .specialist{ --c:var(--specialist) }
    .trade .trade-title{ color:var(--c) }
    .trade{ border-color: color-mix(in srgb, var(--c) 40%, #e5e7eb) }
    .trade .chip{ border-color: color-mix(in srgb, var(--c) 38%, #e5e7eb); color:var(--c) }

    .kpi{ display:flex; align-items:center; gap:.5rem }
    .kpi .pct{ min-width:36px; text-align:right; font-feature-settings:"tnum" 1, "ss01" 1 }

    .header-row{ display:flex; align-items:center; gap:.75rem; flex-wrap:wrap }
    .header-row .spacer{ flex:1 }
    .danger{ color:var(--bad) }
  </style>
</head>
<body>

  <header>
    <div class="bar">
      <img class="logo" src="/mpj-logo.png" alt="logo" />
      <span class="brand">MPJ Tracker</span>
      <span class="right" id="auth-state">Signed out</span>
    </div>
  </header>

  <main>
    <!-- Auth -->
    <div id="auth-box" class="card" style="display:none">
      <h2 class="hi">Login / Sign Up</h2>
      <p class="small muted">Use your email + password to sign in. New users can sign up on the same form.</p>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <input id="email" class="input" placeholder="Enter your email" />
        <input id="password" class="input" type="password" placeholder="Enter your password" />
      </div>
      <div class="row" style="margin-top:.6rem; gap:.5rem">
        <button id="signup-btn" class="btn">Sign Up</button>
        <button id="login-btn" class="btn">Log In</button>
      </div>
    </div>

    <!-- Project create/use -->
    <div id="project-box" class="card" style="display:none">
      <h2 class="hi">Project</h2>
      <div class="grid" style="grid-template-columns:2fr 2fr auto">
        <input id="project-name" class="input" placeholder="Project name" />
        <input id="project-address" class="input" placeholder="Site address (optional)" />
        <button id="use-project" class="btn accent">Use / Create Project</button>
      </div>
      <p class="small muted" style="margin-top:.3rem">Tip: re-use the same name to open it again later.</p>
    </div>

    <!-- Dashboard (search, global signoffs/photos, overall progress) -->
    <div id="dash" class="card" style="display:none">
      <div class="header-row">
        <h2 class="hi" style="margin:0">Project Dashboard</h2>
        <div class="spacer"></div>
        <button id="logout-btn" class="btn">Sign out</button>
      </div>

      <input id="search" class="input" placeholder="Filter by room, trade, task, or userâ€¦" style="margin:.8rem 0 .6rem" />

      <div class="row" style="gap:1rem; align-items:center">
        <span class="small">Overall Progress</span>
        <div class="progress" style="flex:1">
          <div id="overall-bar" class="bar-in" style="background:var(--ok)"></div>
        </div>
        <span id="overall-pct" class="small pct">0%</span>
      </div>

      <details id="all-signoffs" class="block" style="margin-top:.8rem">
        <summary><strong>All Sign-offs</strong></summary>
        <div id="signoffs-list" class="grid" style="grid-template-columns:1fr"></div>
      </details>

      <details id="photos-block" class="block" style="margin-top:.8rem">
        <summary><strong>All Photos</strong></summary>
        <div id="all-photos" class="thumbs"></div>
      </details>
    </div>

    <!-- Floors / Rooms / Trades / Tasks -->
    <div id="rooms" class="grid" style="grid-template-columns:1fr"></div>

  </main>

  <!-- ======== APP SCRIPT (single block) ======== -->
  <script defer>
  (async function () {
    /* 1) Supabase client */
    const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 2) DOM refs */
    const authBox = document.getElementById('auth-box');
    const projectBox = document.getElementById('project-box');
    const dash = document.getElementById('dash');
    const roomsEl = document.getElementById('rooms');
    const authStateEl = document.getElementById('auth-state');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const projectNameInput = document.getElementById('project-name');
    const projectAddressInput= document.getElementById('project-address');
    const useProjectBtn = document.getElementById('use-project');

    const searchInput = document.getElementById('search');
    const allSignoffsEl = document.getElementById('signoffs-list');
    const allPhotosEl = document.getElementById('all-photos');
    const overallBar = document.getElementById('overall-bar');
    const overallPct = document.getElementById('overall-pct');

    /* 3) Constants */
    const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other'];

    const TRADES = [
      { key:'Joiners', color:'var(--joiners)', tasks:['First fix','Second fix','Extras'] },
      { key:'Electrical', color:'var(--electrical)',tasks:['First fix','Second fix','Extras'] },
      { key:'Plumbers', color:'var(--plumbers)', tasks:['First fix','Second fix','Extras'] },
      { key:'Plasterer', color:'var(--plasterer)', tasks:['First fix','Second fix','Extras'] },
      { key:'Decorators', color:'var(--decorators)',tasks:['First fix','Second fix','Extras'] },
      { key:'Tiling', color:'var(--tiling)', tasks:['Walls','Floor','Extras'] },
      { key:'Specialist', color:'var(--specialist)',tasks:['Extras'] },
    ];

    /* 4) Session + UI state */
    let session = null;
    let currentProjectId = null;
    let currentUser = null;

    const slugify = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

    function showAuth(){ authBox.style.display='block'; projectBox.style.display='none'; dash.style.display='none'; roomsEl.innerHTML=''; }
    function showProject(){ authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='none'; roomsEl.innerHTML=''; }
    function showApp(){ authBox.style.display='none'; projectBox.style.display='none'; dash.style.display='block'; }

    /* 5) Auth wiring */
    signupBtn.addEventListener('click', async ()=>{
      const email=(emailInput.value||'').trim(), pw=passwordInput.value||'';
      if(!email||!pw) return alert('Please enter email and password');
      const { error } = await sb.auth.signUp({ email, password: pw });
      if(error) return alert(error.message);
      alert('Sign up ok! Check your inbox to confirm (if required).');
    });
    loginBtn.addEventListener('click', async ()=>{
      const email=(emailInput.value||'').trim(), pw=passwordInput.value||'';
      if(!email||!pw) return alert('Please enter email and password');
      const { error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error) return alert(error.message);
    });
    logoutBtn.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

    sb.auth.onAuthStateChange(async (_evt, s) => {
      session = s ?? session;
      const g = await sb.auth.getSession();
      session = g.data.session;
      currentUser = session?.user || null;
      authStateEl.textContent = currentUser ? `Signed in: ${currentUser.email}` : 'Signed out';
      if(currentUser) showProject(); else showAuth();
    });

    // initial
    { const { data } = await sb.auth.getSession(); session = data.session; currentUser = session?.user || null; if(currentUser) showProject(); else showAuth(); }

    /* 6) Use/Create project (+ auto seed rooms & tasks if empty) */
    useProjectBtn.addEventListener('click', async ()=>{
      const name = (projectNameInput.value||'').trim();
      const addr = (projectAddressInput.value||'').trim();
      if(!name) return alert('Enter a project name');

      // find existing for this user
      const { data: existing, error: findErr } = await sb
        .from('projects').select('id').eq('user_id', currentUser.id).ilike('name', name).limit(1);
      if(findErr) return alert(findErr.message);

      if(existing?.length){
        currentProjectId = existing[0].id;
      } else {
        const { data: ins, error: insErr } = await sb
          .from('projects')
          .insert({ name, site_address: addr, user_id: currentUser.id })
          .select('id').single();
        if(insErr) return alert(insErr.message);
        currentProjectId = ins.id;
      }

      // auto-seed rooms if none:
      const { data: roomCount, error: rcErr } = await sb.from('rooms').select('id', { count:'exact', head:true }).eq('project_id', currentProjectId);
      if(rcErr) console.warn(rcErr);
      if(!roomCount || roomCount.count === 0){
        await seedRoomsAndTasks(currentProjectId);
      }

      showApp();
      await renderAll();
    });

    async function seedRoomsAndTasks(pid){
      // seed rooms
      const ROOM_SETS = {
        'Basement': ['Lobby','Bar','Cinema','Gym','Plant room','Safe room','Steam room','Utility room','WC','Treatment room','Treatment room 2','Wine room'],
        'Ground Floor': ['Lobby','Living room','Dining room','Kitchen','WC','Store','Annex kitchenette','Annex ensuite','Annex Bedroom'],
        '1st Floor': ['Lobby','Bedroom 3','Bedroom 3 ensuite','Bedroom 4','Bedroom 4 ensuite','Bedroom 5','Bedroom 5 ensuite','Bedroom 6','Bedroom 6 ensuite'],
        '2nd Floor': ['Lobby','Bedroom 1','Bedroom 1 ensuite','Bedroom 1 dresser','Bedroom 2','Bedroom 2 ensuite','Bedroom 2 dresser','Rod office','Sheila office'],
        'Other': []
      };

      const roomsToInsert = [];
      for(const floor of FLOOR_ORDER){
        (ROOM_SETS[floor]||[]).forEach(room_name=>{
          roomsToInsert.push({ project_id: pid, floor_name: floor, room_name });
        });
      }
      if(roomsToInsert.length){
        const { error: rErr } = await sb.from('rooms').insert(roomsToInsert);
        if(rErr) console.warn('Seed rooms error:', rErr.message);
      }

      // seed default tasks for each room (for each trade)
      const { data: rooms, error } = await sb.from('rooms').select('id, floor_name, room_name').eq('project_id', pid);
      if(error) return console.warn(error.message);
      const taskRows = [];
      for(const r of rooms){
        for(const t of TRADES){
          for(const tk of t.tasks){
            taskRows.push({ room_id: r.id, trade: t.key, task: tk, done: false, notes: '' });
          }
        }
      }
      if(taskRows.length){
        const { error: tErr } = await sb.from('tasks').insert(taskRows);
        if(tErr) console.warn('Seed tasks error:', tErr.message);
      }
    }

    /* 7) Rendering */
    async function renderAll(){
      await Promise.all([
        renderFloorsAndRooms(),
        renderSignoffs(),
        renderAllPhotos(),
        computeOverallProgress()
      ]);
    }

    async function renderFloorsAndRooms(){
      roomsEl.innerHTML = '';
      // fetch rooms
      const { data: rooms, error } = await sb
        .from('rooms')
        .select('id, floor_name, room_name')
        .eq('project_id', currentProjectId);
      if(error){ roomsEl.textContent = error.message; return; }

      // group by floor in desired order
      const byFloor = new Map();
      for(const f of FLOOR_ORDER) byFloor.set(f, []);
      for(const r of rooms){
        if(!byFloor.has(r.floor_name)) byFloor.set(r.floor_name, []);
        byFloor.get(r.floor_name).push(r);
      }
      // sort rooms alpha
      for(const [k, arr] of byFloor) arr.sort((a,b)=>a.room_name.localeCompare(b.room_name));

      for(const floor of FLOOR_ORDER){
        const floorRooms = byFloor.get(floor) || [];
        const floorDetails = document.createElement('details');
        floorDetails.className = 'floor';
        floorDetails.open = false;

        const floorSummary = document.createElement('summary');
        const floorTitle = document.createElement('span');
        floorTitle.className='hi';
        floorTitle.textContent = floor;

        const floorKpi = document.createElement('span');
        floorKpi.className = 'kpi small';
        floorKpi.style.marginLeft = 'auto';
        const floorPct = document.createElement('span'); floorPct.className='pct'; floorPct.textContent='0%';
        const floorProg = document.createElement('div'); floorProg.className='progress'; floorProg.style.width='220px';
        const floorBar = document.createElement('div'); floorBar.className='bar-in'; floorBar.style.background='var(--ok)';
        floorProg.appendChild(floorBar);

        floorKpi.append(floorProg, floorPct);
        floorSummary.append(floorTitle, floorKpi);
        floorDetails.appendChild(floorSummary);

        // room list container
        const wrap = document.createElement('div'); wrap.className='grid'; wrap.style.gridTemplateColumns='1fr';
        floorDetails.appendChild(wrap);

        roomsEl.appendChild(floorDetails);

        for(const room of floorRooms){
          const roomDetails = document.createElement('details');
          roomDetails.className='room'; roomDetails.open=false;

          const sum = document.createElement('summary');
          sum.innerHTML = `<strong>${room.room_name}</strong>`;
          // room kpi
          const rk = document.createElement('span'); rk.className='kpi small'; rk.style.marginLeft='auto';
          const rpct = document.createElement('span'); rpct.className='pct'; rpct.textContent='0%';
          const rprog = document.createElement('div'); rprog.className='progress'; rprog.style.width='180px';
          const rbar = document.createElement('div'); rbar.className='bar-in'; rbar.style.background='var(--ok)';
          rprog.appendChild(rbar); rk.append(rprog, rpct);
          sum.appendChild(rk);
          roomDetails.appendChild(sum);

          // content div
          const content = document.createElement('div'); content.className='card'; content.style.marginTop='-1px';
          roomDetails.appendChild(content);
          wrap.appendChild(roomDetails);

          // render trades/tasks for this room
          await renderRoomTrades(room, content);

          // compute room progress initially
          await computeRoomProgress(room.id, rbar, rpct);

          // re-compute floor progress when room toggles (lazy approach)
          roomDetails.addEventListener('toggle', async ()=>{ await computeFloorProgress(floor, floorBar, floorPct); });
        }

        // compute initial floor progress
        await computeFloorProgress(floor, floorBar, floorPct);
      }
    }

    async function renderRoomTrades(room, container){
      container.innerHTML = '';
      // fetch tasks for room grouped by trade
      const { data: rows, error } = await sb
        .from('tasks')
        .select('id, trade, task, done, notes')
        .eq('room_id', room.id)
        .order('trade', { ascending:true })
        .order('task', { ascending:true });
      if(error){ container.textContent = 'Tasks error: '+error.message; return; }

      const group = rows.reduce((m, r)=>{ (m[r.trade] ||= []).push(r); return m; }, {});
      for(const trade of TRADES){
        const items = group[trade.key] || [];
        if(items.length === 0) continue;

        const tdiv = document.createElement('div');
        tdiv.className = `trade ${trade.key.toLowerCase()}`;

        const head = document.createElement('div');
        head.className = 'trade-head';
        head.innerHTML = `<span class="trade-title">${trade.key}</span>`;
        const signBtn = document.createElement('button');
        signBtn.className='btn'; signBtn.textContent='Sign off trade';
        head.appendChild(signBtn);
        tdiv.appendChild(head);

        const list = document.createElement('div');
        list.className='trade-tasks';

        for(const item of items){
          const row = document.createElement('div');
          row.className='task-row';

          const cb = document.createElement('input');
          cb.type='checkbox'; cb.checked=!!item.done;

          const right = document.createElement('div');
          right.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div><strong>${item.task}</strong></div>
              <span class="chip">${trade.key}</span>
            </div>
            <label class="small muted">Notes</label>
            <textarea class="input" placeholder="Add notesâ€¦">${item.notes||''}</textarea>
            <div class="row" style="gap:.5rem; margin-top:.35rem">
              <input type="file" accept="image/*" capture="environment" />
              <button class="btn small" type="button">Upload</button>
            </div>
            <div class="thumbs" data-thumbs="${item.id}"></div>
          `;

          // events
          cb.addEventListener('change', async ()=>{
            await sb.from('tasks').update({ done: cb.checked, updated_at: new Date().toISOString() }).eq('id', item.id);
            await computeRoomProgress(room.id); // refresh bars
            await computeFloorProgress(room.floor_name);
            await computeOverallProgress();
            // refresh sign-off button state
            await toggleSignButton();
          });

          const ta = right.querySelector('textarea');
          ta.addEventListener('change', async ()=>{
            await sb.from('tasks').update({ notes: ta.value, updated_at: new Date().toISOString() }).eq('id', item.id);
          });

          const fi = right.querySelector('input[type=file]');
          const up = right.querySelector('button.btn.small');
          up.addEventListener('click', async ()=>{
            if(!fi.files?.length) return alert('Choose a photo first');
            const file = fi.files[0];
            const path = `${currentProjectId}/${room.id}/${item.id}/${Date.now()}-${file.name}`;
            const { error: upErr } = await sb.storage.from('photos').upload(path, file, {
              upsert:true, contentType:file.type, metadata:{
                uploaded_by: currentUser.email, project_id: currentProjectId, room_id: room.id, task_id: item.id
              }
            });
            if(upErr) return alert(upErr.message);
            await loadTaskThumbs(item.id);
            await renderAllPhotos(); // dashboard
          });

          row.appendChild(cb);
          row.appendChild(right);
          list.appendChild(row);

          // initial thumbs
          await loadTaskThumbs(item.id);
        }

        // enable/disable sign button based on completion
        async function toggleSignButton(){
          const { data: chk } = await sb.from('tasks').select('done').eq('room_id', room.id).eq('trade', trade.key);
          const total = chk?.length||0, done = (chk||[]).filter(x=>x.done).length;
          signBtn.disabled = !(total>0 && done===total);
        }
        await toggleSignButton();

        signBtn.addEventListener('click', async ()=>{
          const note = prompt(`Sign off ${trade.key} in ${room.room_name}. Add a note (optional):`) || '';
          const { error: sErr } = await sb.from('signoffs').insert({
            project_id: currentProjectId, room_id: room.id, trade: trade.key,
            signed_by: currentUser.id, signed_by_email: currentUser.email,
            note, signed_at: new Date().toISOString()
          });
          if(sErr) return alert(sErr.message);
          signBtn.disabled = true;
          await renderSignoffs();
        });

        container.appendChild(tdiv);
      }
    }

    async function loadTaskThumbs(taskId){
      // list objects where metadata.task_id = taskId (via storage.objects table)
      const { data, error } = await sb
        .from('storage.objects')
        .select('id, name, updated_at, metadata')
        .eq('bucket_id','photos')
        .contains('metadata', { task_id: taskId });
      const holder = document.querySelector(`[data-thumbs="${taskId}"]`);
      if(!holder) return;
      holder.innerHTML='';
      if(error || !data?.length){ holder.innerHTML='<span class="small muted">No photos</span>'; return; }
      for(const o of data){
        const { data: url } = sb.storage.from('photos').getPublicUrl(o.name);
        const card = document.createElement('div'); card.className='thumb';
        const by = (o.metadata?.uploaded_by)||'';
        const when = new Date(o.updated_at).toLocaleString();
        card.innerHTML = `<img src="${url.publicUrl}" alt="">
          <div class="cap small">${by ? by+' Â· ' : ''}${when}</div>`;
        holder.appendChild(card);
      }
    }

    async function renderSignoffs(){
      allSignoffsEl.innerHTML='';
      const { data, error } = await sb
        .from('signoffs')
        .select('id, room_id, trade, note, signed_by_email, signed_at, rooms!inner(room_name, floor_name)')
        .eq('project_id', currentProjectId)
        .order('signed_at',{ascending:false});
      if(error){ allSignoffsEl.textContent=error.message; return; }
      if(!data?.length){ allSignoffsEl.innerHTML='<div class="small muted">No sign-offs yet.</div>'; return; }
      for(const r of data){
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div><strong>${r.rooms?.floor_name || ''} â€” ${r.rooms?.room_name || ''}</strong></div>
            <span class="chip">${r.trade}</span>
          </div>
          <div class="small muted">${new Date(r.signed_at).toLocaleString()} Â· ${r.signed_by_email||''}</div>
          ${r.note ? `<div class="small" style="margin-top:.4rem">${r.note}</div>` : ``}
        `;
        allSignoffsEl.appendChild(div);
      }
    }

    async function renderAllPhotos(){
      allPhotosEl.innerHTML='';
      // show last 50 project photos
      const { data, error } = await sb
        .from('storage.objects')
        .select('name, updated_at, metadata')
        .eq('bucket_id','photos')
        .contains('metadata',{ project_id: currentProjectId })
        .order('updated_at',{ascending:false})
        .limit(50);
      if(error){ allPhotosEl.textContent = error.message; return; }
      if(!data?.length){ allPhotosEl.innerHTML='<div class="small muted">No photos yet.</div>'; return; }
      for(const o of data){
        const { data: url } = sb.storage.from('photos').getPublicUrl(o.name);
        const div = document.createElement('div'); div.className='thumb';
        const cap = `${o.metadata?.uploaded_by||''} Â· ${new Date(o.updated_at).toLocaleString()}`;
        div.innerHTML = `<img src="${url.publicUrl}" alt=""><div class="cap small">${cap}</div>`;
        allPhotosEl.appendChild(div);
      }
    }

    /* 8) Progress */
    async function computeRoomProgress(roomId, barEl, pctEl){
      const { data, error } = await sb.from('tasks').select('done').eq('room_id', roomId);
      if(error||!data){ if(barEl) barEl.style.width='0%'; if(pctEl) pctEl.textContent='0%'; return 0; }
      const total = data.length, done = data.filter(x=>x.done).length;
      const pct = total? Math.round((done/total)*100):0;
      if(barEl) barEl.style.width = pct+'%';
      if(pctEl) pctEl.textContent = pct+'%';
      return { total, done, pct };
    }
    async function computeFloorProgress(floorName, barEl, pctEl){
      const { data: rooms } = await sb.from('rooms').select('id').eq('project_id', currentProjectId).eq('floor_name', floorName);
      let sumDone=0, sumTotal=0;
      for(const r of (rooms||[])){
        const { data: ts } = await sb.from('tasks').select('done').eq('room_id', r.id);
        sumTotal += ts?.length||0; sumDone += (ts||[]).filter(x=>x.done).length;
      }
      const pct = sumTotal? Math.round(100*sumDone/sumTotal):0;
      if(barEl) barEl.style.width=pct+'%';
      if(pctEl) pctEl.textContent=pct+'%';
      return pct;
    }
    async function computeOverallProgress(){
      const { data } = await sb
        .from('rooms').select('id').eq('project_id', currentProjectId);
      let done=0, total=0;
      for(const r of (data||[])){
        const { data: ts } = await sb.from('tasks').select('done').eq('room_id', r.id);
        total += ts?.length||0; done += (ts||[]).filter(x=>x.done).length;
      }
      const pct = total? Math.round(100*done/total):0;
      overallBar.style.width = pct+'%';
      overallPct.textContent = pct+'%';
    }

    /* 9) Search filter (client-side) */
    searchInput.addEventListener('input', ()=>{
      const q = slugify(searchInput.value);
      const rooms = roomsEl.querySelectorAll('details.room');
      rooms.forEach(r=>{
        const text = slugify(r.textContent);
        r.style.display = text.includes(q) ? '' : 'none';
      });
    });

    // kick first render if already signed in and project chosen previously (optional: you can persist projectId in localStorage)
    // localStorage restore (optional)
    try{
      const saved = localStorage.getItem('mpj_last_project');
      if(saved && currentUser){
        currentProjectId = saved;
        showApp();
        renderAll();
      }
    }catch(e){}

    // save current projectId whenever it changes
    const _setPid = (pid)=>{ try{ localStorage.setItem('mpj_last_project', pid||'') }catch(e){} };

    // observe currentProjectId set
    Object.defineProperty(window, 'currentProjectId', {
      set(v){ _setPid(v); return v; },
      get(){ return currentProjectId; }
    });

  })();
  </script>
</body>
</html>
