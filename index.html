<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPJ Tracker</title>

  <!-- Theme / PWA bits -->
  <meta name="theme-color" content="#0b5f3b"/>
  <link rel="manifest" href="/manifest.webmanifest?v=1"/>

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png"/>

<!-- Supabase UMD (global) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>

  <style>
    :root{
      --brand:#0b5f3b; --accent:#0b5f3b; --muted:#f3f6f6; --text:#111827; --card:#ffffff;
      --joinery:#198754; --plumbing:#0d6efd; --electrical:#dc3545; --plasterer:#6f42c1; --decorators:#fd7e14;
      --tiling:#8b5e3c; --special:#20c997; --chip:#eceff1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
      background:#fff;color:var(--text);}
    header{position:sticky;top:0;background:var(--brand);color:#fff;border-bottom:2px solid rgba(0,0,0,.08);z-index:5}
    .bar{max-width:1200px;margin:auto;display:flex;gap:.75rem;align-items:center;padding:.6rem .9rem}
    .brand{display:flex;gap:.6rem;align-items:center}
    .brand img{height:28px;width:auto}
    .pill{margin-left:auto;background:rgba(255,255,255,.15);padding:.3rem .6rem;border-radius:999px;font-size:.85rem}
    main{max-width:1200px;margin:1rem auto;padding:0 .9rem}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:.75rem 0}
    .row{display:flex;gap:.6rem;align-items:center}
    .grid{display:grid;gap:.9rem}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    details{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    details>summary{cursor:pointer;padding:1rem;border-radius:12px;list-style:none}
    details[open]>summary{border-bottom:1px solid #e5e7eb}
    .progress{height:.65rem;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--brand);width:0%}
    .chip{display:inline-flex;align-items:center;gap:.35rem;background:var(--chip);border-radius:999px;padding:.25rem .55rem;font-size:.8rem}
    .muted{color:#6b7280}
    .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:.5rem .8rem;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn.accent{background:var(--brand);color:#fff;border-color:var(--brand)}
    .input{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:.55rem .7rem}
    .trade{border-left:5px solid transparent}
    .trade.joinery{border-color:var(--joinery)}
    .trade.plumbing{border-color:var(--plumbing)}
    .trade.electrical{border-color:var(--electrical)}
    .trade.plasterer{border-color:var(--plasterer)}
    .trade.decorators{border-color:var(--decorators)}
    .trade.tiling{border-color:var(--tiling)}
    .trade.specialist{border-color:var(--special)}
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer}
    .task-line{display:flex;align-items:flex-start;gap:.7rem}
    .task-line .grow{flex:1}
    .right{margin-left:auto}
    .small{font-size:.85rem}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <img src="/mpj-logo.png" alt="logo"/>
      <strong>MPJ Tracker</strong>
    </div>
    <span id="auth-state" class="pill">Signed out</span>
  </div>
</header>

<main>
  <!-- Login / Sign Up -->
  <div id="auth-box" class="card" style="display:none">
    <h2>Login / Sign Up</h2>
    <p class="muted">Use your email + password to sign in. New users can sign up on the same form.</p>
    <div class="row">
      <input id="email" class="input" style="max-width:280px" placeholder="Enter your email"/>
      <input id="password" class="input" style="max-width:200px" type="password" placeholder="Enter your password"/>
      <button id="signup-btn" class="btn">Sign Up</button>
      <button id="login-btn" class="btn">Log In</button>
    </div>
  </div>

  <!-- Project box -->
  <div id="project-box" class="card" style="display:none">
    <h2>Project</h2>
    <div class="row" style="gap:1rem;align-items:end">
      <div style="flex:1">
        <label class="small muted">Project name</label>
        <input id="project-name" class="input" placeholder="Project name"/>
      </div>
      <div style="flex:2">
        <label class="small muted">Site address</label>
        <input id="project-address" class="input" placeholder="Site address (optional)"/>
      </div>
      <div>
        <button id="use-project" class="btn accent">Use / Create Project</button>
      </div>
    </div>
    <p class="small muted" style="margin-top:.5rem">Tip: re-use the same name to open it again later.</p>
  </div>

  <!-- Dashboard -->
  <div id="dash" style="display:none">
    <div class="card">
      <h2>Project Dashboard</h2>
      <input id="search" class="input" placeholder="Filter by room, trade, phase, or user…" style="max-width:460px;margin:.5rem 0"/>
      <div class="row" style="gap:1rem">
        <div class="card" style="flex:1">
          <details id="signoffs-block">
            <summary><strong>All Sign-offs</strong></summary>
            <div class="small muted" style="margin:.25rem 0">Room • Trade • Phase • Signed by • When</div>
            <div id="all-signoffs"></div>
          </details>
        </div>
        <div class="card" style="flex:1">
          <details id="photos-block">
            <summary><strong>All Photos</strong></summary>
            <div id="all-photos" class="thumbs"></div>
          </details>
        </div>
      </div>

      <div class="row" style="gap:1rem;align-items:center;margin:.5rem 0">
        <strong>Overall Progress</strong>
        <div class="progress" style="flex:1;max-width:540px"><span id="overall-bar"></span></div>
        <span id="overall-pct" class="small muted">0%</span>
        <button id="logout-btn" class="btn right">Sign out</button>
      </div>
    </div>
  </div>

  <!-- Floors / Rooms / Tasks -->
  <div id="rooms" class="grid"></div>
</main>

  
<script defer
  src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
 
<script defer>
(async function () {
/* =========================
   1) Supabase client
   ========================= */
const SUPABASE_URL = "https://zpnqruthpknncpilztxf.supabase.co";
const SUPABASE_ANON_KEY= "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhc2UifQ.DUMMY_REDACTED_KEEP_YOURS"; // keep your current anon key here
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   2) DOM refs
   ========================= */
const authBox = document.getElementById('auth-box');
const projectBox = document.getElementById('project-box');
const dash = document.getElementById('dash');
const roomsEl = document.getElementById('rooms');
const authStateEl = document.getElementById('auth-state');

const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const signupBtn = document.getElementById('signup-btn');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');

const projectNameInput = document.getElementById('project-name');
const projectAddressInput = document.getElementById('project-address');
const useProjectBtn = document.getElementById('use-project');

const searchInput = document.getElementById('search');
const allSignoffsEl = document.getElementById('all-signoffs');
const allPhotosEl = document.getElementById('all-photos');
const overallBar = document.getElementById('overall-bar');
const overallPct = document.getElementById('overall-pct');

/* =========================
   3) State
   ========================= */
const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other'];
const TRADE_COLORS = {
  joinery: getComputedStyle(document.documentElement).getPropertyValue('--joinery')?.trim() || '#198754',
  plumbing: getComputedStyle(document.documentElement).getPropertyValue('--plumbing')?.trim() || '#0d6efd',
  electrical:getComputedStyle(document.documentElement).getPropertyValue('--electrical')?.trim()|| '#dc3545',
  plasterer: getComputedStyle(document.documentElement).getPropertyValue('--plasterer')?.trim() || '#6f42c1',
  decorators:getComputedStyle(document.documentElement).getPropertyValue('--decorators')?.trim()|| '#fd7e14',
  tiling: getComputedStyle(document.documentElement).getPropertyValue('--tiling')?.trim() || '#6c757d',
  specialist:getComputedStyle(document.documentElement).getPropertyValue('--special')?.trim() || '#20c997',
};

let session = null;
let currentUser = null;
let currentProjectId = null;

/* =========================
   4) Small helpers
   ========================= */
const slug = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();
const byFloorOrder = (a,b)=> FLOOR_ORDER.indexOf(a.floor_name) - FLOOR_ORDER.indexOf(b.floor_name) || a.room_name.localeCompare(b.room_name);
function showAuth(){ authBox.style.display='block'; projectBox.style.display='none'; roomsEl.innerHTML=''; updateOverall(0,0); }
function showProject(){ authBox.style.display='none'; projectBox.style.display='block'; }

function setProgress(el, pct){
  pct = Math.max(0, Math.min(100, Math.round(pct)));
  if(!el) return;
  el.style.setProperty('--pct', pct+'%'); // if your CSS uses a variable
  el.style.background = `linear-gradient(90deg, var(--accent) ${pct}%, var(--muted) ${pct}%)`;
}

function updateOverall(done, total){
  const pct = total ? Math.round(done*100/total) : 0;
  if(overallBar) setProgress(overallBar, pct);
  if(overallPct) overallPct.textContent = pct+'%';
}

/* =========================
   5) AUTH
   ========================= */
signupBtn?.addEventListener('click', async () => {
  const email = (emailInput?.value||'').trim();
  const pw = passwordInput?.value || '';
  if(!email || !pw){ alert('Please enter email and password'); return; }
  const { error } = await sb.auth.signUp({ email, password: pw });
  if(error) return alert(error.message);
  alert('Sign up OK! Check your inbox to confirm (if required).');
});

loginBtn?.addEventListener('click', async () => {
  const email = (emailInput?.value||'').trim();
  const pw = passwordInput?.value || '';
  if(!email || !pw){ alert('Please enter email and password'); return; }
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  if(error) return alert(error.message);
});

logoutBtn?.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

sb.auth.onAuthStateChange(async (_evt, s) => {
  session = s ?? session;
  const g = await sb.auth.getSession();
  session = g.data.session;
  currentUser = session?.user ?? null;
  authStateEl.textContent = currentUser ? `Signed in: ${currentUser.email}` : 'Signed out';
  if(currentUser) showProject(); else showAuth();
});

// initial
{
  const { data } = await sb.auth.getSession();
  session = data.session;
  currentUser = session?.user ?? null;
  authStateEl.textContent = currentUser ? `Signed in: ${currentUser.email}` : 'Signed out';
  if(currentUser) showProject(); else showAuth();
}

/* =========================
   6) Use / Create project (+ auto seed if empty)
   ========================= */
useProjectBtn?.addEventListener('click', async () => {
  const name = (projectNameInput?.value||'').trim();
  const addr = (projectAddressInput?.value||'').trim();
  if(!name){ alert('Enter a project name'); return; }

  // look for an existing project for this user with same name
  const { data: existing, error: findErr } = await sb
    .from('projects').select('id').eq('user_id', currentUser.id).ilike('name', name).limit(1);
  if(findErr) return alert(findErr.message);

  if(existing?.length){
    currentProjectId = existing[0].id;
  }else{
    // create project
    const { data: ins, error: insErr } = await sb
      .from('projects').insert({ name, site_address: addr, user_id: currentUser.id })
      .select('id').single();
    if(insErr) return alert(insErr.message);
    currentProjectId = ins.id;

    // try to seed (rooms + default trade tasks)
    // if you created the helper function in SQL:
    // await sb.rpc('seed_full_project', { p_name: name, p_site: addr }).catch(()=>{});
    // await sb.rpc('seed_trade_tasks_for_project', { p_project_id: currentProjectId }).catch(()=>{});
  }

  await renderFloors(currentProjectId);
});

/* =========================
   7) Render
   ========================= */
searchInput?.addEventListener('input', ()=> renderFloors(currentProjectId));

async function renderFloors(pid){
  if(!pid){ roomsEl.innerHTML=''; updateOverall(0,0); return; }

  const { data: rooms, error: roomsErr } = await sb
    .from('rooms')
    .select('id, floor_name, room_name')
    .eq('project_id', pid)
    .order('floor_name')
    .order('room_name');

  if(roomsErr){ roomsEl.innerHTML = `<p class="muted">Rooms error: ${roomsErr.message}</p>`; return; }

  // get tasks counts per room for progress
  const { data: tasks, error: tasksErr } = await sb
    .from('tasks')
    .select('id, room_id, trade, phase, done, notes');
  if(tasksErr){ roomsEl.innerHTML = `<p class="muted">Tasks error: ${tasksErr.message}</p>`; return; }

  const q = slug(searchInput?.value||'');
  const sorted = [...rooms].sort(byFloorOrder).filter(r=>{
    const t = `${r.floor_name} ${r.room_name}`;
    return !q || slug(t).includes(q);
  });

  let overallDone = 0, overallTotal = 0;

  // Build floor groups
  const byFloor = {};
  for(const r of sorted){
    byFloor[r.floor_name] ||= [];
    byFloor[r.floor_name].push(r);
  }

  roomsEl.innerHTML = '';
  for(const floor of FLOOR_ORDER){
    const group = byFloor[floor] || [];
    if(group.length===0) continue;

    // floor wrapper
    const floorWrap = document.createElement('div');
    floorWrap.className = 'card';
    floorWrap.style.marginBottom = '1rem';

    // floor header (collapsible)
    const sum = document.createElement('summary');
    sum.innerHTML = `<strong>${floor}</strong> <span class="small muted" id="f-${floor}-pct">0%</span>`;
    const details = document.createElement('details');
    details.appendChild(sum);
    floorWrap.appendChild(details);

    let floorDone = 0, floorTotal = 0;

    // per room
    for(const r of group){
      const rTasks = tasks.filter(t=>t.room_id === r.id);
      floorTotal += rTasks.length;
      floorDone += rTasks.filter(t=>t.done).length;

      // room block
      const roomCard = document.createElement('div');
      roomCard.className = 'card';
      roomCard.style.margin = '.5rem 0';
      roomCard.innerHTML = `
        <details>
          <summary>
            <span><strong>${r.room_name}</strong> <span class="small muted">${floor} • ${rTasks.filter(t=>t.done).length}/${rTasks.length}</span></span>
            <span class="progress small" style="width:160px"><span class="bar"></span></span>
          </summary>
          <div class="room-content"></div>
        </details>
      `;
      details.appendChild(roomCard);

      // set initial room progress
      const bar = roomCard.querySelector('.bar');
      const rpct = rTasks.length ? Math.round(rTasks.filter(t=>t.done).length*100/rTasks.length) : 0;
      if(bar){ bar.style.width = rpct+'%'; }

      // fill content
      fillRoom(r, rTasks, roomCard.querySelector('.room-content'));
    }

    // update floor pct
    const floorPct = floorTotal ? Math.round(floorDone*100/floorTotal) : 0;
    floorWrap.querySelector(`#f-${floor}-pct`).textContent = `${floorPct}%`;

    roomsEl.appendChild(floorWrap);
    overallDone += floorDone; overallTotal += floorTotal;
  }

  updateOverall(overallDone, overallTotal);

  // dashboard lists (signoffs + photos)
  await renderDashboard(pid);
}

/* =========================
   8) Room builder (trades, phases, notes, photos, sign-off)
   ========================= */
const TRADE_PHASES = {
  joinery: ['First fix','Second fix','Extras'],
  electrical: ['First fix','Second fix','Extras'],
  plumbing: ['First fix','Second fix','Extras'],
  plasterer: ['First fix','Second fix','Extras'],
  decorators: ['First fix','Second fix','Extras'],
  tiling: ['Walls','Floor','Extras'],
  specialist: ['Extras']
};

function tradeKey(t){ return slug(t).replace(/\s/g,''); }

function fillRoom(room, rTasks, container){
  const byTrade = {};
  for(const t of rTasks){
    const key = tradeKey(t.trade||'other');
    byTrade[key] ||= { label: t.trade||'Other', items: [] };
    byTrade[key].items.push(t);
  }

  // ensure all trades exist even if 0 tasks (so user can add notes/photos/signoffs)
  for(const t in TRADE_PHASES){
    byTrade[t] = byTrade[t] || { label: t, items: [] };
  }

  container.innerHTML = '';
  for(const tKey of Object.keys(byTrade)){
    const trade = byTrade[tKey];
    const color = TRADE_COLORS[tKey] || 'var(--muted)';

    // trade block
    const wrap = document.createElement('div');
    wrap.className = 'trade-block';
    wrap.style.borderLeft = `4px solid ${color}`;
    wrap.style.paddingLeft = '.75rem';
    wrap.style.margin = '.5rem 0 1rem';

    const phases = TRADE_PHASES[tKey] || ['Extras'];
    const rows = phases.map(ph=>{
      const task = trade.items.find(x=>slug(x.phase||'')===slug(ph));
      const checked = task?.done ? 'checked' : '';
      const notes = task?.notes || '';
      const taskId = task?.id || null;
      return `
        <div class="task-row" data-task-id="${taskId||''}" data-trade="${tKey}" data-phase="${ph}">
          <label><input type="checkbox" class="t-done" ${checked}/> <strong>${ph}</strong></label>
          <span class="chip" style="background:${color};color:#fff">${trade.label}</span>
          <textarea class="t-notes" placeholder="Notes">${notes||''}</textarea>
          <div class="row" style="gap:.5rem;align-items:center">
            <input type="file" class="t-photo" accept="image/*" />
            <button class="btn t-upload">Add photos</button>
            <button class="btn t-sign">Sign off</button>
          </div>
          <div class="thumbs"></div>
        </div>
      `;
    }).join('');

    wrap.innerHTML = `
      <h4 style="margin:.25rem 0 .5rem">${trade.label}</h4>
      ${rows}
    `;
    container.appendChild(wrap);
  }

  // wire interactions
  container.querySelectorAll('.task-row').forEach(row=>{
    const phase = row.dataset.phase;
    const trade = row.dataset.trade;
    const doneCb = row.querySelector('.t-done');
    const notesEl= row.querySelector('.t-notes');
    const upBtn = row.querySelector('.t-upload');
    const fileIn = row.querySelector('.t-photo');
    const signBtn= row.querySelector('.t-sign');
    const thumbs = row.querySelector('.thumbs');

    // load thumbs
    loadThumbs(currentProjectId, room.id, trade, phase, thumbs).catch(()=>{});

    doneCb?.addEventListener('change', async ()=>{
      await upsertTask(room.id, trade, phase, { done: !!doneCb.checked, notes: notesEl?.value||'' });
      // refresh room progress bar quickly (lightweight recount)
      // (optional) you can re-render whole floors if you prefer strict accuracy
    });

    notesEl?.addEventListener('change', async ()=>{
      await upsertTask(room.id, trade, phase, { done: !!doneCb.checked, notes: notesEl.value||'' });
    });

    upBtn?.addEventListener('click', async ()=>{
      if(!fileIn?.files?.length) { alert('Choose one or more images'); return; }
      const files = Array.from(fileIn.files);
      for(const f of files){
        const path = `${currentProjectId}/${room.id}/${trade}/${phase}/${Date.now()}_${f.name}`;
        const { error } = await sb.storage.from('photos').upload(path, f, { upsert:false, cacheControl:'3600' });
        if(error){ alert(error.message); return; }
      }
      fileIn.value = '';
      loadThumbs(currentProjectId, room.id, trade, phase, thumbs).catch(()=>{});
    });

    signBtn?.addEventListener('click', async ()=>{
      const { error } = await sb.from('signoffs').insert({
        project_id: currentProjectId,
        room_id: room.id,
        trade: trade,
        phase: phase,
        notes: (notesEl?.value||''),
        signed_by: currentUser?.email || null
      });
      if(error){ alert(error.message); return; }
      alert('Signed off!');
      renderDashboard(currentProjectId).catch(()=>{});
    });
  });
}

/* =========================
   9) Task upsert
   ========================= */
async function upsertTask(room_id, tradeKey, phaseLabel, patch){
  // find existing
  const { data: ex } = await sb.from('tasks')
    .select('id').eq('room_id', room_id)
    .eq('trade', tradeKey).eq('phase', phaseLabel).limit(1);

  if(ex && ex.length){
    await sb.from('tasks').update(patch).eq('id', ex[0].id);
  }else{
    await sb.from('tasks').insert({
      room_id, trade: tradeKey, phase: phaseLabel, notes: patch.notes||'', done: !!patch.done
    });
  }
}

/* =========================
   10) Thumbs + Photos (fixed getPublicUrl usage)
   ========================= */
async function loadThumbs(projectId, roomId, trade, phase, mount){
  if(!mount) return;
  mount.innerHTML = 'Loading photos…';

  // list files by prefix
  const prefix = `${projectId}/${roomId}/${trade}/${phase}`;
  const { data: items, error } = await sb.storage.from('photos').list(prefix, { limit:100, offset:0, sortBy:{column:'created_at', order:'desc'} });
  if(error){ mount.textContent = 'No photos'; return; }

  mount.innerHTML = '';
  for(const it of (items||[])){
    const fullPath = `${prefix}/${it.name}`;
    const pub = sb.storage.from('photos').getPublicUrl(fullPath); // << no destructure
    const url = pub?.data?.publicUrl;
    if(!url) continue;
    const img = new Image();
    img.src = url;
    img.title = `${trade} - ${phase}`;
    img.style.maxWidth = '120px';
    img.style.maxHeight = '90px';
    img.style.objectFit = 'cover';
    img.style.marginRight = '.25rem';
    img.addEventListener('click', ()=> window.open(url,'_blank'));
    mount.appendChild(img);
  }
}

/* =========================
   11) Dashboard (sign-offs + all photos)
   ========================= */
async function renderDashboard(pid){
  // sign-offs
  const { data: sigs } = await sb
    .from('signoffs')
    .select('rooms!inner(room_name,floor_name),trade,phase,notes,signed_by,created_at')
    .eq('project_id', pid)
    .order('created_at', { ascending:false })
    .limit(200);

  allSignoffsEl.innerHTML = '';
  const sWrap = document.createElement('details');
  sWrap.open = false;
  sWrap.innerHTML = `<summary><strong>All Sign-offs</strong></summary>`;
  const sTable = document.createElement('div');
  sTable.className = 'list';
  (sigs||[]).forEach(s=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.style.padding = '.25rem 0';
    row.innerHTML = `
      <span><strong>${s.rooms?.room_name||''}</strong> <span class="small muted">(${s.rooms?.floor_name||''})</span></span>
      <span class="chip" style="background:${TRADE_COLORS[tradeKey(s.trade||'')]||'var(--muted)'};color:#fff">${s.trade||''}</span>
      <span class="small">${s.phase||''}</span>
      <span class="small muted">${s.signed_by||''}</span>
      <span class="small muted">${new Date(s.created_at).toLocaleString()}</span>
    `;
    sTable.appendChild(row);
  });
  sWrap.appendChild(sTable);
  allSignoffsEl.appendChild(sWrap);

  // all photos (flat list newest first)
  allPhotosEl.innerHTML = '';
  const pWrap = document.createElement('details');
  pWrap.open = false;
  pWrap.innerHTML = `<summary><strong>All Photos</strong></summary>`;
  const thumbs = document.createElement('div');
  thumbs.className = 'thumbs';
  pWrap.appendChild(thumbs);
  allPhotosEl.appendChild(pWrap);

  // we list at project root
  // NOTE: If you have many files, consider paginating floors/rooms/trades with separate lists.
  const { data: folders, error } = await sb.storage.from('photos').list(`${pid}`, { limit: 200 });
  if(error){ thumbs.textContent = 'No photos'; return; }

  // recursively list one level deep for quick overview
  for(const f of (folders||[])){
    if(f.metadata && f.metadata.hasOwnProperty('size')) continue; // it's a file at root (we don’t expect this)
    const { data: sub1 } = await sb.storage.from('photos').list(`${pid}/${f.name}`, { limit: 200 });
    for(const f2 of (sub1||[])){
      const { data: sub2 } = await sb.storage.from('photos').list(`${pid}/${f.name}/${f2.name}`, { limit: 200 });
      for(const f3 of (sub2||[])){
        const { data: sub3 } = await sb.storage.from('photos').list(`${pid}/${f.name}/${f2.name}/${f3.name}`, { limit: 200 });
        for(const file of (sub3||[])){
          const full = `${pid}/${f.name}/${f2.name}/${f3.name}/${file.name}`;
          const pub = sb.storage.from('photos').getPublicUrl(full);
          const url = pub?.data?.publicUrl;
          if(!url) continue;
          const img = new Image();
          img.src = url;
          img.style.maxWidth='120px'; img.style.maxHeight='90px'; img.style.objectFit='cover'; img.style.marginRight='.25rem';
          img.addEventListener('click', ()=> window.open(url,'_blank'));
          thumbs.appendChild(img);
        }
      }
    }
  }
}

})(); 
</script>
</body>
</html>
