<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MPJ Tracker</title>

  <!-- favicon + logo (adjust paths if needed) -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png"/>

  <!-- theme -->
  <meta name="theme-color" content="#0b5f3b"/>

  <!-- Supabase UMD (must be before our script) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>

  <style>
    :root{
      --brand:#0b5f3b; --accent:#0b5f3b; --muted:#f3f4f6; --text:#111827; --border:#e5e7eb;
      --danger:#b91c1c; --ok:#15803d; --warn:#a16207;
      --joiner:#198754; --plumber:#0d6efd; --electrician:#dc2626; --plasterer:#6b7280;
      --decorator:#9333ea; --tiler:#16a34a; --specialist:#14b8a6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--text)}
    header{position:sticky;top:0;background:var(--brand);color:#fff;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .bar{display:flex;align-items:center;gap:.75rem}
    .logo{height:28px}
    .brand{font-weight:700;letter-spacing:.2px}

    main .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem;margin:.75rem 0}
    .row{display:flex;gap:.75rem;align-items:center}
    .input{width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:10px}
    .btn{padding:.55rem .9rem;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.accent{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:#fff}
    .btn.small{padding:.35rem .6rem;font-size:.9rem}
    .muted{color:#6b7280}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.9rem}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:730px){.grid{grid-template-columns:1fr}}

    .room{background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem}
    .room .title{font-weight:600}
    .pill{font-size:.8rem;background:var(--muted);border-radius:999px;padding:.1rem .5rem}
    .progress{height:8px;background:var(--muted);border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:var(--brand)}
    .trade{border-left:4px solid var(--border);padding-left:.6rem;margin:.6rem 0}
    .trade.joiners{border-color:var(--joiner)}
    .trade.plumbers{border-color:var(--plumber)}
    .trade.electricians{border-color:var(--electrician)}
    .trade.plasterer{border-color:var(--plasterer)}
    .trade.decorators{border-color:var(--decorator)}
    .trade.tiling{border-color:var(--tiler)}
    .trade.specialist{border-color:var(--specialist)}
    .trade h4{margin:.2rem 0 .4rem 0}
    .task{display:flex;align-items:center;gap:.6rem;margin:.35rem 0}
    .notes{width:100%;min-height:56px;margin:.35rem 0;padding:.5rem;border:1px solid var(--border);border-radius:10px}
    .thumbs{display:flex;flex-wrap:wrap;gap:.4rem}
    .thumbs img{width:76px;height:76px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .toolbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin:.6rem 0}
    .right{margin-left:auto}
    .caps{font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:#6b7280}
  </style>
</head>
<body>
<header>
  <div class="wrap bar">
    <img class="logo" src="/mpj-logo.png" alt="logo"/>
    <span class="brand">MPJ Tracker</span>
    <span class="right caps" id="auth-state">Signed out</span>
  </div>
</header>

<main class="wrap">

  <!-- Auth -->
  <div id="auth-box" class="card">
    <h2>Login / Sign Up</h2>
    <p class="muted">Use your email + password to sign in. New users can sign up on the same form.</p>
    <div class="row">
      <input id="email" class="input" placeholder="Enter your email"/>
      <input id="password" class="input" placeholder="Enter your password" type="password"/>
      <button id="signup-btn" class="btn">Sign Up</button>
      <button id="login-btn" class="btn">Log In</button>
    </div>
  </div>

  <!-- Project + quick stats -->
  <div id="project-box" class="card" style="display:none">
    <h2>Project</h2>
    <div class="row">
      <input id="project-name" class="input" placeholder="Project name"/>
      <input id="project-address" class="input" placeholder="Site address (optional)"/>
      <button id="use-project" class="btn accent">Use / Create Project</button>
      <button id="logout-btn" class="btn ghost right">Log out</button>
    </div>

    <div class="row" style="margin-top:.6rem">
      <div style="min-width:260px">
        <div class="muted caps">Overall Progress</div>
        <div class="progress"><span id="overall-bar" style="width:0%"></span></div>
        <div class="muted" style="margin-top:.25rem"><span id="overall-pct">0%</span></div>
      </div>
    </div>
  </div>

  <!-- Dashboard (filters, signoffs, photos) -->
  <div id="dash" class="card" style="display:none">
    <h2>Project Dashboard</h2>
    <input id="search" class="input" placeholder="Filter by room, trade, or user…"/>

    <details id="signoffs-block" style="margin-top:.8rem">
      <summary><strong>All Sign-offs</strong></summary>
      <div id="all-signoffs" class="muted" style="margin-top:.4rem">No sign-offs yet.</div>
    </details>

    <details id="photos-block" style="margin-top:.8rem">
      <summary><strong>All Photos</strong></summary>
      <div id="all-photos" class="thumbs"></div>
    </details>
  </div>

  <!-- Floors / Rooms / Tasks -->
  <div id="rooms" class="grid"></div>

</main>

<!-- ======== APP SCRIPT (one block) ======== -->
<script defer>
(async function () {
  /* 1) Supabase client */
  const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* 2) DOM refs */
  const authBox = document.getElementById('auth-box');
  const projectBox = document.getElementById('project-box');
  const dash = document.getElementById('dash');
  const roomsEl = document.getElementById('rooms');
  const statusEl = document.getElementById('status');
  const authStateEl = document.getElementById('auth-state');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const projectNameInput = document.getElementById('project-name');
  const projectAddressInput = document.getElementById('project-address');
  const useProjectBtn = document.getElementById('use-project');

  const searchInput = document.getElementById('search');
  const allSignoffsEl = document.getElementById('all-signoffs');
  const allPhotosEl = document.getElementById('all-photos');
  const overallBar = document.getElementById('overall-bar');
  const overallPct = document.getElementById('overall-pct');

  /* 3) Settings / helpers */
  const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other'];
  const TRADE_ORDER = ['Joiners','Plumbers','Electricians','Plasterer','Decorators','Tiling','Specialist'];
  const TRADE_COLORS = {
    Joiners: 'var(--joiner)', Plumbers: 'var(--plumber)', Electricians:'var(--electrician)',
    Plasterer:'var(--plasterer)', Decorators:'var(--decorator)', Tiling:'var(--tiler)', Specialist:'var(--specialist)'
  };

  let session = null;
  let currentProjectId = null;
  let cachedRooms = [];
  let cachedTasks = [];

  const slug = s => (s||'').toString().trim().toLowerCase();

  /* 4) Auth UI */
  function showAuth(show){
    authBox.style.display = show ? 'block' : 'none';
    projectBox.style.display = show ? 'none' : 'block';
    dash.style.display = show ? 'none' : 'block';
  }

  /* Sign up / login / logout */
  signupBtn.addEventListener('click', async () => {
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value||'';
    if (!email || !pw) return alert('Enter email and password');
    const { error } = await sb.auth.signUp({ email, password: pw });
    if (error) return alert(error.message);
    alert('Sign up successful. Please check your email (if confirmations are enabled).');
  });

  loginBtn.addEventListener('click', async () => {
    const email = (emailInput.value||'').trim();
    const pw = passwordInput.value||'';
    if (!email || !pw) return alert('Enter email and password');
    const { error } = await sb.auth.signInWithPassword({ email, password: pw });
    if (error) return alert(error.message);
  });

  logoutBtn.addEventListener('click', async () => {
    await sb.auth.signOut();
  });

  sb.auth.onAuthStateChange((_e, s) => {
    session = s?.session ?? s ?? null;
    authStateEl.textContent = session ? 'Signed in' : 'Signed out';
    showAuth(!session);
    if (session) initProjectArea();
  });

  /* On first load, check for session */
  {
    const { data } = await sb.auth.getSession();
    session = data.session;
    authStateEl.textContent = session ? 'Signed in' : 'Signed out';
    showAuth(!session);
    if (session) initProjectArea();
  }

  /* 5) Project: Use/Create, then render */
  useProjectBtn.addEventListener('click', async () => {
    await ensureProjectAndSeed();
    await renderEverything();
  });

  async function initProjectArea(){
    await ensureProjectAndSeed();
    await renderEverything();
  }

  async function ensureProjectAndSeed(){
    /* If user has a project with the given name, reuse it; else create; then seed rooms/tasks if needed */
    const name = (projectNameInput.value||'Demo Project').trim();
    const addr = (projectAddressInput.value||'').trim();

    const { data: existing, error: selErr } = await sb
      .from('projects').select('id').eq('name', name).eq('user_id', session.user.id).limit(1);

    if (selErr) { console.warn(selErr); }

    if (existing && existing.length){
      currentProjectId = existing[0].id;
    } else {
      const { data: ins, error: insErr } = await sb.from('projects')
        .insert([{ name, site_address: addr, user_id: session.user.id }])
        .select('id').single();
      if (insErr) { alert('Create project failed: '+insErr.message); return; }
      currentProjectId = ins.id;
    }

    /* Seed rooms for this project if empty */
    const { data: roomCount } = await sb.from('rooms').select('id', { count:'exact', head:true })
      .eq('project_id', currentProjectId);
    if ((roomCount?.length ?? 0) === 0){
      // minimal seed – you already created a bigger seed via SQL; we just guard if empty
      const floors = [
        ['Basement','Lobby'],['Ground Floor','Lobby'],['1st Floor','Lobby'],['2nd Floor','Lobby']
      ];
      await sb.from('rooms').insert(floors.map(([f,r])=>({ project_id: currentProjectId, floor_name:f, room_name:r })));
    }

    /* Seed default trade task rows if none */
    const { data: taskCount } = await sb.from('tasks').select('id',{ count:'exact', head:true })
      .eq('project_id', currentProjectId);
    if ((taskCount?.length ?? 0) === 0){
      // Default task names per trade
      const defaults = {
        Joiners:['First fix','Second fix','Extras'],
        Plumbers:['First fix','Second fix','Extras'],
        Electricians:['First fix','Second fix','Extras'],
        Plasterer:['First fix','Second fix','Extras'],
        Decorators:['First fix','Second fix','Extras'],
        Tiling:['Walls','Floor','Extras'],
        Specialist:['Extras']
      };
      const { data: roomList } = await sb.from('rooms')
        .select('id, floor_name, room_name').eq('project_id', currentProjectId);
      const rows = [];
      roomList.forEach(r=>{
        Object.entries(defaults).forEach(([trade, arr])=>{
          arr.forEach(task=>{
            rows.push({ project_id: currentProjectId, room_id: r.id, trade, task, done:false, notes:'' });
          });
        });
      });
      if (rows.length) await sb.from('tasks').insert(rows);
    }
  }

  /* 6) Render: floors, rooms, tasks, stats, signoffs, photos */
  async function renderEverything(){
    const { data: rooms, error: rErr } = await sb.from('rooms')
      .select('id, floor_name, room_name').eq('project_id', currentProjectId)
      .order('floor_name').order('room_name');
    if (rErr) { roomsEl.textContent = rErr.message; return; }
    cachedRooms = rooms || [];

    const { data: tasks, error: tErr } = await sb.from('tasks')
      .select('id, room_id, trade, task, done, notes, done_by, done_at, photo_key')
      .eq('project_id', currentProjectId);
    if (tErr) { roomsEl.textContent = tErr.message; return; }
    cachedTasks = tasks || [];

    renderFloors();
    renderDashboard();
  }

  function renderFloors(){
    /* group rooms by floor, ordered by FLOOR_ORDER */
    const byFloor = {};
    cachedRooms.forEach(r=>{
      if (!byFloor[r.floor_name]) byFloor[r.floor_name]=[];
      byFloor[r.floor_name].push(r);
    });

    const floors = Object.keys(byFloor).sort((a,b)=>FLOOR_ORDER.indexOf(a)-FLOOR_ORDER.indexOf(b));
    const frag = document.createDocumentFragment();

    floors.forEach(floor=>{
      const wrap = document.createElement('div');
      wrap.className = 'room';
      const floorTasks = cachedTasks.filter(t=>byFloor[floor].some(r=>r.id===t.room_id));
      const done = floorTasks.filter(t=>t.done).length;
      const total = floorTasks.length || 1;
      const pct = Math.round((done/total)*100);

      wrap.innerHTML = `
        <div class="toolbar">
          <div class="title">${floor}</div>
          <span class="muted">${done}/${total}</span>
          <div class="progress" style="min-width:160px"><span style="width:${pct}%"></span></div>
          <span class="muted">${pct}%</span>
        </div>
        <div class="grid" data-floor="${floor}"></div>
      `;
      const grid = wrap.querySelector('.grid');

      /* each room card (collapsed details) */
      byFloor[floor].forEach(room=>{
        const card = document.createElement('details');
        card.className = 'room';
        card.innerHTML = `
          <summary class="row">
            <span class="title">${room.room_name}</span>
            <span class="muted" id="rstat-${room.id}">0/0</span>
            <div class="progress" style="min-width:120px"><span id="rbar-${room.id}" style="width:0%"></span></div>
            <span class="muted" id="rpct-${room.id}">0%</span>
          </summary>
          <div id="room-body-${room.id}"></div>
        `;
        grid.appendChild(card);
        renderRoomBody(room.id);
      });

      frag.appendChild(wrap);
    });

    roomsEl.replaceChildren(frag);

    /* overall bar */
    const done = cachedTasks.filter(t=>t.done).length;
    const total = cachedTasks.length || 1;
    const pct = Math.round(done/total*100);
    overallBar.style.width = pct+'%';
    overallPct.textContent = pct+'%';
  }

  function renderRoomBody(roomId){
    const container = document.getElementById(`room-body-${roomId}`);
    const tasks = cachedTasks.filter(t=>t.room_id===roomId);

    /* progress numbers for summary */
    const done = tasks.filter(t=>t.done).length;
    const total = tasks.length || 1;
    const pct = Math.round(done/total*100);
    const rstat = document.getElementById(`rstat-${roomId}`);
    const rbar = document.getElementById(`rbar-${roomId}`);
    const rpct = document.getElementById(`rpct-${roomId}`);
    if (rstat) rstat.textContent = `${done}/${total}`;
    if (rbar) rbar.style.width = pct+'%';
    if (rpct) rpct.textContent = pct+'%';

    /* group by trade */
    const byTrade = {};
    tasks.forEach(t=>{
      if (!byTrade[t.trade]) byTrade[t.trade]=[];
      byTrade[t.trade].push(t);
    });

    const tradeFrag = document.createDocumentFragment();

    TRADE_ORDER.forEach(tr=>{
      const items = byTrade[tr] || [];
      if (!items.length) return;

      const sect = document.createElement('div');
      sect.className = `trade ${slug(tr)}`;
      sect.style.borderLeftColor = TRADE_COLORS[tr] || 'var(--border)';
      sect.innerHTML = `<h4>${tr}</h4>`;

      items.forEach(task=>{
        const row = document.createElement('div');
        row.className = 'task';
        row.innerHTML = `
          <input type="checkbox" ${task.done ? 'checked':''} data-task="${task.id}"/>
          <span>${task.task}</span>
        `;
        const cb = row.querySelector('input[type=checkbox]');
        cb.addEventListener('change', async () => {
          const nowDone = !!cb.checked;
          const upd = { done: nowDone };
          if (nowDone) {
            upd.done_by = session.user.id;
            upd.done_at = new Date().toISOString();
          } else {
            upd.done_by = null; upd.done_at = null;
          }
          await sb.from('tasks').update(upd).eq('id', task.id);
          task.done = nowDone; task.done_by = upd.done_by; task.done_at = upd.done_at;
          renderRoomBody(roomId); /* refresh counts */
          renderDashboardRowFromTask(task); /* update dashboard blocks */
        });
        sect.appendChild(row);

        /* notes */
        const n = document.createElement('textarea');
        n.className = 'notes';
        n.placeholder = 'Notes';
        n.value = task.notes || '';
        n.addEventListener('change', async ()=>{
          task.notes = n.value;
          await sb.from('tasks').update({ notes: task.notes }).eq('id', task.id);
        });
        sect.appendChild(n);

        /* photo upload */
        const up = document.createElement('input');
        up.type = 'file'; up.accept = "image/*";
        up.addEventListener('change', async ()=>{
          const f = up.files?.[0]; if (!f) return;
          const key = `${currentProjectId}/${roomId}/${task.id}/${Date.now()}_${f.name}`;
          const { error: ulErr } = await sb.storage.from('photos').upload(key, f, { upsert:false });
          if (ulErr) return alert(ulErr.message);
          task.photo_key = key;
          await sb.from('tasks').update({ photo_key: key }).eq('id', task.id);
          await renderDashboard(); /* refresh All Photos */
        });
        sect.appendChild(up);

        const thumbs = document.createElement('div');
        thumbs.className = 'thumbs';
        if (task.photo_key){
          const { data } = sb.storage.from('photos').getPublicUrl(task.photo_key);
          const img = document.createElement('img');
          img.src = data.publicUrl; img.alt='photo';
          thumbs.appendChild(img);
        }
        sect.appendChild(thumbs);

        /* sign-off button if done */
        const so = document.createElement('button');
        so.className = 'btn small';
        so.textContent = 'Sign-off';
        so.disabled = !task.done;
        so.addEventListener('click', async ()=>{
          if (!task.done) return;
          await sb.from('signoffs').insert([{
            project_id: currentProjectId,
            room_id: roomId,
            trade: task.trade,
            task: task.task,
            signed_by: session.user.id
          }]);
          await renderDashboard(); /* refresh sign-off list */
          alert('Signed off.');
        });
        sect.appendChild(so);
      });

      tradeFrag.appendChild(sect);
    });

    container.replaceChildren(tradeFrag);
  }

  /* Dashboard renderers */
  async function renderDashboard(){
    renderAllSignoffs();
    await renderAllPhotos();
  }

  async function renderAllPhotos(){
    allPhotosEl.replaceChildren();
    /* show any photos from tasks with a key */
    const photos = cachedTasks.filter(t=>t.photo_key);
    for (const t of photos){
      const { data } = sb.storage.from('photos').getPublicUrl(t.photo_key);
      const img = document.createElement('img');
      img.src = data.publicUrl; img.alt = `${t.trade} - ${t.task}`;
      allPhotosEl.appendChild(img);
    }
  }

  async function renderAllSignoffs(){
    const { data, error } = await sb
      .from('signoffs')
      .select('id, trade, task, created_at, users:profiles!inner(full_name), rooms!inner(room_name, floor_name)')
      .eq('project_id', currentProjectId)
      .order('created_at',{ascending:false});

    /* If you don’t have a profiles view, show user id instead */
    const list = document.createElement('div');
    if (!data || !data.length){
      list.textContent = 'No sign-offs yet.';
    } else {
      data.forEach(s=>{
        const row = document.createElement('div');
        row.className = 'row';
        const who = s.users?.full_name || s.signed_by || '(user)';
        row.innerHTML = `
          <span class="pill">${s.rooms?.floor_name || ''} / ${s.rooms?.room_name || ''}</span>
          <span style="color:${TRADE_COLORS[s.trade]||'inherit'}">${s.trade}</span>
          <span>${s.task}</span>
          <span class="muted">Signed by: ${who}</span>
        `;
        list.appendChild(row);
      });
    }
    allSignoffsEl.replaceChildren(list);
  }

  function renderDashboardRowFromTask(/* task */){
    /* Lightweight live tweaks could go here; for simplicity we recompute on next refresh */
  }

  /* Search filter – collapses to matches */
  searchInput?.addEventListener('input', ()=>{
    const q = slug(searchInput.value);
    document.querySelectorAll('details.room').forEach(d=>{
      const txt = slug(d.querySelector('summary .title')?.textContent||'');
      d.style.display = (!q || txt.includes(q)) ? '' : 'none';
    });
  });

})();
</script>
</body>
</html>
