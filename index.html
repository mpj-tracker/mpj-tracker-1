<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MPJ Tracker</title>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.js"></script>

  <style>
    :root{
      --brand:#0b5f3b; --text:#111827; --card:#fff; --chip:#eef1f4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;background:#f6f7f8;color:var(--text)}
    header{position:sticky;top:0;background:var(--brand);color:#fff;z-index:5}
    .bar{max-width:1200px;margin:0 auto;padding:.75rem 1rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:.5rem;align-items:center;cursor:pointer}
    .brand img{height:24px}
    .pill{background:#fff1;border-radius:999px;padding:.25rem .75rem}
    main{max-width:1200px;margin:1rem auto;padding:0 1rem 4rem}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .row{display:flex;gap:.5rem;align-items:center}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem;box-shadow:0 1px 1px rgba(0,0,0,.02)}
    .muted{opacity:.7}
    button{border:1px solid #d1d5db;background:#fff;border-radius:.5rem;padding:.5rem .8rem;cursor:pointer}
    button:is(.primary){background:#14532d;color:#fff;border-color:#14532d}
    button.danger{background:#7f1d1d;color:#fff;border-color:#7f1d1d}
    input,select{border:1px solid #d1d5db;border-radius:.5rem;padding:.5rem .6rem;min-width:10rem}

    details.card > summary{cursor:pointer;user-select:none}
    .small{font-size:.875rem}

    .progress{height:.6rem;background:#eef2f7;border-radius:999px;overflow:hidden}
    .progress > span{display:block;height:100%;background:#16a34a;width:0%}

    .stack{display:flex;flex-direction:column;gap:.5rem}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand" id="go-home">
        <img src="mpj-logo.png" alt="logo"/>
        <strong>MPJ Tracker</strong>
      </div>
      <div id="auth-state" class="pill">Signed out</div>
    </div>
  </header>

  <main>
    <!-- Diagnostics -->
    <details class="card" id="diag-wrap" open>
      <summary><strong>Diagnostics</strong> (click to open/close)</summary>
      <div class="stack">
        <div id="diag" class="small muted">Ready.</div>
        <div class="row">
          <button id="probe-auth" class="primary">Probe Auth</button>
          <button id="purge-sw">Purge SW + caches</button>
        </div>
      </div>
    </details>

    <!-- Auth -->
    <div class="card" id="auth-box">
      <h2>Login / Sign Up</h2>
      <div class="row">
        <input id="email" type="email" placeholder="email" />
        <input id="password" type="password" placeholder="password" />
        <button id="signup-btn">Sign Up</button>
        <button id="login-btn" class="primary">Log In</button>
        <button id="logout-btn">Sign out</button>
      </div>
    </div>

    <!-- Project controls -->
    <div class="card" id="project-box" style="display:none">
      <h2>Project</h2>
      <div class="row" style="flex-wrap:wrap;gap:.75rem">
        <select id="project-select" aria-label="Project"></select>
        <label class="row small"><input type="checkbox" id="show-archived-projects" /> Show archived</label>
        <button id="use-project" class="primary">Use Selected</button>
        <button id="toggle-archive-btn">Archive / Unarchive</button>
        <button id="delete-project" class="danger" title="Owner only">Delete Project</button>
      </div>
      <div class="row" style="margin-top:.5rem;gap:.75rem">
        <input id="project-name" placeholder="New project name" />
        <button id="create-project" class="primary">Create New Project</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="card" id="dash" style="display:none">
      <h2>Project Dashboard</h2>

      <div class="stack">
        <label class="row small" style="gap:.5rem">
          <input id="search" placeholder="Filter by room or floorâ€¦" />
        </label>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>Overall Progress</strong>
            <span id="overall-pct" class="small muted">0%</span>
          </div>
          <div class="progress"><span id="overall-bar" style="width:0%"></span></div>
        </div>
      </div>
    </div>

    <!-- Floors / Rooms -->
    <div id="rooms" class="grid"></div>
  </main>

  <script>
  (async function () {
    /* ----------------- 0) Diagnostics helpers FIRST ----------------- */
    const diagEl = document.getElementById('diag');
    const diagLog = (m) => { if (diagEl) { diagEl.textContent = String(m); console.log('[diag]', m); } };

    /* ----------------- 1) Purge stale service workers ---------------- */
    async function purgeServiceWorkers() {
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
          if (window.caches?.keys) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        }
        console.log('[sw] Unregistered and caches cleared');
        diagLog('SW: none');
      } catch (e) {
        console.warn('[sw] purge failed', e);
        diagLog('SW: purge failed (see console)');
      }
    }
    await purgeServiceWorkers();
    document.getElementById('purge-sw').addEventListener('click', purgeServiceWorkers);

    /* ----------------- 2) Supabase client (live project) ------------- */
    const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";
    const OWNER_UUID = "f3fb3703-9b24-4323-919e-0738f82cc93f"; // delete-project guard

    if (!window.supabase) { alert('Supabase library failed to load. Check the <script> in <head>.'); return; }
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:false }
    });
    console.log('Supabase client ready');

    /* ----------------- 3) DOM refs ---------------------------------- */
    const goHomeBtn = document.getElementById('go-home');
    const authBox = document.getElementById('auth-box');
    const projectBox = document.getElementById('project-box');
    const dash = document.getElementById('dash');
    const roomsEl = document.getElementById('rooms');
    const authStateEl = document.getElementById('auth-state');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const projectSelect = document.getElementById('project-select');
    const showArchivedProjects = document.getElementById('show-archived-projects');
    const useProjectBtn = document.getElementById('use-project');
    const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
    const deleteProjectBtn = document.getElementById('delete-project');
    const createProjectBtn = document.getElementById('create-project');
    const projectNameInput = document.getElementById('project-name');

    const searchInput = document.getElementById('search');
    const overallBar = document.getElementById('overall-bar');
    const overallPct = document.getElementById('overall-pct');

    /* ----------------- 4) Small utils -------------------------------- */
    const safe = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const showAuth = () => { authBox.style.display='block'; projectBox.style.display='none'; dash.style.display='none'; };
    const showProjects = () => { authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='none'; };
    const showApp = () => { authBox.style.display='none'; projectBox.style.display='block'; dash.style.display='block'; };
    goHomeBtn.addEventListener('click', () => location.reload());

    /* ----------------- 5) Auth probe (sends headers) ----------------- */
    async function probeAuth() {
      try{
        const res = await fetch(`${SUPABASE_URL}/auth/v1/settings`, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          }
        });
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          alert(`Login probe failed: HTTP ${res.status}\n\n${t || 'No body'}`);
        } else {
          alert('Login probe OK');
        }
      } catch (e) {
        alert(`Login probe could not reach Supabase.\n\nReason:\n${e}`);
      }
    }
    document.getElementById('probe-auth').addEventListener('click', probeAuth);

    /* ----------------- 6) Auth flow ---------------------------------- */
    let currentUser = null, currentProjectId = null;

    async function refreshSessionUI() {
      const { data } = await sb.auth.getSession();
      currentUser = data.session?.user || null;
      authStateEl.textContent = currentUser ? `Signed in: ${currentUser.email}` : 'Signed out';
      if (currentUser) {
        await loadProjects();
        showProjects();
      } else {
        showAuth();
      }
    }

    signupBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim(), password = passwordInput.value.trim();
      if (!email || !password) return alert('Enter email + password');
      const { error } = await sb.auth.signUp({ email, password });
      if (error) return alert('Sign up failed: ' + error.message);
      alert('Sign up OK. Now log in.');
    });

    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim(), password = passwordInput.value.trim();
      if (!email || !password) return alert('Enter email + password');
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return alert('Login error: ' + error.message);
      await refreshSessionUI();
    });

    logoutBtn.addEventListener('click', async () => {
      await sb.auth.signOut();
      currentProjectId = null;
      roomsEl.innerHTML = '';
      await refreshSessionUI();
    });

    /* ----------------- 7) Projects ----------------------------------- */
    async function loadProjects() {
      projectSelect.innerHTML = '';
      let q = sb.from('projects').select('id,name,is_archived').order('created_at', { ascending:true });
      if (!showArchivedProjects.checked) q = q.eq('is_archived', false);
      const { data, error } = await q;
      if (error) return alert('Load projects failed: ' + error.message);
      for (const p of (data||[])) {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.is_archived ? `${p.name} (archived)` : p.name;
        projectSelect.appendChild(opt);
      }
    }

    showArchivedProjects.addEventListener('change', loadProjects);

    useProjectBtn.addEventListener('click', async () => {
      const id = projectSelect.value;
      if (!id) return alert('Pick a project first');
      currentProjectId = id;
      await loadRooms(); // shows dashboard content
      showApp();
    });

    toggleArchiveBtn.addEventListener('click', async () => {
      const id = projectSelect.value;
      if (!id) return alert('Pick a project');
      const { data, error } = await sb.from('projects').select('is_archived').eq('id', id).single();
      if (error) return alert('Fetch project failed: ' + error.message);
      const { error: uerr } = await sb.from('projects').update({ is_archived: !data.is_archived }).eq('id', id);
      if (uerr) return alert('Archive toggle failed: ' + uerr.message);
      await loadProjects();
      alert(data.is_archived ? 'Unarchived' : 'Archived');
    });

    deleteProjectBtn.addEventListener('click', async () => {
      if (!currentUser || currentUser.id !== OWNER_UUID) return alert('Only owner can delete projects.');
      const id = projectSelect.value;
      if (!id) return alert('Pick a project');
      if (!confirm('Delete this project (tasks + photos will also be removed)?')) return;
      const { error } = await sb.from('projects').delete().eq('id', id);
      if (error) return alert('Delete failed: ' + error.message);
      await loadProjects();
      roomsEl.innerHTML = '';
      overallBar.style.width = '0%'; overallPct.textContent = '0%';
      alert('Deleted');
    });

    createProjectBtn.addEventListener('click', async () => {
      const name = projectNameInput.value.trim();
      if (!name) return alert('Enter a project name');
      const { error } = await sb.from('projects').insert({ name, is_archived:false });
      if (error) return alert('Create failed: ' + error.message);
      projectNameInput.value = '';
      await loadProjects();
      alert('Project created');
    });

    /* ----------------- 8) Rooms (no sort_order) ---------------------- */
    async function loadRooms() {
      roomsEl.innerHTML = '';
      if (!currentProjectId) return;

      // IMPORTANT: do not request sort_order (it may not exist yet)
      const { data, error } = await sb
        .from('rooms')
        .select('id,project_id,floor,name')
        .eq('project_id', currentProjectId)
        .order('floor', { ascending:true })
        .order('name', { ascending:true });

      if (error) return alert('Load rooms failed: ' + error.message);

      const list = (data||[]);
      if (!list.length) {
        roomsEl.innerHTML = '<div class="card muted">No rooms yet for this project.</div>';
      } else {
        for (const r of list) {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="row" style="justify-content:space-between;align-items:center">
              <strong>${safe(r.floor||'Room')}</strong>
              <span class="small muted">${safe(r.name||'Unnamed')}</span>
            </div>
            <div class="progress" style="margin-top:.5rem"><span style="width:0%"></span></div>
          `;
          roomsEl.appendChild(div);
        }
      }

      // basic overall bar for now
      overallBar.style.width = '0%';
      overallPct.textContent = '0%';
    }

    /* ----------------- 9) Live auth state ---------------------------- */
    sb.auth.onAuthStateChange((_e,_s)=>refreshSessionUI());
    await refreshSessionUI();
  })();
  </script>
</body>
</html>
