<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MPJ Tracker</title>

  <!-- PWA bits (optional) -->
  <meta name="theme-color" content="#0b5f3b" />
  <link rel="manifest" href="/manifest.webmanifest?v=3" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="/mpj-logo.png" />

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>

  <style>
    :root{
      --brand:#0b5f3b; --accent:#f0b323; --muted:#e8ecef; --text:#111827; --bg:#fafafa;
      --card:#fff; --hr:#e5e7eb;
      /* trade colours */
      --joinery:#108a00; --plumbing:#0a66c2; --electrical:#d92d20; --plaster:#7c3aed;
      --decor:#f97316; --tiling:#0f766e; --special:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:var(--brand);color:#fff;border-bottom:2px solid #06341f;z-index:50}
    .hi{max-width:1200px;margin:0 auto;padding:.85rem 1rem;display:flex;gap:.75rem;align-items:center}
    .logo{display:flex;align-items:center;gap:.5rem}
    .logo img{height:28px;background:#fff;border-radius:6px;padding:2px}
    .brand{font-weight:700;letter-spacing:.3px}
    main{max-width:1200px;margin:1rem auto;padding:0 1rem}
    .grid{display:grid;gap:1rem}
    .card{background:var(--card);border:1px solid var(--hr);border-radius:14px;overflow:hidden}
    .card .head{padding:.9rem 1rem;border-bottom:1px solid var(--hr);display:flex;align-items:center;gap:1rem}
    .card .body{padding:1rem}
    .btn{appearance:none;border:1px solid var(--hr);background:#fff;border-radius:10px;padding:.55rem .85rem;cursor:pointer}
    .btn.accent{background:var(--brand);border-color:#06341f;color:#fff}
    .row{display:flex;gap:.5rem;align-items:center}
    .grow{flex:1}
    .input{width:100%;padding:.6rem .7rem;border:1px solid var(--hr);border-radius:10px;background:#fff}
    .muted{color:#6b7280;font-size:.9rem}
    details{border:1px solid var(--hr);border-radius:12px;background:#fff}
    summary{list-style:none;cursor:pointer;padding:1rem;display:flex;align-items:center;gap:1rem}
    summary::-webkit-details-marker{display:none}
    .bar{height:10px;background:var(--muted);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--brand);width:0%}
    .pill{border:1px solid var(--hr);border-radius:999px;padding:.15rem .55rem;font-size:.8rem;background:#fff}
    .trade{padding:.6rem .75rem;border-radius:12px;border:1px solid var(--hr);background:#fff}
    .trade h4{margin:0 0 .6rem 0;font-size:1rem}
    .trade.joinery{border-left:6px solid var(--joinery)}
    .trade.plumbing{border-left:6px solid var(--plumbing)}
    .trade.electrical{border-left:6px solid var(--electrical)}
    .trade.plaster{border-left:6px solid var(--plaster)}
    .trade.decor{border-left:6px solid var(--decor)}
    .trade.tiling{border-left:6px solid var(--tiling)}
    .trade.special{border-left:6px solid var(--special)}
    .task{display:grid;grid-template-columns:28px 1fr auto;gap:.6rem;align-items:start;padding:.45rem 0;border-top:1px dashed var(--hr)}
    .task:first-child{border-top:none}
    .task label{font-weight:500}
    .notes{width:100%;min-height:46px;border:1px solid var(--hr);border-radius:8px;padding:.4rem .55rem}
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin:.35rem 0}
    .thumbs img{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--hr)}
    .right{margin-left:auto}
    .stack{display:grid;gap:.6rem}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media (max-width:720px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="hi">
      <div class="logo">
        <img src="/mpj-logo.png" alt="MPJ" />
        <span class="brand">MPJ Tracker</span>
      </div>
      <span class="muted right" id="auth-state">Signed out</span>
    </div>
  </header>

  <main class="grid">

    <!-- Auth -->
    <div id="auth-box" class="card">
      <div class="head"><strong>Login / Sign Up</strong></div>
      <div class="body stack">
        <p class="muted">Use your email + password to sign in. New users can sign up on the same form.</p>
        <div class="two">
          <input id="email" class="input" placeholder="Enter your email" />
          <input id="password" class="input" type="password" placeholder="Enter your password" />
        </div>
        <div class="row">
          <button id="signup-btn" class="btn">Sign Up</button>
          <button id="login-btn" class="btn">Log In</button>
        </div>
      </div>
    </div>

    <!-- Project selector -->
    <div id="project-box" class="card" style="display:none">
      <div class="head"><strong>Project</strong></div>
      <div class="body stack">
        <div class="two">
          <input id="project-name" class="input" placeholder="Project name" />
          <input id="project-address" class="input" placeholder="Site address (optional)" />
        </div>
        <div class="row">
          <button id="use-project" class="btn accent right">Use / Create Project</button>
          <button id="logout-btn" class="btn">Log out</button>
        </div>
        <p class="muted">Tip: re-use the same name to open the project again later.</p>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="card" style="display:none">
      <div class="head"><strong>Project Dashboard</strong><span class="muted" id="status"></span></div>
      <div class="body stack">
        <input id="search" class="input" placeholder="Filter by room, trade, or user…" />
        <div class="row" style="align-items:center;gap:1rem">
          <strong>Overall Progress</strong>
          <div class="bar grow"><span id="overall-bar"></span></div>
          <span class="pill" id="overall-pill">0%</span>
        </div>

        <details id="signoffs-block">
          <summary><strong>All Sign-offs</strong></summary>
          <div id="signoffs" class="body"></div>
        </details>

        <details id="photos-block">
          <summary><strong>All Photos</strong></summary>
          <div id="all-photos" class="thumbs"></div>
        </details>
      </div>
    </div>

    <!-- Floors / Rooms / Tasks -->
    <div id="rooms" class="grid"></div>

  </main>

  <script>
  (async function(){
    // ====== 1) Supabase client ======
    const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";  
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== 2) DOM refs ======
    const authBox = document.getElementById('auth-box');
    const projectBox = document.getElementById('project-box');
    const dash = document.getElementById('dash');
    const roomsEl = document.getElementById('rooms');
    const statusEl = document.getElementById('status');
    const authStateEl = document.getElementById('auth-state');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const projectNameInput = document.getElementById('project-name');
    const projectAddressInput = document.getElementById('project-address');
    const useProjectBtn = document.getElementById('use-project');

    const searchInput = document.getElementById('search');
    const signoffsWrap = document.getElementById('signoffs');
    const allPhotosWrap = document.getElementById('all-photos');
    const overallBar = document.getElementById('overall-bar');
    const overallPill = document.getElementById('overall-pill');

    const FLOOR_ORDER = ['Basement','Ground Floor','1st Floor','2nd Floor','Other'];

    // Trade definitions + colours
    const TRADES = {
      'Joiners': { class:'joinery', color:'var(--joinery)', tasks:['First fix','Second fix','Extras'] },
      'Plumbers': { class:'plumbing', color:'var(--plumbing)', tasks:['First fix','Second fix','Extras'] },
      'Electricians': { class:'electrical', color:'var(--electrical)', tasks:['First fix','Second fix','Extras'] },
      'Plasterer': { class:'plaster', color:'var(--plaster)', tasks:['First fix','Second fix','Extras'] },
      'Decorators':{ class:'decor', color:'var(--decor)', tasks:['First fix','Second fix','Extras'] },
      'Tiling': { class:'tiling', color:'var(--tiling)', tasks:['Walls','Floor','Extras'] },
      'Specialist':{ class:'special', color:'var(--special)', tasks:['Extras'] }
    };

    let session = null;
    let currentProjectId = null;
    let userEmail = '';

    // ====== 3) Auth actions ======
    signupBtn.addEventListener('click', async () => {
      const email = (emailInput.value||'').trim();
      const pw = passwordInput.value||'';
      if(!email || !pw) return alert('Enter email + password');
      const { error } = await sb.auth.signUp({ email, password: pw });
      if(error) return alert(error.message);
      alert('Sign up successful. Check your email to confirm (if required).');
    });

    loginBtn.addEventListener('click', async () => {
      const email = (emailInput.value||'').trim();
      const pw = passwordInput.value||'';
      if(!email || !pw) return alert('Enter email + password');
      const { error } = await sb.auth.signInWithPassword({ email, password: pw });
      if(error) return alert(error.message);
    });

    logoutBtn.addEventListener('click', async () => {
      await sb.auth.signOut();
    });

    sb.auth.onAuthStateChange(async (_e, s) => {
      session = s?.session ?? s;
      userEmail = session?.user?.email || '';
      authStateEl.textContent = session ? `Signed in: ${userEmail}` : 'Signed out';
      renderAuth();
      if(session) {
        // If you created RPC seed_full_project, feel free to skip it here.
        showProject();
      }
    });

    // first load
    {
      const { data } = await sb.auth.getSession();
      session = data.session;
      userEmail = session?.user?.email || '';
      renderAuth();
      if(session) showProject();
      authStateEl.textContent = session ? `Signed in: ${userEmail}` : 'Signed out';
    }

    function renderAuth(){
      if(session){
        authBox.style.display = 'none';
        projectBox.style.display = 'block';
        dash.style.display = 'block';
      }else{
        authBox.style.display = 'block';
        projectBox.style.display = 'none';
        dash.style.display = 'none';
        roomsEl.innerHTML = '';
      }
    }

    // ====== 4) Project select / create ======
    useProjectBtn.addEventListener('click', async () => {
      const name = (projectNameInput.value || '').trim();
      const addr = (projectAddressInput.value || '').trim();
      if(!name) return alert('Enter a project name');
      useProjectBtn.disabled = true;

      // Find or create
      const { data: existing, error: findErr } =
        await sb.from('projects').select('id').eq('name', name).limit(1);
      if(findErr){ useProjectBtn.disabled = false; return alert(findErr.message); }

      if(existing?.length){
        currentProjectId = existing[0].id;
      }else{
        // Create new
        const { data: ins, error: insErr } = await sb
          .from('projects')
          .insert({ name, site_address: addr, user_id: session.user.id })
          .select('id').single();
        if(insErr){ useProjectBtn.disabled = false; return alert(insErr.message); }
        currentProjectId = ins.id;

        // Seed rooms (if you set up the RPC you can call it; otherwise client-side insert)
        await clientSeedRooms(currentProjectId);
        // Seed trade tasks per room
        await seedTradeTasksForProject(currentProjectId);
      }

      await renderEverything();
      useProjectBtn.disabled = false;
    });

    async function showProject(){
      statusEl.textContent = 'Loading project…';
      // try to pick latest project for user
      const { data: proj, error } = await sb
        .from('projects')
        .select('id,name,site_address')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending:false })
        .limit(1);
      if(!error && proj?.length){
        currentProjectId = proj[0].id;
        projectNameInput.value = proj[0].name || '';
        projectAddressInput.value = proj[0].site_address || '';
      }
      await renderEverything();
    }

    // Client-side seed rooms (if you don't use RPC)
    async function clientSeedRooms(projectId){
      const floors = {
        'Basement': [
          'Lobby','Gym','Wine room','Safe room','Treatment room','Treatment room 2',
          'Steam room','Utility room','WC','Plant room','Bar','Cinema'
        ],
        'Ground Floor': [
          'Lobby','Living room','Dining room','Kitchen','WC','Store',
          'Annex kitchenette','Annex ensuite','Annex Bedroom'
        ],
        '1st Floor': [
          'Lobby','Bedroom 3','Bedroom 3 ensuite','Bedroom 4','Bedroom 4 ensuite',
          'Bedroom 5','Bedroom 5 ensuite','Bedroom 6','Bedroom 6 ensuite'
        ],
        '2nd Floor': [
          'Lobby','Bedroom 1','Bedroom 1 ensuite','Bedroom 1 dresser',
          'Bedroom 2','Bedroom 2 ensuite','Bedroom 2 dresser',
          'Rod office','Sheila office'
        ],
        'Other': []
      };
      const rows = [];
      for(const floor of FLOOR_ORDER){
        for(const room of (floors[floor]||[])){
          rows.push({ project_id: projectId, floor_name: floor, room_name: room });
        }
      }
      if(rows.length){
        await sb.from('rooms').insert(rows);
      }
    }

    // Seed default trade tasks for every room (if not present)
    async function seedTradeTasksForProject(projectId){
      const { data: rooms } = await sb.from('rooms').select('id, room_name').eq('project_id', projectId);
      const batch = [];
      for(const r of rooms || []){
        for(const [trade, def] of Object.entries(TRADES)){
          for(const label of def.tasks){
            batch.push({ room_id: r.id, trade, label });
          }
        }
      }
      if(batch.length){
        await sb.from('tasks').insert(batch).catch(()=>{});
      }
    }

    // ====== 5) Render everything ======
    searchInput.addEventListener('input', () => filterUI(searchInput.value || ''));

    async function renderEverything(){
      if(!currentProjectId){ roomsEl.innerHTML=''; overallBar.style.width='0%'; overallPill.textContent='0%'; return; }

      await ensureTasksExist(currentProjectId);
      const { data: rooms, error } = await sb
        .from('rooms')
        .select('id,floor_name,room_name')
        .eq('project_id', currentProjectId)
        .order('floor_name', { ascending:true })
        .order('room_name', { ascending:true });

      if(error){ roomsEl.innerHTML = `<div class="muted">Rooms error: ${error.message}</div>`; return; }

      // group by floors
      const byFloor = {};
      for(const r of rooms){
        if(!byFloor[r.floor_name]) byFloor[r.floor_name] = [];
        byFloor[r.floor_name].push(r);
      }

      // build UI
      roomsEl.innerHTML = '';
      for(const floor of FLOOR_ORDER){
        const list = byFloor[floor] || [];
        const det = document.createElement('details');
        det.dataset.floor = floor;
        const sum = document.createElement('summary');
        sum.innerHTML = `<strong>${floor}</strong> <span class="pill" id="pill-${floor.replace(/\s/g,'_')}">0/0</span>`;
        det.appendChild(sum);

        const body = document.createElement('div');
        body.className = 'body grid';
        for(const r of list){
          const c = document.createElement('div');
          c.className = 'card';
          c.innerHTML = `
            <div class="head">
              <strong>${r.room_name}</strong>
              <span class="pill right" id="count-${r.id}">0/0</span>
              <span class="pill muted" id="pct-${r.id}">0%</span>
            </div>
            <div class="body stack" id="room-${r.id}">
              <div class="bar"><span id="bar-${r.id}"></span></div>
              ${Object.entries(TRADES).map(([trade, def]) => `
                <div class="trade ${def.class}" data-trade="${trade}" data-room="${r.id}">
                  <h4 style="color:${def.color}">${trade}</h4>
                  ${def.tasks.map(lbl => `
                    <div class="task" data-label="${lbl}">
                      <input type="checkbox" class="chk">
                      <div>
                        <label>${lbl}</label>
                        <textarea class="notes" placeholder="Notes…"></textarea>
                        <div class="row" style="gap:.5rem;margin:.35rem 0">
                          <input type="file" accept="image/*" capture="environment" class="file">
                          <button class="btn up">Upload</button>
                          <span class="muted small info"></span>
                        </div>
                        <div class="thumbs"></div>
                      </div>
                      <button class="btn sign right">Sign off</button>
                    </div>
                  `).join('')}
                </div>
              `).join('')}
            </div>
          `;
          body.appendChild(c);
        }
        det.appendChild(body);
        roomsEl.appendChild(det);
      }

      // load tasks + wire up events
      await hydrateAllRooms();
      await refreshDashboard();

      // apply current search
      filterUI(searchInput.value || '');
    }

    function filterUI(q){
      q = q.toLowerCase();
      for(const det of roomsEl.querySelectorAll('details')){
        let any = false;
        for(const card of det.querySelectorAll('.card')){
          const name = card.querySelector('.head strong')?.textContent.toLowerCase() || '';
          let shown = !q || name.includes(q);
          if(!shown){
            for(const h4 of card.querySelectorAll('.trade h4')){
              if(h4.textContent.toLowerCase().includes(q)) { shown = true; break; }
            }
          }
          card.style.display = shown ? '' : 'none';
          if(shown) any = true;
        }
        det.style.display = any ? '' : 'none';
      }
    }

    async function ensureTasksExist(projectId){
      // If there are no tasks, seed them once
      const { data: anyTask } = await sb
        .from('tasks')
        .select('id')
        .in('room_id', (await sb.from('rooms').select('id').eq('project_id',projectId)).data?.map(r=>r.id) || [])
        .limit(1);
      if(!anyTask?.length){
        await seedTradeTasksForProject(projectId);
      }
    }

    async function hydrateAllRooms(){
      // fetch tasks for all rooms in project
      const { data: taskRows } = await sb
        .from('tasks')
        .select('id,room_id,trade,label,done,notes,photo_urls,signed_by,signed_at')
        .in('room_id', (await sb.from('rooms').select('id').eq('project_id', currentProjectId)).data.map(r=>r.id));

      const byRoom = {};
      for(const t of taskRows || []){
        if(!byRoom[t.room_id]) byRoom[t.room_id] = [];
        byRoom[t.room_id].push(t);
      }

      // wire up each room
      for(const [roomId, tasks] of Object.entries(byRoom)){
        const roomBox = document.getElementById(`room-${roomId}`);
        if(!roomBox) continue;

        // set state
        for(const t of tasks){
          const trSel = `.trade[data-trade="${cssEscape(t.trade)}"][data-room="${roomId}"]`;
          const tradeBox = roomBox.querySelector(trSel);
          if(!tradeBox) continue;
          const taskRow = tradeBox.querySelector(`.task[data-label="${cssEscape(t.label)}"]`);
          if(!taskRow) continue;

          const chk = taskRow.querySelector('.chk');
          const notes = taskRow.querySelector('.notes');
          const file = taskRow.querySelector('.file');
          const upBtn = taskRow.querySelector('.up');
          const thumbs = taskRow.querySelector('.thumbs');
          const info = taskRow.querySelector('.info');
          const signBtn = taskRow.querySelector('.sign');

          chk.checked = !!t.done;
          notes.value = t.notes || '';
          (t.photo_urls||[]).forEach(url => {
            const img = document.createElement('img'); img.src = url; thumbs.appendChild(img);
          });
          if(t.signed_by){
            signBtn.textContent = `Signed ✓`;
            signBtn.disabled = true;
            info.textContent = `Signed by ${t.signed_by} at ${new Date(t.signed_at).toLocaleString()}`;
          }

          chk.addEventListener('change', async ()=>{
            await sb.from('tasks').update({ done: chk.checked }).eq('id', t.id);
            await refreshCountsForRoom(roomId);
          });
          notes.addEventListener('change', async ()=>{
            await sb.from('tasks').update({ notes: notes.value }).eq('id', t.id);
          });
          upBtn.addEventListener('click', async ()=>{
            if(!file.files?.length) return;
            const f = file.files[0];
            const path = `${currentProjectId}/${roomId}/${t.id}/${Date.now()}_${f.name}`;
            const { error: upErr } = await sb.storage.from('photos').upload(path, f, { upsert:false });
            if(upErr) return alert(upErr.message);
            const { data: pub } = sb.storage.from('photos').getPublicUrl(path);
            const url = pub.publicUrl;
            const next = [...(t.photo_urls||[]), url];
            const { error } = await sb.from('tasks').update({ photo_urls: next }).eq('id', t.id);
            if(!error){
              const img = document.createElement('img'); img.src = url; thumbs.appendChild(img);
              // also add to dashboard roll-up
              const pimg = document.createElement('img'); pimg.src = url; allPhotosWrap.prepend(pimg);
              info.textContent = `Uploaded by ${userEmail} at ${new Date().toLocaleString()}`;
            }
          });

          // sign-off this trade (all labels for this trade in room)
          signBtn.addEventListener('click', async ()=>{
            // must have all tasks done
            const tradeTasks = tasks.filter(x => x.trade === t.trade);
            const allDone = tradeTasks.every(x => x.done);
            if(!allDone) return alert('Complete all tasks in this trade before sign-off.');
            const when = new Date().toISOString();
            const { error } = await sb.from('tasks')
              .update({ signed_by: userEmail, signed_at: when })
              .eq('room_id', roomId).eq('trade', t.trade);
            if(error) return alert(error.message);
            // update UI
            tradeTasks.forEach(x=>{
              const row = roomBox.querySelector(`.trade[data-trade="${cssEscape(x.trade)}"] .task[data-label="${cssEscape(x.label)}"]`);
              if(row){
                const sbtn = row.querySelector('.sign');
                const inf = row.querySelector('.info');
                if(sbtn){ sbtn.textContent = 'Signed ✓'; sbtn.disabled = true; }
                if(inf){ inf.textContent = `Signed by ${userEmail} at ${new Date(when).toLocaleString()}`; }
              }
            });
            await refreshDashboard();
          });
        }

        await refreshCountsForRoom(roomId);
      }
      await refreshFloorTotals();
      await refreshDashboard();
    }

    function cssEscape(s){ return String(s).replace(/"/g,'&quot;'); }

    async function refreshCountsForRoom(roomId){
      const { data: rows } = await sb
        .from('tasks')
        .select('done')
        .eq('room_id', roomId);

      const done = rows?.filter(r=>r.done).length || 0;
      const total = rows?.length || 0;
      const pct = total ? Math.round((done/total)*100) : 0;

      const pill = document.getElementById(`count-${roomId}`);
      const pctEl = document.getElementById(`pct-${roomId}`);
      const bar = document.getElementById(`bar-${roomId}`);
      if(pill) pill.textContent = `${done}/${total}`;
      if(pctEl) pctEl.textContent = `${pct}%`;
      if(bar) bar.style.width = `${pct}%`;

      await refreshFloorTotals(); await refreshOverall();
    }

    async function refreshFloorTotals(){
      for(const det of roomsEl.querySelectorAll('details')){
        const floor = det.dataset.floor;
        let done = 0, total = 0;
        for(const card of det.querySelectorAll('.card')){
          const id = card.querySelector('.head .pill[id^="count-"]')?.id?.split('count-')[1];
          if(!id) continue;
          const { data: rows } = await sb.from('tasks').select('done').eq('room_id', id);
          done += rows?.filter(r=>r.done).length || 0;
          total += rows?.length || 0;
        }
        const pill = document.getElementById(`pill-${floor.replace(/\s/g,'_')}`);
        if(pill) pill.textContent = `${done}/${total}`;
      }
      await refreshOverall();
    }

    async function refreshOverall(){
      const { data: rows } = await sb
        .from('rooms')
        .select('id')
        .eq('project_id', currentProjectId);
      const ids = rows?.map(r=>r.id) || [];
      if(!ids.length){ overallBar.style.width='0%'; overallPill.textContent='0%'; return; }
      const { data: tasks } = await sb.from('tasks').select('done').in('room_id', ids);
      const done = tasks?.filter(t=>t.done).length || 0;
      const total = tasks?.length || 0;
      const pct = total ? Math.round((done/total)*100) : 0;
      overallBar.style.width = pct + '%';
      overallPill.textContent = pct + '%';
    }

    async function refreshDashboard(){
      // signoffs
      const { data: signed } = await sb
        .from('tasks')
        .select('room_id,trade,signed_by,signed_at')
        .not('signed_by','is',null)
        .order('signed_at', { ascending:false })
        .limit(200);

      signoffsWrap.innerHTML = '';
      for(const s of signed || []){
        // room name
        const { data: r } = await sb.from('rooms').select('room_name,floor_name').eq('id', s.room_id).single();
        const div = document.createElement('div');
        div.className = 'row';
        div.style.borderBottom = '1px solid var(--hr)';
        div.style.padding = '.4rem 0';
        div.innerHTML = `
          <span class="pill">${r?.floor_name || ''} / ${r?.room_name || ''}</span>
          <span class="pill" style="margin-left:.5rem">${s.trade}</span>
          <span class="muted" style="margin-left:.5rem">Signed by ${s.signed_by} at ${new Date(s.signed_at).toLocaleString()}</span>
        `;
        signoffsWrap.appendChild(div);
      }

      // photos roll-up done dynamically when uploads occur; could also reload all here:
      // const { data: t2 } = await sb.from('tasks').select('photo_urls');
      // allPhotosWrap.innerHTML = '';
      // (t2||[]).flatMap(t=>t.photo_urls||[]).forEach(url=>{ const img=new Image(); img.src=url; allPhotosWrap.appendChild(img); });
    }

  })();
  </script>
</body>
</html>
