<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MPJ Tracker – Auth Fix</title>
  <meta name="theme-color" content="#0b5f3b"/>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{ --brand:#0b5f3b; --text:#111827; --card:#fff; --muted:#6b7280; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f8fafb;color:var(--text)}
    header{position:sticky;top:0;background:var(--brand);color:#fff}
    .bar{max-width:900px;margin:0 auto;display:flex;gap:.75rem;align-items:center;padding:.6rem .9rem}
    .pill{margin-left:auto;background:rgba(255,255,255,.15);padding:.35rem .6rem;border-radius:999px;font-weight:600}
    main{max-width:900px;margin:1rem auto;padding:0 .9rem}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:.75rem 0}
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .btn{border:none;background:#e8eef0;padding:.55rem .85rem;border-radius:9px;cursor:pointer}
    .btn.accent{background:#fff;color:var(--brand);border:1px solid var(--brand);font-weight:600}
    .input{padding:.6rem .7rem;border-radius:9px;border:1px solid #e5e7eb;background:#fff}
    .muted{color:var(--muted)}
    .ok{color:#066e2b} .bad{color:#b00020}
    code{background:#f3f4f6;padding:.15rem .3rem;border-radius:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>MPJ Tracker</strong>
      <div id="auth-state" class="pill">Signed out</div>
    </div>
  </header>

  <main>
    <!-- Connectivity panel -->
    <div class="card">
      <h3 style="margin:.2rem 0">Connection status</h3>
      <div id="conn" class="muted">Checking…</div>
      <div id="conn-tip" class="muted" style="margin-top:.5rem">
        If this shows a red error, add your Netlify URL to
        <em>Supabase → Authentication → URL Configuration → Additional Redirect URLs</em>:
        <code>https://preeminent-nougat-c65e89.netlify.app</code>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth-box" class="card">
      <h2>Login / Sign Up</h2>
      <p class="muted">Use your email + password. (No page freeze; clear errors shown here.)</p>
      <div class="row">
        <input id="email" class="input" placeholder="Enter your email" style="min-width:240px"/>
        <input id="password" class="input" placeholder="Enter your password" type="password" style="min-width:180px"/>
        <button id="signup-btn" class="btn">Sign Up</button>
        <button id="login-btn" class="btn">Log In</button>
        <button id="logout-btn" class="btn">Sign out</button>
      </div>
      <div id="auth-msg" class="muted" style="margin-top:.5rem"></div>
    </div>

    <!-- App shell (only shows once signed in) -->
    <div id="app" class="card hidden">
      <h2>Welcome</h2>
      <p>You are signed in. From here you can load your existing full app UI.</p>
      <div class="row">
        <button id="go-btn" class="btn accent">Show Project UI</button>
      </div>
      <div id="app-msg" class="muted" style="margin-top:.5rem"></div>
    </div>
  </main>

  <script>
  // ====== 1) Supabase client (use your exact URL/key; no trailing slash) ======
  const SUPABASE_URL = "https://zpnqruthpknncpiiztxf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbnFydXRocGtubmNwaWl6dHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjM4NzQsImV4cCI6MjA3NDAzOTg3NH0.-9ReQMcI2izlwEP72ya6KXqnIgmBnH5b_wMRtwcFp-4";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true // safe for email link flows; harmless otherwise
    },
    global: { fetch: (url, opts) => fetch(url, { ...opts, cache: 'no-store' }) }
  });

  // ====== 2) DOM refs ======
  const authStateEl = document.getElementById('auth-state');
  const connEl = document.getElementById('conn');
  const authBox = document.getElementById('auth-box');
  const appBox = document.getElementById('app');
  const authMsg = document.getElementById('auth-msg');
  const appMsg = document.getElementById('app-msg');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const goBtn = document.getElementById('go-btn');

  const showAuth = () => { authBox.classList.remove('hidden'); appBox.classList.add('hidden'); };
  const showApp = () => { authBox.classList.add('hidden'); appBox.classList.remove('hidden'); };

  const showNetError = (where, err) => {
    console.error(`[${where}]`, err);
    const msg = (err && (err.message || err.error_description)) || String(err);
    alert(`${where}: ${msg}`);
  };

  // ====== 3) Live connectivity check (CORS/network) ======
  (async () => {
    try {
      const u = new URL('/auth/v1/health', SUPABASE_URL).href;
      const r = await fetch(u, { mode:'cors' });
      if (!r.ok) {
        connEl.innerHTML = `<span class="bad">Auth health: ${r.status} ${r.statusText}</span>`;
      } else {
        connEl.innerHTML = `<span class="ok">Auth health: OK (${r.status})</span>`;
      }
    } catch (e) {
      connEl.innerHTML = `<span class="bad">Network/CORS blocked: ${(e && e.message) || e}</span>`;
      console.error('[health]', e);
    }
  })();

  // ====== 4) Auth handlers (no freeze, clear errors) ======
  signupBtn.addEventListener('click', async () => {
    const email = (emailInput.value || '').trim();
    const pw = passwordInput.value || '';
    if (!email || !pw) return alert('Please enter email and password');

    signupBtn.disabled = true; authMsg.textContent = 'Signing up…';
    try {
      const { data, error } = await sb.auth.signUp({ email, password: pw });
      if (error) return showNetError('Sign up error', error);
      authMsg.textContent = 'Sign up OK. If confirmation is enabled, check your email.';
    } catch (e) {
      showNetError('Sign up error (network)', e);
    } finally {
      signupBtn.disabled = false;
    }
  });

  loginBtn.addEventListener('click', async () => {
    const email = (emailInput.value || '').trim();
    const pw = passwordInput.value || '';
    if (!email || !pw) return alert('Please enter email and password');

    loginBtn.disabled = true; authMsg.textContent = 'Logging in…';
    try {
      console.log('Using Supabase URL:', SUPABASE_URL);
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
      if (error) return showNetError('Login error', error);
      authMsg.textContent = 'Login OK.';
      // UI switches by onAuthStateChange
    } catch (e) {
      showNetError('Login error (network)', e);
    } finally {
      loginBtn.disabled = false;
    }
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      await sb.auth.signOut();
      authMsg.textContent = 'Signed out.';
    } catch (e) {
      showNetError('Sign out error', e);
    }
  });

  // Keep UI in sync with auth
  sb.auth.onAuthStateChange(async (_evt, session) => {
    const user = session?.user || null;
    authStateEl.textContent = user ? `Signed in: ${user.email || user.id}` : 'Signed out';
    if (user) showApp(); else showAuth();
  });

  // Initial session on load (one-time login experience)
  (async () => {
    try {
      const { data } = await sb.auth.getSession();
      const user = data.session?.user || null;
      authStateEl.textContent = user ? `Signed in: ${user.email || user.id}` : 'Signed out';
      if (user) showApp(); else showAuth();
    } catch (e) {
      console.warn('Initial session check failed', e);
      showAuth();
    }
  })();

  // Placeholder to load your full app UI once signed in
  goBtn.addEventListener('click', () => {
    appMsg.textContent = 'You are authenticated. Load/render your full dashboard here.';
    // e.g. call renderFloors(currentProjectId) etc.
  });
  </script>
</body>
</html>
